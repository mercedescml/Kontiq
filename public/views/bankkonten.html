<style>
    .bankkonten-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--navy);
        margin: 0 0 8px 0;
    }

    .page-subtitle {
        color: var(--gray);
        font-size: 14px;
        margin: 0;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--navy);
        margin: 0;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: var(--teal);
        color: white;
    }

    .btn-primary:hover {
        background: #059669;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: var(--navy);
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    .accounts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 16px;
    }

    .account-card {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--light-gray);
        padding: 20px;
        transition: all 0.2s;
    }

    .account-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .account-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }

    .account-bank {
        font-size: 16px;
        font-weight: 600;
        color: var(--navy);
        margin: 0 0 4px 0;
    }

    .account-iban {
        font-size: 13px;
        color: var(--gray);
        font-family: 'Roboto Mono', monospace;
    }

    .account-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
    }

    .account-badge.primary {
        background: rgba(14, 177, 122, 0.1);
        color: #059669;
    }

    .account-badge.secondary {
        background: #f3f4f6;
        color: #6b7280;
    }

    .account-entity {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: #f8fafc;
        border-radius: 8px;
        margin-bottom: 12px;
    }

    .account-entity-icon {
        font-size: 16px;
    }

    .account-entity-info {
        flex: 1;
    }

    .account-entity-label {
        font-size: 11px;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .account-entity-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--navy);
    }

    .account-balance {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        border-top: 1px solid var(--light-gray);
    }

    .balance-label {
        font-size: 12px;
        color: var(--gray);
    }

    .balance-amount {
        font-size: 18px;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--navy);
    }

    .balance-amount.positive {
        color: #059669;
    }

    .account-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }

    /* Transactions View */
    .transactions-view {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-top: 24px;
        border: 1px solid var(--light-gray);
    }

    .transactions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--light-gray);
    }

    .transactions-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--navy);
    }

    .transaction-filters {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .transaction-item {
        display: grid;
        grid-template-columns: 80px 1fr 150px 150px auto;
        gap: 16px;
        padding: 16px;
        border-bottom: 1px solid #f3f4f6;
        align-items: center;
        transition: background 0.2s;
    }

    .transaction-item:hover {
        background: #f9fafb;
    }

    .transaction-item.debit {
        border-left: 3px solid var(--error);
    }

    .transaction-item.credit {
        border-left: 3px solid var(--teal);
    }

    .transaction-date {
        font-size: 11px;
        color: var(--gray);
        text-transform: uppercase;
        font-weight: 600;
    }

    .transaction-description {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .transaction-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--navy);
    }

    .transaction-reference {
        font-size: 12px;
        color: var(--gray);
        font-family: 'Roboto Mono', monospace;
    }

    .transaction-category {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 4px;
        background: var(--light-gray);
        color: var(--gray);
        width: fit-content;
    }

    .transaction-amount {
        font-size: 16px;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
    }

    .transaction-amount.debit {
        color: var(--error);
    }

    .transaction-amount.credit {
        color: var(--teal);
    }

    .transaction-status {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-align: center;
    }

    .status-badge.assigned {
        background: rgba(14, 177, 122, 0.1);
        color: var(--teal);
    }

    .status-badge.unassigned {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .transaction-actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 6px 12px;
        font-size: 11px;
        border-radius: 6px;
        border: 1px solid var(--border-gray);
        background: white;
        color: var(--navy);
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .btn-action:hover {
        background: var(--light-gray);
        border-color: var(--navy);
    }

    .btn-action.primary {
        background: var(--teal);
        color: white;
        border-color: var(--teal);
    }

    .btn-action.primary:hover {
        background: #059669;
    }

    /* Assignment Modal */
    .assignment-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        padding: 0;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        width: 600px;
        max-width: 90vw;
        max-height: 80vh;
        z-index: 1000001;
        display: none;
        overflow: hidden;
    }

    .assignment-modal.active {
        display: block;
    }

    .assignment-modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--light-gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .assignment-modal-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--navy);
    }

    .assignment-modal-body {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .transaction-info-box {
        background: var(--light-gray);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }

    .assignment-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .assignment-option {
        border: 2px solid var(--border-gray);
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .assignment-option:hover {
        border-color: var(--teal);
        background: rgba(14, 177, 122, 0.05);
    }

    .assignment-option.selected {
        border-color: var(--teal);
        background: rgba(14, 177, 122, 0.1);
    }

    .option-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }

    .option-icon {
        font-size: 24px;
    }

    .option-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--navy);
    }

    .option-description {
        font-size: 12px;
        color: var(--gray);
        margin-left: 36px;
    }

    .search-list {
        margin-top: 16px;
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
    }

    .search-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background 0.2s;
    }

    .search-item:last-child {
        border-bottom: none;
    }

    .search-item:hover {
        background: #f9fafb;
    }

    .search-item.selected {
        background: rgba(14, 177, 122, 0.1);
    }

    /* Modal Overlay */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000000;
        display: none;
    }

    .modal-overlay.active {
        display: block;
    }

    /* Bank Account Modal */
    .bank-modal-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: rgba(0,0,0,0.5) !important;
        z-index: 999999 !important;
        display: none;
    }

    .bank-modal-overlay.active {
        display: block !important;
    }

    .bank-modal {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        background: #ffffff !important;
        padding: 24px !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
        width: 450px !important;
        max-width: 90vw !important;
        z-index: 1000000 !important;
        display: none;
    }

    .bank-modal.active {
        display: block !important;
    }

    .bank-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
    }

    .bank-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #0A2540;
        margin: 0;
    }

    .bank-modal-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
    }

    .bank-form-group {
        margin-bottom: 16px;
    }

    .bank-form-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #0A2540;
        margin-bottom: 6px;
    }

    .bank-form-input,
    .bank-form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        box-sizing: border-box;
    }

    .bank-form-input:focus,
    .bank-form-select:focus {
        outline: none;
        border-color: #0EB17A;
        box-shadow: 0 0 0 2px rgba(14, 177, 122, 0.1);
    }

    .bank-modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
    }

    .entity-checkbox-list {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
    }

    .entity-checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .entity-checkbox-item:hover {
        background: #f3f4f6;
    }

    .entity-checkbox-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #0EB17A;
    }

    .entity-checkbox-item label {
        font-size: 13px;
        color: #0A2540;
        cursor: pointer;
        flex: 1;
    }

    .entity-checkbox-item .entity-type {
        font-size: 11px;
        color: #6b7280;
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 4px;
    }

    .all-entities-option {
        padding: 10px 12px;
        background: rgba(14, 177, 122, 0.08);
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }

    .all-entities-option:hover {
        background: rgba(14, 177, 122, 0.15);
    }

    .all-entities-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #0EB17A;
    }

    .all-entities-option label {
        font-size: 13px;
        font-weight: 600;
        color: #0A2540;
        cursor: pointer;
    }

    .empty-state {
        text-align: center;
        padding: 48px 24px;
        background: #f8fafc;
        border-radius: 12px;
        border: 2px dashed #e5e7eb;
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }

    .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--navy);
        margin: 0 0 8px 0;
    }

    .empty-state p {
        font-size: 14px;
        color: var(--gray);
        margin: 0;
    }
</style>

<div class="bankkonten-container">
    <div class="page-header">
        <h1 class="page-title">Bankkonten</h1>
        <p class="page-subtitle">Verwalten Sie Ihre Gesch√§ftskonten und ordnen Sie Transaktionen zu</p>
    </div>

    <div class="section-header">
        <h2 class="section-title">Ihre Konten</h2>
        <button class="btn btn-primary" onclick="openBankModal()">
            + Konto hinzuf√ºgen
        </button>
    </div>

    <div class="accounts-grid bankkonten-grid" id="accountsGrid" data-bankkonten-container></div>

    <!-- Transactions View -->
    <div class="transactions-view" id="transactionsView" style="display: none;">
        <div class="transactions-header">
            <div>
                <h3 class="transactions-title" id="transactionsAccountName"></h3>
                <p style="font-size: 13px; color: var(--gray); margin-top: 4px;">Aktuelle Transaktionen & Zuordnung</p>
            </div>
            <div class="transaction-filters">
                <select style="padding: 8px 12px; border: 1px solid var(--border-gray); border-radius: 6px; font-size: 13px;">
                    <option>Alle Transaktionen</option>
                    <option>Nicht zugeordnet</option>
                    <option>Zugeordnet</option>
                    <option>Einnahmen</option>
                    <option>Ausgaben</option>
                </select>
                <button class="btn btn-secondary btn-sm" onclick="closeTransactions()">Zur√ºck</button>
            </div>
        </div>
        <div id="transactionsList"></div>
    </div>
</div>

<!-- Bank Account Modal -->
<div class="bank-modal-overlay" id="bankOverlay" onclick="closeBankModal()"></div>
<div class="bank-modal" id="bankModal">
    <div class="bank-modal-header">
        <h3 class="bank-modal-title" id="bankModalTitle">Neues Konto</h3>
        <button class="bank-modal-close" onclick="closeBankModal()">‚úï</button>
    </div>
    <form onsubmit="saveAccount(event)">
        <input type="hidden" id="accountId">

        <div class="bank-form-group">
            <label class="bank-form-label">Bank</label>
            <input type="text" class="bank-form-input" id="accountBank" placeholder="z.B. Sparkasse, N26, Commerzbank" required>
        </div>

        <div class="bank-form-group">
            <label class="bank-form-label">IBAN</label>
            <input type="text" class="bank-form-input" id="accountIban" placeholder="DE00 0000 0000 0000 0000 00" required>
        </div>

        <div class="bank-form-group">
            <label class="bank-form-label">Kontostand (‚Ç¨)</label>
            <input type="number" class="bank-form-input" id="accountBalance" placeholder="0.00" step="0.01">
        </div>

        <div class="bank-form-group">
            <label class="bank-form-label">Typ</label>
            <select class="bank-form-select" id="accountType">
                <option value="primary">Hauptkonto</option>
                <option value="secondary">Sekund√§r</option>
                <option value="savings">Sparkonto</option>
            </select>
        </div>

        <div class="bank-form-group">
            <label class="bank-form-label">Zuordnung zu Entit√§ten</label>
            <div class="all-entities-option">
                <input type="checkbox" id="allEntities" onchange="toggleAllEntities()">
                <label for="allEntities">üåê Alle Entit√§ten (Gesamtunternehmen)</label>
            </div>
            <div class="entity-checkbox-list" id="entityCheckboxList"></div>
        </div>

        <div class="bank-modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeBankModal()">Abbrechen</button>
            <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
    </form>
</div>

<!-- Assignment Modal -->
<div class="modal-overlay" id="assignmentOverlay" onclick="closeAssignmentModal()"></div>
<div class="assignment-modal" id="assignmentModal">
    <div class="assignment-modal-header">
        <h3 class="assignment-modal-title">Transaktion zuordnen</h3>
        <button class="bank-modal-close" onclick="closeAssignmentModal()">‚úï</button>
    </div>
    <div class="assignment-modal-body">
        <div class="transaction-info-box" id="assignmentTransactionInfo"></div>

        <div class="assignment-options">
            <div class="assignment-option" onclick="selectAssignmentType('existing-zahlung')">
                <div class="option-header">
                    <span class="option-icon">üí∞</span>
                    <span class="option-title">Zu bestehender Zahlung zuordnen</span>
                </div>
                <p class="option-description">Diese Transaktion einer bereits erfassten Zahlung zuordnen</p>
            </div>

            <div class="assignment-option" onclick="selectAssignmentType('new-zahlung')">
                <div class="option-header">
                    <span class="option-icon">‚ûï</span>
                    <span class="option-title">Als neue Zahlung erfassen</span>
                </div>
                <p class="option-description">Neue Zahlung basierend auf dieser Transaktion erstellen</p>
            </div>

            <div class="assignment-option" onclick="selectAssignmentType('existing-forderung')">
                <div class="option-header">
                    <span class="option-icon">üìÑ</span>
                    <span class="option-title">Zu bestehender Forderung zuordnen</span>
                </div>
                <p class="option-description">Diese Transaktion einer offenen Forderung zuordnen</p>
            </div>

            <div class="assignment-option" onclick="selectAssignmentType('new-forderung')">
                <div class="option-header">
                    <span class="option-icon">‚ú®</span>
                    <span class="option-title">Als neue Forderung erfassen</span>
                </div>
                <p class="option-description">Neue Forderung basierend auf dieser Transaktion erstellen</p>
            </div>
        </div>

        <div id="assignmentSearchArea" style="display: none; margin-top: 20px;">
            <input type="text" id="assignmentSearch" placeholder="Suchen..." style="width: 100%; padding: 12px; border: 1px solid var(--border-gray); border-radius: 8px; font-size: 14px;">
            <div class="search-list" id="assignmentSearchList"></div>
        </div>

        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--light-gray); display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeAssignmentModal()">Abbrechen</button>
            <button class="btn btn-primary" onclick="saveAssignment()" id="saveAssignmentBtn" style="display: none;">Zuordnen</button>
        </div>
    </div>
</div>

<script src="/data/forderungen.json"></script>
<script src="/data/zahlungen.json"></script>
<script>
    let accounts = JSON.parse(localStorage.getItem('kontiq_accounts') || '[]');
    let entities = JSON.parse(localStorage.getItem('kontiq_entities') || '[]');
    let transactions = JSON.parse(localStorage.getItem('kontiq_transactions') || '[]');
    let currentAccountId = null;
    let currentTransaction = null;
    let selectedAssignmentType = null;
    let selectedAssignmentId = null;

    // Initialize with default accounts if none exist
    if (accounts.length === 0) {
        accounts = [
            {
                id: '1',
                bank: 'Sparkasse',
                iban: 'DE12 3456 7890 1234 5678 90',
                balance: 45230.50,
                type: 'primary',
                entityIds: ['all'],
                createdAt: new Date().toISOString()
            },
            {
                id: '2',
                bank: 'N26 Business',
                iban: 'DE98 7654 3210 9876 5432 10',
                balance: 12450.00,
                type: 'secondary',
                entityIds: ['1'],
                createdAt: new Date().toISOString()
            }
        ];
        localStorage.setItem('kontiq_accounts', JSON.stringify(accounts));
    }

    // Initialize transactions if none exist
    if (transactions.length === 0) {
        transactions = [
            {
                id: 't1',
                accountId: '1',
                date: '2025-01-18',
                description: 'Firma ABC GmbH - Rechnung RE-2025-001',
                reference: 'WIRE-20250118-0001',
                amount: 4850.00,
                type: 'credit',
                category: 'Kundeneinzahlung',
                status: 'unassigned',
                assignedTo: null,
                assignedType: null
            },
            {
                id: 't2',
                accountId: '1',
                date: '2025-01-17',
                description: 'Deutsche Telekom AG',
                reference: 'DD-20250117-TELEKOM',
                amount: -89.95,
                type: 'debit',
                category: 'Telekommunikation',
                status: 'unassigned',
                assignedTo: null,
                assignedType: null
            },
            {
                id: 't3',
                accountId: '1',
                date: '2025-01-16',
                description: 'AWS EMEA SARL',
                reference: 'DD-20250116-AWS',
                amount: -245.80,
                type: 'debit',
                category: 'IT & Software',
                status: 'unassigned',
                assignedTo: null,
                assignedType: null
            },
            {
                id: 't4',
                accountId: '1',
                date: '2025-01-15',
                description: 'XYZ Consulting - Projektabrechnung',
                reference: 'WIRE-20250115-0002',
                amount: 8500.00,
                type: 'credit',
                category: 'Dienstleistungseinnahmen',
                status: 'unassigned',
                assignedTo: null,
                assignedType: null
            },
            {
                id: 't5',
                accountId: '1',
                date: '2025-01-14',
                description: 'Office Depot Deutschland GmbH',
                reference: 'DD-20250114-OFFICE',
                amount: -342.50,
                type: 'debit',
                category: 'B√ºromaterial',
                status: 'unassigned',
                assignedTo: null,
                assignedType: null
            },
            {
                id: 't6',
                accountId: '2',
                date: '2025-01-17',
                description: 'Google Cloud EMEA',
                reference: 'DD-20250117-GOOGLE',
                amount: -156.20,
                type: 'debit',
                category: 'IT & Software',
                status: 'unassigned',
                assignedTo: null,
                assignedType: null
            }
        ];
        localStorage.setItem('kontiq_transactions', JSON.stringify(transactions));
    }

    function getEntityName(entityId) {
        if (entityId === 'all') return 'Alle Entit√§ten';
        const entity = entities.find(e => e.id === entityId);
        return entity ? entity.name : 'Unbekannt';
    }

    function getEntityIcon(entityId) {
        if (entityId === 'all') return 'üåê';
        const entity = entities.find(e => e.id === entityId);
        if (!entity) return 'üè¢';
        return entity.category === 'abteilung' ? 'üè¢' : 'üìç';
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('de-DE', {
            style: 'currency',
            currency: 'EUR'
        }).format(value);
    }

    function formatIban(iban) {
        return iban.replace(/(.{4})/g, '$1 ').trim();
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function renderAccounts() {
        const grid = document.getElementById('accountsGrid');

        if (accounts.length === 0) {
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <div class="empty-state-icon">üè¶</div>
                    <h3>Keine Konten vorhanden</h3>
                    <p>F√ºgen Sie Ihr erstes Bankkonto hinzu</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = accounts.map(account => {
            const accountTransactions = transactions.filter(t => t.accountId === account.id);
            const unassignedCount = accountTransactions.filter(t => t.status === 'unassigned').length;

            const isAllEntities = account.entityIds.includes('all');
            const entityDisplay = isAllEntities
                ? { icon: 'üåê', name: 'Alle Entit√§ten', label: 'Gesamtunternehmen' }
                : {
                    icon: getEntityIcon(account.entityIds[0]),
                    name: account.entityIds.length > 1
                        ? `${getEntityName(account.entityIds[0])} +${account.entityIds.length - 1}`
                        : getEntityName(account.entityIds[0]),
                    label: account.entityIds.length > 1 ? 'Mehrere Entit√§ten' : 'Zugeordnet'
                };

            return `
                <div class="account-card">
                    <div class="account-header">
                        <div>
                            <h3 class="account-bank">${account.bank}</h3>
                            <div class="account-iban">${formatIban(account.iban)}</div>
                        </div>
                        <span class="account-badge ${account.type}">${
                            account.type === 'primary' ? 'Hauptkonto' :
                            account.type === 'savings' ? 'Sparkonto' : 'Sekund√§r'
                        }</span>
                    </div>

                    <div class="account-entity">
                        <span class="account-entity-icon">${entityDisplay.icon}</span>
                        <div class="account-entity-info">
                            <div class="account-entity-label">${entityDisplay.label}</div>
                            <div class="account-entity-name">${entityDisplay.name}</div>
                        </div>
                    </div>

                    <div class="account-balance">
                        <span class="balance-label">Aktueller Kontostand</span>
                        <span class="balance-amount ${account.balance >= 0 ? 'positive' : ''}">${formatCurrency(account.balance)}</span>
                    </div>

                    ${unassignedCount > 0 ? `
                        <div style="margin-top: 12px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 3px solid var(--warning);">
                            <div style="font-size: 12px; font-weight: 600; color: var(--warning);">
                                ${unassignedCount} nicht zugeordnete Transaktion${unassignedCount > 1 ? 'en' : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div class="account-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewTransactions('${account.id}')">
                            üìä Transaktionen (${accountTransactions.length})
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="editAccount('${account.id}')">Bearbeiten</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function viewTransactions(accountId) {
        currentAccountId = accountId;
        const account = accounts.find(a => a.id === accountId);
        const accountTransactions = transactions.filter(t => t.accountId === accountId);

        document.getElementById('accountsGrid').style.display = 'none';
        document.querySelector('.section-header').style.display = 'none';
        document.getElementById('transactionsView').style.display = 'block';
        document.getElementById('transactionsAccountName').textContent = `${account.bank} - Transaktionen`;

        renderTransactions(accountTransactions);
    }

    function closeTransactions() {
        document.getElementById('accountsGrid').style.display = 'grid';
        document.querySelector('.section-header').style.display = 'flex';
        document.getElementById('transactionsView').style.display = 'none';
        currentAccountId = null;
    }

    function renderTransactions(transactionsList) {
        const container = document.getElementById('transactionsList');

        if (transactionsList.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üí≥</div>
                    <h3>Keine Transaktionen</h3>
                    <p>Es wurden noch keine Transaktionen f√ºr dieses Konto erfasst</p>
                </div>
            `;
            return;
        }

        container.innerHTML = transactionsList.map(transaction => `
            <div class="transaction-item ${transaction.type}">
                <div>
                    <div class="transaction-date">${formatDate(transaction.date)}</div>
                </div>

                <div class="transaction-description">
                    <div class="transaction-title">${transaction.description}</div>
                    <div class="transaction-reference">${transaction.reference}</div>
                    <div class="transaction-category">${transaction.category}</div>
                </div>

                <div class="transaction-amount ${transaction.type}">
                    ${transaction.type === 'debit' ? '-' : '+'}${formatCurrency(Math.abs(transaction.amount))}
                </div>

                <div class="transaction-status">
                    <span class="status-badge ${transaction.status}">
                        ${transaction.status === 'assigned' ? '‚úì Zugeordnet' : '‚ö† Nicht zugeordnet'}
                    </span>
                    ${transaction.status === 'assigned' ? `
                        <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">
                            ${transaction.assignedType === 'zahlung' ? 'üí∞ Zahlung' : 'üìÑ Forderung'}
                        </div>
                    ` : ''}
                </div>

                <div class="transaction-actions">
                    ${transaction.status === 'unassigned' ? `
                        <button class="btn-action primary" onclick="openAssignmentModal('${transaction.id}')">
                            Zuordnen
                        </button>
                    ` : `
                        <button class="btn-action" onclick="viewAssignment('${transaction.id}')">
                            Details
                        </button>
                        <button class="btn-action" onclick="removeAssignment('${transaction.id}')">
                            Entfernen
                        </button>
                    `}
                </div>
            </div>
        `).join('');
    }

    function openAssignmentModal(transactionId) {
        currentTransaction = transactions.find(t => t.id === transactionId);
        if (!currentTransaction) return;

        const modal = document.getElementById('assignmentModal');
        const overlay = document.getElementById('assignmentOverlay');

        document.getElementById('assignmentTransactionInfo').innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div>
                    <div style="font-size: 14px; font-weight: 700; color: var(--navy);">${currentTransaction.description}</div>
                    <div style="font-size: 12px; color: var(--gray); margin-top: 2px;">${currentTransaction.reference}</div>
                </div>
                <div style="font-size: 18px; font-weight: 700; font-family: 'Roboto Mono', monospace; color: ${currentTransaction.type === 'credit' ? 'var(--teal)' : 'var(--error)'};">
                    ${currentTransaction.type === 'debit' ? '-' : '+'}${formatCurrency(Math.abs(currentTransaction.amount))}
                </div>
            </div>
            <div style="font-size: 12px; color: var(--gray);">
                <strong>Datum:</strong> ${formatDate(currentTransaction.date)} |
                <strong>Kategorie:</strong> ${currentTransaction.category}
            </div>
        `;

        overlay.classList.add('active');
        modal.classList.add('active');
    }

    function closeAssignmentModal() {
        document.getElementById('assignmentOverlay').classList.remove('active');
        document.getElementById('assignmentModal').classList.remove('active');
        document.getElementById('assignmentSearchArea').style.display = 'none';
        document.getElementById('saveAssignmentBtn').style.display = 'none';
        selectedAssignmentType = null;
        selectedAssignmentId = null;
        currentTransaction = null;
    }

    async function selectAssignmentType(type) {
        selectedAssignmentType = type;
        const searchArea = document.getElementById('assignmentSearchArea');
        const saveBtn = document.getElementById('saveAssignmentBtn');

        document.querySelectorAll('.assignment-option').forEach(opt => opt.classList.remove('selected'));
        event.target.closest('.assignment-option').classList.add('selected');

        if (type === 'existing-zahlung' || type === 'existing-forderung') {
            searchArea.style.display = 'block';
            saveBtn.style.display = 'inline-flex';

            // Load data
            if (type === 'existing-zahlung') {
                try {
                    const response = await fetch('/api/zahlungen');
                    const data = await response.json();
                    renderSearchList(data.zahlungen || data, 'zahlung');
                } catch (error) {
                    console.error('Error loading Zahlungen:', error);
                    document.getElementById('assignmentSearchList').innerHTML = '<p style="padding: 16px; text-align: center; color: var(--gray);">Fehler beim Laden der Zahlungen</p>';
                }
            } else {
                try {
                    const response = await fetch('/api/forderungen');
                    const data = await response.json();
                    renderSearchList(data.forderungen || data, 'forderung');
                } catch (error) {
                    console.error('Error loading Forderungen:', error);
                    document.getElementById('assignmentSearchList').innerHTML = '<p style="padding: 16px; text-align: center; color: var(--gray);">Fehler beim Laden der Forderungen</p>';
                }
            }
        } else if (type === 'new-zahlung') {
            // Create new Zahlung
            window.location.href = '#zahlungen';
            closeAssignmentModal();
        } else if (type === 'new-forderung') {
            // Create new Forderung
            window.location.href = '#forderungen';
            closeAssignmentModal();
        }
    }

    function renderSearchList(items, itemType) {
        const list = document.getElementById('assignmentSearchList');

        if (!items || items.length === 0) {
            list.innerHTML = `<p style="padding: 16px; text-align: center; color: var(--gray);">Keine ${itemType === 'zahlung' ? 'Zahlungen' : 'Forderungen'} gefunden</p>`;
            return;
        }

        list.innerHTML = items.map(item => {
            const displayName = itemType === 'zahlung'
                ? `${item.supplier || item.recipient || 'Unbekannt'} - ${formatCurrency(item.amount || item.brutto_betrag || 0)}`
                : `${item.client_name || 'Unbekannt'} - ${item.invoice_number || ''} - ${formatCurrency(item.amount || item.brutto_betrag || 0)}`;

            return `
                <div class="search-item" onclick="selectSearchItem('${item.id}', '${itemType}')">
                    <div style="font-size: 14px; font-weight: 600; color: var(--navy); margin-bottom: 4px;">${displayName}</div>
                    <div style="font-size: 12px; color: var(--gray);">
                        ${itemType === 'zahlung' ? `F√§lligkeit: ${item.due_date || item.date || '-'}` : `Rechnung vom: ${item.invoice_date || '-'}`}
                    </div>
                </div>
            `;
        }).join('');
    }

    function selectSearchItem(itemId, itemType) {
        selectedAssignmentId = itemId;
        document.querySelectorAll('.search-item').forEach(item => item.classList.remove('selected'));
        event.target.closest('.search-item').classList.add('selected');
    }

    function saveAssignment() {
        if (!selectedAssignmentId || !currentTransaction) {
            alert('Bitte w√§hlen Sie eine Zuordnung aus');
            return;
        }

        currentTransaction.status = 'assigned';
        currentTransaction.assignedTo = selectedAssignmentId;
        currentTransaction.assignedType = selectedAssignmentType.includes('zahlung') ? 'zahlung' : 'forderung';

        const index = transactions.findIndex(t => t.id === currentTransaction.id);
        transactions[index] = currentTransaction;
        localStorage.setItem('kontiq_transactions', JSON.stringify(transactions));

        closeAssignmentModal();
        viewTransactions(currentAccountId);
        renderAccounts();
    }

    function removeAssignment(transactionId) {
        const transaction = transactions.find(t => t.id === transactionId);
        if (!transaction) return;

        if (confirm('M√∂chten Sie die Zuordnung wirklich entfernen?')) {
            transaction.status = 'unassigned';
            transaction.assignedTo = null;
            transaction.assignedType = null;

            const index = transactions.findIndex(t => t.id === transactionId);
            transactions[index] = transaction;
            localStorage.setItem('kontiq_transactions', JSON.stringify(transactions));

            viewTransactions(currentAccountId);
            renderAccounts();
        }
    }

    function viewAssignment(transactionId) {
        const transaction = transactions.find(t => t.id === transactionId);
        if (!transaction || transaction.status !== 'assigned') return;

        if (transaction.assignedType === 'zahlung') {
            window.location.href = '#zahlungen';
        } else {
            window.location.href = '#forderungen';
        }
    }

    function renderEntityCheckboxes() {
        const container = document.getElementById('entityCheckboxList');

        if (entities.length === 0) {
            container.innerHTML = '<p style="color:#6b7280;font-size:12px;text-align:center;padding:12px;">Keine Entit√§ten vorhanden</p>';
            return;
        }

        container.innerHTML = entities.map(entity => `
            <div class="entity-checkbox-item">
                <input type="checkbox" id="entity_${entity.id}" value="${entity.id}" class="entity-checkbox">
                <label for="entity_${entity.id}">${entity.name}</label>
                <span class="entity-type">${entity.category === 'abteilung' ? 'Abteilung' : 'Standort'}</span>
            </div>
        `).join('');
    }

    function toggleAllEntities() {
        const allChecked = document.getElementById('allEntities').checked;
        document.querySelectorAll('.entity-checkbox').forEach(cb => {
            cb.checked = false;
            cb.disabled = allChecked;
        });
    }

    function openBankModal(id = null) {
        const modal = document.getElementById('bankModal');
        const overlay = document.getElementById('bankOverlay');
        const title = document.getElementById('bankModalTitle');

        renderEntityCheckboxes();

        if (id) {
            const account = accounts.find(a => a.id === id);
            title.textContent = 'Konto bearbeiten';
            document.getElementById('accountId').value = account.id;
            document.getElementById('accountBank').value = account.bank;
            document.getElementById('accountIban').value = account.iban;
            document.getElementById('accountBalance').value = account.balance;
            document.getElementById('accountType').value = account.type;

            const isAllEntities = account.entityIds.includes('all');
            document.getElementById('allEntities').checked = isAllEntities;
            toggleAllEntities();

            if (!isAllEntities) {
                account.entityIds.forEach(entityId => {
                    const cb = document.getElementById(`entity_${entityId}`);
                    if (cb) cb.checked = true;
                });
            }
        } else {
            title.textContent = 'Neues Konto';
            document.getElementById('accountId').value = '';
            document.querySelector('form').reset();
            document.getElementById('allEntities').checked = true;
            toggleAllEntities();
        }

        overlay.classList.add('active');
        modal.classList.add('active');
    }

    function closeBankModal() {
        document.getElementById('bankOverlay').classList.remove('active');
        document.getElementById('bankModal').classList.remove('active');
    }

    function saveAccount(event) {
        event.preventDefault();

        const id = document.getElementById('accountId').value;
        const isAllEntities = document.getElementById('allEntities').checked;

        let entityIds = [];
        if (isAllEntities) {
            entityIds = ['all'];
        } else {
            document.querySelectorAll('.entity-checkbox:checked').forEach(cb => {
                entityIds.push(cb.value);
            });
            if (entityIds.length === 0) {
                alert('Bitte w√§hlen Sie mindestens eine Entit√§t aus.');
                return;
            }
        }

        const account = {
            id: id || Date.now().toString(),
            bank: document.getElementById('accountBank').value,
            iban: document.getElementById('accountIban').value,
            balance: parseFloat(document.getElementById('accountBalance').value) || 0,
            type: document.getElementById('accountType').value,
            entityIds: entityIds,
            createdAt: id ? accounts.find(a => a.id === id).createdAt : new Date().toISOString()
        };

        if (id) {
            const index = accounts.findIndex(a => a.id === id);
            accounts[index] = account;
        } else {
            accounts.push(account);
        }

        localStorage.setItem('kontiq_accounts', JSON.stringify(accounts));
        closeBankModal();
        renderAccounts();
    }

    function editAccount(id) {
        openBankModal(id);
    }

    function deleteAccount(id) {
        if (confirm('M√∂chten Sie dieses Konto wirklich l√∂schen?')) {
            accounts = accounts.filter(a => a.id !== id);
            localStorage.setItem('kontiq_accounts', JSON.stringify(accounts));
            renderAccounts();
        }
    }

    // Initial render
    renderAccounts();
</script>
