<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Einstellungen ‚Äî Kontiq</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;color:#0A2540;background:#F8FAFC;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.container{max-width:1400px;margin:0 auto;padding:32px}
.header{margin-bottom:32px}
.header h1{font-size:32px;font-weight:800;letter-spacing:-0.8px;margin-bottom:8px;color:#0A2540}
.header p{color:#6B7280;font-size:16px;line-height:1.6}
.layout{display:grid;grid-template-columns:280px 1fr;gap:32px;align-items:start}
.sidebar{position:sticky;top:32px;background:white;border-radius:16px;padding:24px;box-shadow:0 4px 16px rgba(0,0,0,0.06);border:1px solid rgba(229,231,235,0.8)}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;cursor:pointer;transition:all 0.2s;font-size:15px;font-weight:500;color:#6B7280;margin-bottom:4px}
.nav-item:hover{background:#F1F5F9;color:#0A2540}
.nav-item.active{background:#0A2540;color:white}
.nav-item svg{width:20px;height:20px;flex-shrink:0;fill:currentColor}
.nav-group{margin-bottom:24px}
.nav-group:last-child{margin-bottom:0}
.nav-group-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#9CA3AF;margin-bottom:8px;padding:0 16px}
.content{background:white;border-radius:20px;padding:48px;box-shadow:0 4px 16px rgba(0,0,0,0.06);border:1px solid rgba(229,231,235,0.8);min-height:600px}
.content-section{display:none}
.content-section.active{display:block}
.content-header{margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid #E5E7EB}
.content-header h2{font-size:24px;font-weight:700;letter-spacing:-0.5px;margin-bottom:8px;color:#0A2540}
.content-header p{color:#6B7280;font-size:15px;line-height:1.6}
.section{margin-bottom:40px}
.section:last-child{margin-bottom:0}
.section-title{font-size:18px;font-weight:700;margin-bottom:20px;letter-spacing:-0.3px;color:#0A2540}
.form-group{margin-bottom:24px}
.form-group:last-child{margin-bottom:0}
.label{display:block;font-size:14px;font-weight:600;margin-bottom:8px;color:#374151}
.label-desc{font-size:13px;color:#6B7280;font-weight:400;margin-top:4px;line-height:1.5}
.input,.select,textarea{width:100%;padding:12px 16px;border:1px solid #E5E7EB;border-radius:10px;font-size:15px;font-family:inherit;transition:all 0.2s;background:white;min-height:44px;line-height:1.5}
.input:focus,.select:focus,textarea:focus{outline:none;border-color:#0EB17A;box-shadow:0 0 0 3px rgba(14,177,122,0.1)}
.input:disabled{background:#F9FAFB;color:#9CA3AF;cursor:not-allowed}
.select{cursor:pointer;appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%236B7280"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');background-repeat:no-repeat;background-position:right 12px center;background-size:16px;padding-right:40px}
textarea{resize:vertical;min-height:100px}
.btn{padding:12px 24px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;border:none;font-family:inherit;display:inline-flex;align-items:center;gap:8px;justify-content:center}
.btn-primary{background:#0A2540;color:white}
.btn-primary:hover{background:#051729;transform:translateY(-1px);box-shadow:0 4px 12px rgba(10,37,64,0.3)}
.btn-secondary{background:white;color:#0A2540;border:1px solid #E5E7EB}
.btn-secondary:hover{background:#F9FAFB;border-color:#D1D5DB}
.btn-success{background:#0EB17A;color:white}
.btn-success:hover{background:#0C9F6D;transform:translateY(-1px);box-shadow:0 4px 12px rgba(14,177,122,0.3)}
.btn-danger{background:#EF4444;color:white}
.btn-danger:hover{background:#DC2626;transform:translateY(-1px);box-shadow:0 4px 12px rgba(239,68,68,0.3)}
.btn-sm{padding:8px 16px;font-size:14px}
.btn-icon{width:36px;height:36px;padding:0;border-radius:8px}
.btn-text{background:transparent;color:#0A2540;padding:8px 12px}
.btn-text:hover{background:#F1F5F9}
.table{width:100%;border-collapse:collapse}
.table th{text-align:left;padding:12px 16px;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#6B7280;border-bottom:2px solid #E5E7EB}
.table td{padding:16px;border-bottom:1px solid #F3F4F6;font-size:15px}
.table tr:last-child td{border-bottom:none}
.table tr:hover{background:#F9FAFB}
.badge{display:inline-block;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;letter-spacing:0.3px}
.badge-admin{background:#FEF3C7;color:#92400E}
.badge-manager{background:#DBEAFE;color:#1E40AF}
.badge-user{background:#E0E7FF;color:#3730A3}
.badge-readonly{background:#F3F4F6;color:#6B7280}
.badge-active{background:#D1FAE5;color:#065F46}
.badge-pending{background:#FEF3C7;color:#92400E}
.user-row{display:flex;align-items:center;gap:12px}
.user-avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#0A2540,#0EB17A);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0}
.user-info{flex:1}
.user-name{font-weight:600;font-size:15px;color:#0A2540;margin-bottom:2px}
.user-email{font-size:13px;color:#6B7280}
.actions{display:flex;gap:8px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:white;border-radius:20px;padding:32px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 50px rgba(0,0,0,0.3)}
.modal-header{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid #E5E7EB;display:flex;align-items:flex-start;justify-content:space-between;gap:16px}
.modal-header > div:first-child{flex:1}
.modal-header h3{font-size:22px;font-weight:700;letter-spacing:-0.5px;color:#0A2540;margin:0;line-height:1.3}
.modal-header p{color:#6B7280;font-size:14px;margin-top:8px;line-height:1.5}
.close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:#6B7280;padding:8px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;border-radius:6px;width:36px;height:36px;flex-shrink:0}
.close-modal:hover{color:#0A2540;background:#F3F4F6}
.modal-footer{margin-top:32px;padding-top:24px;border-top:1px solid #E5E7EB;display:flex;gap:12px;justify-content:flex-end}
.checkbox-group{display:flex;flex-direction:column;gap:12px}
.checkbox-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #E5E7EB;border-radius:10px;cursor:pointer;transition:all 0.2s}
.checkbox-item:hover{background:#F9FAFB;border-color:#D1D5DB}
.checkbox-item input{width:20px;height:20px;cursor:pointer;accent-color:#0EB17A}
.checkbox-label{font-size:14px;font-weight:500;color:#374151;flex:1}
.checkbox-desc{font-size:12px;color:#6B7280;margin-top:4px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.alert{padding:16px 20px;border-radius:12px;margin-bottom:24px;display:flex;align-items:start;gap:16px}
.alert-warning{background:#FEF3C7;border:1px solid #F59E0B}
.alert-info{background:#DBEAFE;border:1px solid #3B82F6}
.alert-success{background:#D1FAE5;border:1px solid #0EB17A}
.alert-title{font-weight:700;font-size:14px;margin-bottom:4px}
.alert-warning .alert-title{color:#92400E}
.alert-info .alert-title{color:#1E40AF}
.alert-success .alert-title{color:#065F46}
.alert-message{font-size:13px;line-height:1.5}
.alert-warning .alert-message{color:#78350F}
.alert-info .alert-message{color:#1E3A8A}
.alert-success .alert-message{color:#064E3B}
.toggle{position:relative;width:48px;height:26px;background:#E5E7EB;border-radius:13px;cursor:pointer;transition:all 0.3s}
.toggle.active{background:#0EB17A}
.toggle-slider{position:absolute;top:3px;left:3px;width:20px;height:20px;background:white;border-radius:50%;transition:all 0.3s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
.toggle.active .toggle-slider{left:25px}
.toggle-row{display:flex;justify-content:space-between;align-items:center;padding:16px;border:1px solid #E5E7EB;border-radius:10px;margin-bottom:12px}
.toggle-info{flex:1}
.toggle-title{font-weight:600;font-size:15px;color:#0A2540;margin-bottom:4px}
.toggle-desc{font-size:13px;color:#6B7280;line-height:1.5}
.divider{height:1px;background:#E5E7EB;margin:32px 0}
.role-card{padding:20px;border:2px solid #E5E7EB;border-radius:12px;cursor:pointer;transition:all 0.2s;margin-bottom:12px}
.role-card:hover{border-color:#0EB17A;background:#F0FDF4}
.role-card.selected{border-color:#0EB17A;background:#F0FDF4}
.role-title{font-weight:700;font-size:16px;color:#0A2540;margin-bottom:8px}
.role-desc{font-size:13px;color:#6B7280;line-height:1.5}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:32px}
.stat-card{padding:20px;border:1px solid #E5E7EB;border-radius:12px;background:linear-gradient(135deg,#F9FAFB 0%,white 100%)}
.stat-value{font-size:28px;font-weight:800;color:#0A2540;margin-bottom:4px}
.stat-label{font-size:13px;color:#6B7280;font-weight:500}
.permission-section{margin-bottom:16px}
.permission-section-title{font-size:14px;font-weight:700;color:#374151;margin-bottom:12px;padding-left:4px}
.permission-level{margin-left:32px;padding:8px 12px;border-radius:8px;display:flex;align-items:center;gap:8px;margin-bottom:8px}
.permission-level input[type="radio"]{accent-color:#0EB17A}
.permission-level label{font-size:14px;color:#374151;cursor:pointer;flex:1}
@media(max-width:1024px){
.layout{grid-template-columns:1fr}
.sidebar{position:static;margin-bottom:24px}
.nav-group{display:flex;flex-wrap:wrap;gap:8px}
.nav-group-title{display:none}
.grid-2{grid-template-columns:1fr}
}
/* Masquer header/menu sur mobile */
@media (max-width: 768px) {
  .sidebar,
  .side-menu,
  .module-list,
  .main-nav,
  .page-header {
    display: none !important;
  }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>Einstellungen</h1>
<p>Verwalten Sie Ihre Unternehmenseinstellungen, Benutzer und Zugriffsrechte</p>
</div>

<div class="layout">
<div class="sidebar">
<div class="nav-group">
<div class="nav-group-title">Pers√∂nlich</div>
<div class="nav-item active" data-section="profile">
<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
Mein Profil
</div>
</div>

<div class="nav-group">
<div class="nav-group-title">Verwaltung</div>
<div class="nav-item" data-section="users">
<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
Benutzer & Rechte
</div>
<div class="nav-item" data-section="company">
<svg viewBox="0 0 24 24"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
Firmendaten
</div>
</div>

<div class="nav-group">
<div class="nav-group-title">Pr√§ferenzen</div>
<div class="nav-item" data-section="preferences">
<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
Sprache & W√§hrung
</div>
<div class="nav-item" data-section="appearance">
<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
Erscheinungsbild
</div>
<div class="nav-item" data-section="notifications">
<svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
Benachrichtigungen
</div>
</div>

<div class="nav-group">
<div class="nav-group-title">Sicherheit</div>
<div class="nav-item" data-section="security">
<svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
Sicherheit
</div>
</div>
</div>

<div class="content">
<!-- Profil Section -->
<div class="content-section active" id="profile-section">
<div class="content-header">
<h2>Mein Profil</h2>
<p>Verwalten Sie Ihre pers√∂nlichen Informationen und Einstellungen</p>
</div>

<div class="section">
<div class="section-title">Pers√∂nliche Daten</div>
<form id="profileForm" onsubmit="saveProfile(event)">
<div class="grid-2">
<div class="form-group">
<label class="label">Vorname</label>
<input type="text" class="input" id="profileFirstName" placeholder="Max" required>
</div>
<div class="form-group">
<label class="label">Nachname</label>
<input type="text" class="input" id="profileLastName" placeholder="Mustermann" required>
</div>
</div>

<div class="form-group">
<label class="label">E-Mail-Adresse</label>
<input type="email" class="input" id="profileEmail" disabled>
<div class="label-desc">Die E-Mail-Adresse kann nicht ge√§ndert werden</div>
</div>

<div class="form-group">
<label class="label">Telefonnummer (optional)</label>
<input type="tel" class="input" id="profilePhone" placeholder="+49 123 456789">
</div>

<div class="form-group">
<label class="label">Firma</label>
<input type="text" class="input" id="profileCompany" disabled>
</div>

<div class="form-group">
<label class="label">Rolle</label>
<input type="text" class="input" id="profileRole" disabled>
<div class="label-desc">Ihre Rolle wird vom Gesch√§ftsf√ºhrer festgelegt</div>
</div>

<div class="modal-footer" style="margin-top:32px;padding:0;border:none">
<button type="submit" class="btn btn-primary">Profil speichern</button>
</div>
</form>
</div>

<div class="section">
<div class="section-title">Passwort √§ndern</div>
<form id="passwordForm" onsubmit="changePassword(event)">
<div class="form-group">
<label class="label">Aktuelles Passwort</label>
<input type="password" class="input" id="currentPassword" required>
</div>

<div class="grid-2">
<div class="form-group">
<label class="label">Neues Passwort</label>
<input type="password" class="input" id="newPassword" required minlength="8">
<div class="label-desc">Mindestens 8 Zeichen</div>
</div>
<div class="form-group">
<label class="label">Passwort best√§tigen</label>
<input type="password" class="input" id="confirmNewPassword" required minlength="8">
</div>
</div>

<div class="modal-footer" style="margin-top:24px;padding:0;border:none">
<button type="submit" class="btn btn-success">Passwort √§ndern</button>
</div>
</form>
</div>
</div>

<!-- Benutzer & Rechte Section -->
<div class="content-section" id="users-section">
<div class="content-header">
<h2>Benutzerverwaltung & Zugriffsrechte</h2>
<p>Verwalten Sie Benutzer und deren Zugriffsrechte auf Entit√§ten und Module</p>
</div>

<div class="alert alert-info" style="margin-bottom:24px">
<div>
<div class="alert-title">üí° Hierarchisches Berechtigungssystem</div>
<div class="alert-message"><strong>Gesch√§ftsf√ºhrer:</strong> Hat vollen Zugriff und kann alle Benutzer verwalten.<br>
<strong>Manager:</strong> Kann Benutzer f√ºr seine Entit√§ten einladen und Rechte vergeben.<br>
<strong>Mitarbeiter:</strong> Sieht nur die Daten, f√ºr die er berechtigt wurde.</div>
</div>
</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px">
<div style="background:white;padding:20px;border-radius:12px;border:1px solid #E5E7EB">
<div style="font-size:32px;font-weight:700;color:#0A2540" id="stat-users">-</div>
<div style="font-size:14px;color:#6B7280">Aktive Benutzer</div>
</div>
<div style="background:white;padding:20px;border-radius:12px;border:1px solid #E5E7EB">
<div style="font-size:32px;font-weight:700;color:#0EB17A" id="stat-managers">-</div>
<div style="font-size:14px;color:#6B7280">Manager</div>
</div>
<div style="background:white;padding:20px;border-radius:12px;border:1px solid #E5E7EB">
<div style="font-size:32px;font-weight:700;color:#3B82F6" id="stat-entities">-</div>
<div style="font-size:14px;color:#6B7280">Entit√§ten</div>
</div>
</div>

<div class="section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<div class="section-title">Benutzer</div>
<button class="btn btn-success" id="invite-user-btn" onclick="openInviteModal()" style="display:none">+ Benutzer einladen</button>
</div>

<div id="users-list-container">
<table class="table">
<thead>
<tr>
<th>Benutzer</th>
<th>Module-Zugriff</th>
<th>Entit√§ten</th>
<th>Aktionen</th>
</tr>
</thead>
<tbody id="users-tbody">
<tr><td colspan="4" style="text-align:center;color:#6B7280;padding:40px">Lade Benutzer...</td></tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Firmendaten Section -->
<div class="content-section" id="company-section">
<div class="content-header">
<h2>Firmendaten</h2>
<p>Verwalten Sie Ihre Unternehmensinformationen und rechtliche Angaben</p>
</div>

<div class="section">
<div class="section-title">Grundinformationen</div>
<div class="form-group">
<label class="label">Firmenname</label>
<input type="text" class="input" value="Kontiq GmbH" placeholder="Firmenname eingeben">
</div>
<div class="form-group">
<label class="label">Rechtsform</label>
<select class="select">
<option>GmbH</option>
<option>AG</option>
<option>UG (haftungsbeschr√§nkt)</option>
<option>Einzelunternehmen</option>
<option>GbR</option>
<option>OHG</option>
<option>KG</option>
</select>
</div>
<div class="grid-2">
<div class="form-group">
<label class="label">Handelsregisternummer</label>
<input type="text" class="input" placeholder="HRB 123456">
</div>
<div class="form-group">
<label class="label">Registergericht</label>
<input type="text" class="input" placeholder="Amtsgericht D√ºsseldorf">
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Steuerinformationen</div>
<div class="grid-2">
<div class="form-group">
<label class="label">Umsatzsteuer-ID</label>
<input type="text" class="input" placeholder="DE123456789">
</div>
<div class="form-group">
<label class="label">Steuernummer</label>
<input type="text" class="input" placeholder="123/456/78910">
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Adresse</div>
<div class="form-group">
<label class="label">Stra√üe und Hausnummer</label>
<input type="text" class="input" placeholder="Musterstra√üe 123">
</div>
<div class="grid-2">
<div class="form-group">
<label class="label">Postleitzahl</label>
<input type="text" class="input" placeholder="40210">
</div>
<div class="form-group">
<label class="label">Stadt</label>
<input type="text" class="input" placeholder="D√ºsseldorf">
</div>
</div>
<div class="form-group">
<label class="label">Land</label>
<select class="select">
<option>Deutschland</option>
<option>√ñsterreich</option>
<option>Schweiz</option>
</select>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Kontaktinformationen</div>
<div class="grid-2">
<div class="form-group">
<label class="label">Telefon</label>
<input type="tel" class="input" placeholder="+49 211 12345678">
</div>
<div class="form-group">
<label class="label">E-Mail</label>
<input type="email" class="input" placeholder="kontakt@kontiq.de">
</div>
</div>
<div class="form-group">
<label class="label">Website</label>
<input type="url" class="input" placeholder="https://www.kontiq.de">
</div>
</div>

<div style="margin-top:32px">
<button class="btn btn-primary">√Ñnderungen speichern</button>
</div>
</div>

<!-- Sprache & W√§hrung Section -->
<div class="content-section" id="preferences-section">
<div class="content-header">
<h2>Sprache & W√§hrung</h2>
<p>Passen Sie die Anzeigeeinstellungen Ihrer Kontiq-Installation an</p>
</div>

<div class="section">
<div class="section-title">Spracheinstellungen</div>
<div class="form-group">
<label class="label">
Systemsprache
<div class="label-desc">Die Sprache der Benutzeroberfl√§che</div>
</label>
<select class="select">
<option value="de">Deutsch</option>
<option value="en">English</option>
<option value="fr">Fran√ßais</option>
</select>
</div>
<div class="form-group">
<label class="label">
Datumsformat
<div class="label-desc">Wie Daten angezeigt werden</div>
</label>
<select class="select">
<option value="dd.mm.yyyy">TT.MM.JJJJ (31.12.2024)</option>
<option value="mm/dd/yyyy">MM/DD/YYYY (12/31/2024)</option>
<option value="yyyy-mm-dd">JJJJ-MM-TT (2024-12-31)</option>
</select>
</div>
<div class="form-group">
<label class="label">
Zeitformat
<div class="label-desc">12-Stunden oder 24-Stunden Format</div>
</label>
<select class="select">
<option value="24h">24-Stunden (14:30)</option>
<option value="12h">12-Stunden (2:30 PM)</option>
</select>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">W√§hrungseinstellungen</div>
<div class="form-group">
<label class="label">
Standardw√§hrung
<div class="label-desc">Die Hauptw√§hrung f√ºr alle Transaktionen</div>
</label>
<select class="select">
<option value="EUR">EUR - Euro (‚Ç¨)</option>
<option value="USD">USD - US Dollar ($)</option>
<option value="GBP">GBP - Britisches Pfund (¬£)</option>
<option value="CHF">CHF - Schweizer Franken (CHF)</option>
</select>
</div>
<div class="form-group">
<label class="label">
Zahlenformat
<div class="label-desc">Dezimal- und Tausendertrennzeichen</div>
</label>
<select class="select">
<option value="de">1.234.567,89 (Deutsch)</option>
<option value="en">1,234,567.89 (Englisch)</option>
<option value="fr">1 234 567,89 (Franz√∂sisch)</option>
</select>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Regionale Einstellungen</div>
<div class="form-group">
<label class="label">
Zeitzone
<div class="label-desc">F√ºr Berichte und geplante Aktionen</div>
</label>
<select class="select">
<option value="Europe/Berlin">Europa/Berlin (MEZ/MESZ)</option>
<option value="Europe/London">Europa/London (GMT/BST)</option>
<option value="Europe/Paris">Europa/Paris (MEZ/MESZ)</option>
<option value="Europe/Zurich">Europa/Z√ºrich (MEZ/MESZ)</option>
</select>
</div>
<div class="form-group">
<label class="label">
Gesch√§ftsjahr
<div class="label-desc">Start des Gesch√§ftsjahres</div>
</label>
<select class="select">
<option value="01">Januar (Kalenderjahr)</option>
<option value="04">April</option>
<option value="07">Juli</option>
<option value="10">Oktober</option>
</select>
</div>
</div>

<div style="margin-top:32px">
<button class="btn btn-primary">√Ñnderungen speichern</button>
</div>
</div>

<!-- Erscheinungsbild Section -->
<div class="content-section" id="appearance-section">
<div class="content-header">
<h2>Erscheinungsbild</h2>
<p>Personalisieren Sie das Aussehen Ihrer Kontiq-Installation</p>
</div>

<div class="section">
<div class="section-title">Farbschema</div>
<div class="form-group">
<label class="label">
Theme
<div class="label-desc">W√§hlen Sie zwischen hellem und dunklem Modus</div>
</label>
<select class="select">
<option value="light">Hell</option>
<option value="dark">Dunkel</option>
<option value="auto">Automatisch (Systemeinstellung)</option>
</select>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Dashboard-Anpassung</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Kompakte Ansicht</div>
<div class="toggle-desc">Zeigt mehr Informationen auf weniger Platz an</div>
</div>
<div class="toggle" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Animationen</div>
<div class="toggle-desc">Bewegungseffekte in der Benutzeroberfl√§che</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Tooltips anzeigen</div>
<div class="toggle-desc">Hilfreiche Erkl√§rungen beim √úberfahren mit der Maus</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Tabellen-Anzeige</div>
<div class="form-group">
<label class="label">
Standard-Zeilenanzahl
<div class="label-desc">Anzahl der Eintr√§ge pro Seite in Tabellen</div>
</label>
<select class="select">
<option value="10">10 Eintr√§ge</option>
<option value="25">25 Eintr√§ge</option>
<option value="50">50 Eintr√§ge</option>
<option value="100">100 Eintr√§ge</option>
</select>
</div>
</div>

<div style="margin-top:32px">
<button class="btn btn-primary">√Ñnderungen speichern</button>
</div>
</div>

<!-- Benachrichtigungen Section -->
<div class="content-section" id="notifications-section">
<div class="content-header">
<h2>Benachrichtigungen</h2>
<p>Legen Sie fest, wann und wie Sie benachrichtigt werden m√∂chten</p>
</div>

<div class="section">
<div class="section-title">E-Mail-Benachrichtigungen</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">T√§gliche Zusammenfassung</div>
<div class="toggle-desc">Erhalten Sie t√§glich um 8:00 Uhr eine √úbersicht Ihrer Finanzen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">F√§llige Rechnungen</div>
<div class="toggle-desc">Erinnerung 3 Tage vor F√§lligkeit</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">√úberf√§llige Zahlungen</div>
<div class="toggle-desc">Benachrichtigung bei √ºberf√§lligen Forderungen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Budget√ºberschreitungen</div>
<div class="toggle-desc">Warnung wenn Budgetgrenzen erreicht werden</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Neue Teammitglieder</div>
<div class="toggle-desc">Benachrichtigung bei neuen Benutzern</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Push-Benachrichtigungen</div>
<div class="alert alert-info">
<div>
<div class="alert-title">Browser-Benachrichtigungen aktivieren</div>
<div class="alert-message">Erlauben Sie Ihrem Browser, Benachrichtigungen anzuzeigen, um wichtige Updates in Echtzeit zu erhalten.</div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Kritische Warnungen</div>
<div class="toggle-desc">Sofortige Benachrichtigung bei kritischen Ereignissen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Transaktionsbest√§tigungen</div>
<div class="toggle-desc">Best√§tigung nach jeder Transaktion</div>
</div>
<div class="toggle" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Benachrichtigungskan√§le</div>
<div class="form-group">
<label class="label">
E-Mail-Adresse f√ºr Benachrichtigungen
<div class="label-desc">Haupt-E-Mail f√ºr alle Benachrichtigungen</div>
</label>
<input type="email" class="input" value="christian@kontiq.de">
</div>
<div class="form-group">
<label class="label">
Backup-E-Mail (optional)
<div class="label-desc">Alternative E-Mail f√ºr kritische Benachrichtigungen</div>
</label>
<input type="email" class="input" placeholder="backup@kontiq.de">
</div>
</div>

<div style="margin-top:32px">
<button class="btn btn-primary">√Ñnderungen speichern</button>
</div>
</div>

<!-- Sicherheit Section -->
<div class="content-section" id="security-section">
<div class="content-header">
<h2>Sicherheit</h2>
<p>Sch√ºtzen Sie Ihr Konto und Ihre Unternehmensdaten</p>
</div>

<div class="section">
<div class="section-title">Passwort</div>
<div class="form-group">
<label class="label">Aktuelles Passwort</label>
<input type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<div class="form-group">
<label class="label">Neues Passwort</label>
<input type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<div class="form-group">
<label class="label">Neues Passwort best√§tigen</label>
<input type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<button class="btn btn-primary">Passwort √§ndern</button>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Zwei-Faktor-Authentifizierung (2FA)</div>
<div class="alert alert-warning">
<div>
<div class="alert-title">Sicherheit erh√∂hen</div>
<div class="alert-message">Aktivieren Sie die Zwei-Faktor-Authentifizierung f√ºr zus√§tzlichen Schutz Ihres Kontos.</div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">2FA aktiviert</div>
<div class="toggle-desc">Zus√§tzlicher Code bei jeder Anmeldung erforderlich</div>
</div>
<div class="toggle" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<button class="btn btn-secondary btn-sm" style="margin-top:16px">2FA konfigurieren</button>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Sitzungsverwaltung</div>
<div class="form-group">
<label class="label">
Automatische Abmeldung
<div class="label-desc">Maximale Inaktivit√§tsdauer vor automatischer Abmeldung</div>
</label>
<select class="select">
<option value="15">15 Minuten</option>
<option value="30">30 Minuten</option>
<option value="60">1 Stunde</option>
<option value="120">2 Stunden</option>
<option value="0">Nie</option>
</select>
</div>
<div style="margin-top:20px">
<div class="section-title">Aktive Sitzungen</div>
<div style="border:1px solid #E5E7EB;border-radius:10px;padding:16px;margin-bottom:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-weight:600;margin-bottom:4px">Aktuelle Sitzung</div>
<div style="font-size:13px;color:#6B7280">Chrome auf Windows ‚Ä¢ D√ºsseldorf, Deutschland</div>
<div style="font-size:12px;color:#9CA3AF;margin-top:4px">Zuletzt aktiv: Jetzt</div>
</div>
<span class="badge badge-active">Aktiv</span>
</div>
</div>
<div style="border:1px solid #E5E7EB;border-radius:10px;padding:16px;margin-bottom:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-weight:600;margin-bottom:4px">iPhone</div>
<div style="font-size:13px;color:#6B7280">Safari auf iOS ‚Ä¢ D√ºsseldorf, Deutschland</div>
<div style="font-size:12px;color:#9CA3AF;margin-top:4px">Zuletzt aktiv: Vor 2 Stunden</div>
</div>
<button class="btn btn-sm btn-danger">Beenden</button>
</div>
</div>
</div>
<button class="btn btn-secondary btn-sm" style="margin-top:12px">Alle anderen Sitzungen beenden</button>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Aktivit√§tsprotokoll</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Anmeldeprotokoll speichern</div>
<div class="toggle-desc">Alle Anmeldeversuche f√ºr 90 Tage aufzeichnen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Verd√§chtige Aktivit√§ten melden</div>
<div class="toggle-desc">Benachrichtigung bei ungew√∂hnlichen Anmeldungen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<button class="btn btn-secondary btn-sm" style="margin-top:16px">Aktivit√§tsprotokoll anzeigen</button>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Konto-Verwaltung</div>
<div class="alert alert-warning" style="margin-bottom:20px">
<div>
<div class="alert-title">Achtung</div>
<div class="alert-message">Das L√∂schen Ihres Kontos kann nicht r√ºckg√§ngig gemacht werden. Alle Daten werden dauerhaft gel√∂scht.</div>
</div>
</div>
<button class="btn btn-danger">Konto l√∂schen</button>
</div>
</div>
</div>
</div>

<!-- Modal: Benutzer einladen -->
<div class="modal" id="invite-modal">
<div class="modal-content" style="max-width:700px">
<div class="modal-header">
<div>
<h3>Benutzer einladen</h3>
<p>Laden Sie einen neuen Benutzer ein und definieren Sie seine Zugriffsrechte</p>
</div>
<button class="close-modal" onclick="closeInviteModal()">√ó</button>
</div>

<form onsubmit="sendInvite(event)">
<div class="form-group">
<label class="label">E-Mail-Adresse *</label>
<input type="email" class="input" placeholder="benutzer@firma.de" id="invite-email" required>
</div>

<div class="grid-2">
<div class="form-group">
<label class="label">Vorname *</label>
<input type="text" class="input" placeholder="Max" id="invite-firstname" required>
</div>
<div class="form-group">
<label class="label">Nachname *</label>
<input type="text" class="input" placeholder="Mustermann" id="invite-lastname" required>
</div>
</div>

<div class="form-group">
<label class="label">Rolle *</label>
<select class="select" id="invite-role" onchange="updateInvitePermissions()" required>
<option value="">Bitte w√§hlen...</option>
<option value="manager">Manager - Kann eine oder mehrere Entit√§ten verwalten</option>
<option value="employee">Mitarbeiter - Nur Lese-/Bearbeitungsrechte</option>
</select>
<div class="label-desc" id="role-description"></div>
</div>

<!-- Entit√§ten Zugriff (nur f√ºr Manager und Mitarbeiter) -->
<div class="form-group" id="entities-access-group" style="display:none">
<label class="label">Zugriff auf Entit√§ten *</label>
<div class="label-desc">W√§hlen Sie die Entit√§ten aus, auf die der Benutzer Zugriff haben soll</div>
<div id="invite-entities-container" style="margin-top:12px">
<!-- Dynamisch generiert -->
</div>
</div>

<!-- Module Rechte -->
<div class="form-group" id="modules-access-group" style="display:none">
<label class="label">Zugriffsrechte auf Module</label>
<div class="label-desc">Definieren Sie f√ºr jedes Modul, ob der Benutzer es sehen und/oder bearbeiten kann</div>
<div id="invite-modules-container" style="margin-top:12px">
<!-- Dynamisch generiert -->
</div>
</div>

<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="closeInviteModal()">Abbrechen</button>
<button type="submit" class="btn btn-success">Einladung senden</button>
</div>
</form>
</div>
</div>

<!-- Modal: Rolle erstellen -->
<div class="modal" id="role-modal">
<div class="modal-content">
<div class="modal-header">
<div>
<h3>Neue Rolle erstellen</h3>
<p>Definieren Sie eine benutzerdefinierte Rolle mit spezifischen Zugriffsrechten.</p>
</div>
<button class="close-modal" onclick="closeRoleModal()">√ó</button>
</div>

<div class="form-group">
<label class="label">Rollenname</label>
<input type="text" class="input" placeholder="z.B. Controller, Teamleiter" id="role-name">
</div>

<div class="form-group">
<label class="label">Beschreibung</label>
<textarea class="input" rows="3" placeholder="Kurze Beschreibung der Rolle und ihrer Verantwortlichkeiten" id="role-description"></textarea>
</div>

<div class="form-group">
<label class="label">Berechtigungen f√ºr Module</label>
<div class="label-desc">Legen Sie fest, welche Zugriffslevel f√ºr jedes Modul gelten</div>
<div style="margin-top:16px">
<div class="permission-section">
<div class="permission-section-title">Cashflow-Management</div>
<div class="permission-level">
<input type="radio" name="perm-cashflow" id="perm-cashflow-none" value="none" checked>
<label for="perm-cashflow-none">Kein Zugriff</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-cashflow" id="perm-cashflow-read" value="read">
<label for="perm-cashflow-read">Lesen</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-cashflow" id="perm-cashflow-write" value="write">
<label for="perm-cashflow-write">Lesen & Bearbeiten</label>
</div>
</div>

<div class="permission-section">
<div class="permission-section-title">Forderungsmanagement</div>
<div class="permission-level">
<input type="radio" name="perm-forderungen" id="perm-forderungen-none" value="none" checked>
<label for="perm-forderungen-none">Kein Zugriff</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-forderungen" id="perm-forderungen-read" value="read">
<label for="perm-forderungen-read">Lesen</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-forderungen" id="perm-forderungen-write" value="write">
<label for="perm-forderungen-write">Lesen & Bearbeiten</label>
</div>
</div>

<div class="permission-section">
<div class="permission-section-title">Budgetplanung</div>
<div class="permission-level">
<input type="radio" name="perm-budget" id="perm-budget-none" value="none" checked>
<label for="perm-budget-none">Kein Zugriff</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-budget" id="perm-budget-read" value="read">
<label for="perm-budget-read">Lesen</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-budget" id="perm-budget-write" value="write">
<label for="perm-budget-write">Lesen & Bearbeiten</label>
</div>
</div>

<div class="permission-section">
<div class="permission-section-title">Reporting</div>
<div class="permission-level">
<input type="radio" name="perm-reporting" id="perm-reporting-none" value="none" checked>
<label for="perm-reporting-none">Kein Zugriff</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-reporting" id="perm-reporting-read" value="read">
<label for="perm-reporting-read">Lesen</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-reporting" id="perm-reporting-write" value="write">
<label for="perm-reporting-write">Lesen & Exportieren</label>
</div>
</div>
</div>
</div>

<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeRoleModal()">Abbrechen</button>
<button class="btn btn-primary" onclick="createRole()">Rolle erstellen</button>
</div>
</div>
</div>

<script>
const API_BASE = '';
let currentUser = null;
let allUsers = [];
let allEntities = [];
let allPermissions = {};
let currentEntityId = null;
let isGeschaeftsfuehrer = false;
let managedEntities = [];


// ==================================================
// VARIABLES GLOBALES
// ==================================================
// Note: Les fonctions ont √©t√© d√©plac√©es vers des fichiers s√©par√©s:
// - einstellungen-profile.js: Gestion du profil utilisateur
// - einstellungen-users.js: Gestion des utilisateurs et permissions
// - einstellungen-entities.js: Gestion des entit√©s


// Module definitions - corresponds to actual app modules (only business modules)
const MODULES = {
  dashboard: { label: 'Dashboard', icon: 'üìä', description: '√úbersicht und Zusammenfassung' },
  bankkonten: { label: 'Bankkonten', icon: 'üè¶', description: 'Kontost√§nde und Transaktionen', sensitive: true },
  zahlungen: { label: 'Zahlungen', icon: 'üí≥', description: 'Ein- und Auszahlungen verwalten' },
  forderungen: { label: 'Forderungen', icon: 'üìã', description: 'Offene Posten und Mahnwesen' },
  kosten: { label: 'Kosten', icon: 'üí∞', description: 'Ausgaben und Kostenarten' },
  liquiditat: { label: 'Liquidit√§t', icon: 'üìà', description: 'Cashflow und Prognosen' },
  vertrage: { label: 'Vertr√§ge', icon: 'üìÑ', description: 'Laufende Vertr√§ge verwalten' },
  kpis: { label: 'KPIs', icon: 'üéØ', description: 'Kennzahlen und Metriken' },
  reports: { label: 'Reports', icon: 'üìë', description: 'Berichte und Analysen' }
};

// Helper function to get managers of an entity (supports both old single manager and new multi-manager)
function getEntityManagers(entity) {
  if (!entity) return [];
  if (entity.managers && Array.isArray(entity.managers)) {
    return entity.managers;
  }
  if (entity.manager) {
    return [entity.manager];
  }
  return [];
}

// Check if user is manager of entity
function isManagerOf(entity, email) {
  return getEntityManagers(entity).includes(email);
}

// Load permissions data
async function loadPermissionsData() {
  try {
    console.log('Loading permissions data...');

    // Fetch users from API
    const usersResponse = await fetch('/api/users');
    const usersData = await usersResponse.json();
    allUsers = usersData.users || [];

    // Fetch entities from API
    const entitiesResponse = await fetch('/api/entitaeten');
    const entitiesData = await entitiesResponse.json();
    allEntities = entitiesData.entitaeten || [];

    // Fetch permissions from API
    try {
      const permissionsResponse = await fetch('/api/permissions');
      allPermissions = await permissionsResponse.json();
    } catch (e) {
      console.warn('Could not load permissions:', e);
      allPermissions = {};
    }

    console.log('Loaded users:', allUsers.length);
    console.log('Loaded entities:', allEntities.length);
    console.log('Loaded permissions:', allPermissions);

    // Check if current user is Gesch√§ftsf√ºhrer
    isGeschaeftsfuehrer = currentUser.role === 'gesch√§ftsfuehrer' || currentUser.role === 'admin';

    // Get managed entities
    if (isGeschaeftsfuehrer) {
      managedEntities = allEntities;
    } else {
      managedEntities = allEntities.filter(e => isManagerOf(e, currentUser.email));
    }

    // Render users table
    renderUsersTable();

    // Show invite button if user can manage users
    const inviteBtn = document.getElementById('invite-user-btn');
    if (inviteBtn && (isGeschaeftsfuehrer || managedEntities.length > 0)) {
      inviteBtn.style.display = 'inline-flex';
    }

  } catch (error) {
    console.error('Error loading permissions data:', error);
    document.getElementById('users-tbody').innerHTML = `<tr><td colspan="4" style="text-align:center;color:#DC2626;padding:40px">Fehler beim Laden: ${error.message}</td></tr>`;
  }
}

// Render users table
function renderUsersTable() {
  const tbody = document.getElementById('users-tbody');
  if (!tbody) return;

  if (allUsers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6B7280;padding:40px">Keine Benutzer gefunden</td></tr>';
    return;
  }

  let html = '';
  allUsers.forEach(user => {
    const userPerms = allPermissions.globalPermissions?.[user.email] || {};
    const role = userPerms.role || user.role || 'employee';
    const permissions = userPerms.permissions || {};
    const managedEntityIds = userPerms.managedEntityIds || [];
    const accessibleEntityIds = userPerms.accessibleEntityIds || [];

    // Count accessible modules
    const moduleCount = Object.keys(permissions).filter(m => permissions[m]?.read).length;

    // Get entity names
    const entityNames = [...new Set([...managedEntityIds, ...accessibleEntityIds])]
      .map(id => {
        const entity = allEntities.find(e => e.id === id);
        return entity ? entity.name : id;
      })
      .slice(0, 3)
      .join(', ');

    const roleLabel = role === 'gesch√§ftsfuehrer' ? 'Gesch√§ftsf√ºhrer' :
                      role === 'manager' ? 'Manager' :
                      role === 'employee' ? 'Mitarbeiter' :
                      role === 'readonly' ? 'Nur-Lesen' : role;

    const roleBadgeClass = role === 'gesch√§ftsfuehrer' ? 'badge-admin' :
                            role === 'manager' ? 'badge-manager' :
                            role === 'employee' ? 'badge-user' :
                            'badge-readonly';

    html += `
      <tr>
        <td>
          <div class="user-row">
            <div class="user-avatar">${user.name ? user.name.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase()}</div>
            <div class="user-info">
              <div class="user-name">${user.name || user.email.split('@')[0]}</div>
              <div class="user-email">${user.email}</div>
            </div>
          </div>
        </td>
        <td>
          <span class="badge ${roleBadgeClass}">${roleLabel}</span>
          <div style="font-size:12px;color:#6B7280;margin-top:4px">${moduleCount} Module</div>
        </td>
        <td>
          <div style="font-size:14px">${entityNames || 'Keine'}</div>
          <div style="font-size:12px;color:#6B7280;margin-top:4px">${managedEntityIds.length + accessibleEntityIds.length} Entit√§ten</div>
        </td>
        <td>
          <div class="actions">
            ${(isGeschaeftsfuehrer || managedEntityIds.some(id => managedEntities.find(e => e.id === id))) ? `
              <button class="btn btn-sm btn-secondary" onclick="editUserPermissions('${user.email}')">Rechte bearbeiten</button>
            ` : ''}
          </div>
        </td>
      </tr>
    `;
  });

  tbody.innerHTML = html;
}

// Edit user permissions (placeholder)
function editUserPermissions(email) {
  alert(`Bearbeiten der Rechte f√ºr ${email} - Wird implementiert`);
}

// Load user profile
function loadUserProfile() {
  if (!currentUser) return;

  const firstName = currentUser.name?.split(' ')[0] || '';
  const lastName = currentUser.name?.split(' ')[1] || '';

  document.getElementById('profileFirstName').value = firstName;
  document.getElementById('profileLastName').value = lastName;
  document.getElementById('profileEmail').value = currentUser.email || '';
  document.getElementById('profileCompany').value = currentUser.company || '';

  const roleLabel = currentUser.role === 'gesch√§ftsfuehrer' ? 'Gesch√§ftsf√ºhrer' :
                    currentUser.role === 'manager' ? 'Manager' :
                    currentUser.role === 'employee' ? 'Mitarbeiter' :
                    currentUser.role === 'readonly' ? 'Nur-Lesen' : currentUser.role || 'Mitarbeiter';

  document.getElementById('profileRole').value = roleLabel;
}

// Save profile (placeholder)
function saveProfile(event) {
  event.preventDefault();
  alert('Profil speichern - Wird implementiert');
}

// Invite modal functions
function openInviteModal() {
  document.getElementById('invite-modal').classList.add('active');
}

function closeInviteModal() {
  document.getElementById('invite-modal').classList.remove('active');
}

function updateInvitePermissions() {
  // Placeholder for updating permissions based on role
  console.log('Updating invite permissions...');
}

// Initialize - execute immediately since we're loaded dynamically
(async function init() {
  console.log('=== Einstellungen page loaded ===');

  // Try both localStorage keys for compatibility
  let userData = localStorage.getItem('user') || localStorage.getItem('kontiq_user');
  console.log('Raw user data:', userData);

  if (!userData) {
    console.error('No user data in localStorage!');
    document.getElementById('users-tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#DC2626;padding:40px">Nicht angemeldet - bitte zuerst einloggen</td></tr>';
    return;
  }

  try {
    currentUser = JSON.parse(userData);
    console.log('Parsed user:', currentUser);

    if (!currentUser.email) {
      console.error('No email in user object');
      document.getElementById('users-tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#DC2626;padding:40px">Keine E-Mail gefunden</td></tr>';
      return;
    }

    // Structure currentUser with new permissions model for PermissionsManager
    const perms = currentUser.globalPermissions || {};
    currentUser.role = perms.role || currentUser.role || 'employee';
    currentUser.managedEntityIds = perms.managedEntityIds || [];
    currentUser.accessibleEntityIds = perms.accessibleEntityIds || [];
    currentUser.permissions = perms.permissions || {};

    console.log('Structured currentUser:', currentUser);

    // Load data
    await loadPermissionsData();

  } catch (error) {
    console.error('Error initializing:', error);
    document.getElementById('users-tbody').innerHTML = `<tr><td colspan="4" style="text-align:center;color:#DC2626;padding:40px">Fehler: ${error.message}</td></tr>`;
  }
})();

// Initialize navigation
function initializeNavigation() {
  console.log('Initializing navigation...');
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
      const section = this.getAttribute('data-section');
      console.log('Navigating to section:', section);

      document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
      this.classList.add('active');
      document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
      const targetSection = document.getElementById(section + '-section');
      if (targetSection) {
        targetSection.classList.add('active');

        // Load section-specific data
        if (section === 'profile') {
          loadUserProfile();
        } else if (section === 'users') {
          loadPermissionsData();
        }
      } else {
        console.error('Section not found:', section + '-section');
      }
    });
  });
}

// Call navigation init
initializeNavigation();

// Load profile on initial load
setTimeout(() => {
  loadUserProfile();
}, 100);

// Switch permission tabs
function switchPermTab(tab) {
  // Tab switching logic (if needed in future)
  console.log('Switching to tab:', tab);
}

// Toggle switch helper
function toggleSwitch(element) {
  element.classList.toggle('active');
}

// Role modal functions
function openRoleModal() {
  document.getElementById('role-modal').classList.add('active');
}

function closeRoleModal() {
  document.getElementById('role-modal').classList.remove('active');
}

function createRole() {
  const name = document.getElementById('role-name').value;
  const description = document.getElementById('role-description').value;
  if (!name || !description) {
    alert('Bitte f√ºllen Sie alle Felder aus');
    return;
  }
  alert('Rolle "' + name + '" wurde erfolgreich erstellt');
  closeRoleModal();
}
</script>
</body>
</html>