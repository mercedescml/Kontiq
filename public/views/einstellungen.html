<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Einstellungen ‚Äî Kontiq</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;color:#0A2540;background:#F8FAFC;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.container{max-width:1400px;margin:0 auto;padding:32px}
.header{margin-bottom:32px}
.header h1{font-size:32px;font-weight:800;letter-spacing:-0.8px;margin-bottom:8px;color:#0A2540}
.header p{color:#6B7280;font-size:16px;line-height:1.6}
.layout{display:grid;grid-template-columns:280px 1fr;gap:32px;align-items:start}
.sidebar{position:sticky;top:32px;background:white;border-radius:16px;padding:24px;box-shadow:0 4px 16px rgba(0,0,0,0.06);border:1px solid rgba(229,231,235,0.8)}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;cursor:pointer;transition:all 0.2s;font-size:15px;font-weight:500;color:#6B7280;margin-bottom:4px}
.nav-item:hover{background:#F1F5F9;color:#0A2540}
.nav-item.active{background:#0A2540;color:white}
.nav-item svg{width:20px;height:20px;flex-shrink:0;fill:currentColor}
.nav-group{margin-bottom:24px}
.nav-group:last-child{margin-bottom:0}
.nav-group-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#9CA3AF;margin-bottom:8px;padding:0 16px}
.content{background:white;border-radius:20px;padding:48px;box-shadow:0 4px 16px rgba(0,0,0,0.06);border:1px solid rgba(229,231,235,0.8);min-height:600px}
.content-section{display:none}
.content-section.active{display:block}
.content-header{margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid #E5E7EB}
.content-header h2{font-size:24px;font-weight:700;letter-spacing:-0.5px;margin-bottom:8px;color:#0A2540}
.content-header p{color:#6B7280;font-size:15px;line-height:1.6}
.section{margin-bottom:40px}
.section:last-child{margin-bottom:0}
.section-title{font-size:18px;font-weight:700;margin-bottom:20px;letter-spacing:-0.3px;color:#0A2540}
.form-group{margin-bottom:24px}
.form-group:last-child{margin-bottom:0}
.label{display:block;font-size:14px;font-weight:600;margin-bottom:8px;color:#374151}
.label-desc{font-size:13px;color:#6B7280;font-weight:400;margin-top:4px;line-height:1.5}
.input,.select,textarea{width:100%;padding:12px 16px;border:1px solid #E5E7EB;border-radius:10px;font-size:15px;font-family:inherit;transition:all 0.2s;background:white;min-height:44px;line-height:1.5}
.input:focus,.select:focus,textarea:focus{outline:none;border-color:#0EB17A;box-shadow:0 0 0 3px rgba(14,177,122,0.1)}
.input:disabled{background:#F9FAFB;color:#9CA3AF;cursor:not-allowed}
.select{cursor:pointer;appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%236B7280"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');background-repeat:no-repeat;background-position:right 12px center;background-size:16px;padding-right:40px}
textarea{resize:vertical;min-height:100px}
.btn{padding:12px 24px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;border:none;font-family:inherit;display:inline-flex;align-items:center;gap:8px;justify-content:center}
.btn-primary{background:#0A2540;color:white}
.btn-primary:hover{background:#051729;transform:translateY(-1px);box-shadow:0 4px 12px rgba(10,37,64,0.3)}
.btn-secondary{background:white;color:#0A2540;border:1px solid #E5E7EB}
.btn-secondary:hover{background:#F9FAFB;border-color:#D1D5DB}
.btn-success{background:#0EB17A;color:white}
.btn-success:hover{background:#0C9F6D;transform:translateY(-1px);box-shadow:0 4px 12px rgba(14,177,122,0.3)}
.btn-danger{background:#EF4444;color:white}
.btn-danger:hover{background:#DC2626;transform:translateY(-1px);box-shadow:0 4px 12px rgba(239,68,68,0.3)}
.btn-sm{padding:8px 16px;font-size:14px}
.btn-icon{width:36px;height:36px;padding:0;border-radius:8px}
.btn-text{background:transparent;color:#0A2540;padding:8px 12px}
.btn-text:hover{background:#F1F5F9}
.table{width:100%;border-collapse:collapse}
.table th{text-align:left;padding:12px 16px;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#6B7280;border-bottom:2px solid #E5E7EB}
.table td{padding:16px;border-bottom:1px solid #F3F4F6;font-size:15px}
.table tr:last-child td{border-bottom:none}
.table tr:hover{background:#F9FAFB}
.badge{display:inline-block;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;letter-spacing:0.3px}
.badge-admin{background:#FEF3C7;color:#92400E}
.badge-manager{background:#DBEAFE;color:#1E40AF}
.badge-user{background:#E0E7FF;color:#3730A3}
.badge-readonly{background:#F3F4F6;color:#6B7280}
.badge-active{background:#D1FAE5;color:#065F46}
.badge-pending{background:#FEF3C7;color:#92400E}
.user-row{display:flex;align-items:center;gap:12px}
.user-avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#0A2540,#0EB17A);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0}
.user-info{flex:1}
.user-name{font-weight:600;font-size:15px;color:#0A2540;margin-bottom:2px}
.user-email{font-size:13px;color:#6B7280}
.actions{display:flex;gap:8px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:white;border-radius:20px;padding:32px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 50px rgba(0,0,0,0.3)}
.modal-header{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid #E5E7EB;display:flex;align-items:flex-start;justify-content:space-between;gap:16px}
.modal-header > div:first-child{flex:1}
.modal-header h3{font-size:22px;font-weight:700;letter-spacing:-0.5px;color:#0A2540;margin:0;line-height:1.3}
.modal-header p{color:#6B7280;font-size:14px;margin-top:8px;line-height:1.5}
.close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:#6B7280;padding:8px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;border-radius:6px;width:36px;height:36px;flex-shrink:0}
.close-modal:hover{color:#0A2540;background:#F3F4F6}
.modal-footer{margin-top:32px;padding-top:24px;border-top:1px solid #E5E7EB;display:flex;gap:12px;justify-content:flex-end}
.checkbox-group{display:flex;flex-direction:column;gap:12px}
.checkbox-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #E5E7EB;border-radius:10px;cursor:pointer;transition:all 0.2s}
.checkbox-item:hover{background:#F9FAFB;border-color:#D1D5DB}
.checkbox-item input{width:20px;height:20px;cursor:pointer;accent-color:#0EB17A}
.checkbox-label{font-size:14px;font-weight:500;color:#374151;flex:1}
.checkbox-desc{font-size:12px;color:#6B7280;margin-top:4px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.alert{padding:16px 20px;border-radius:12px;margin-bottom:24px;display:flex;align-items:start;gap:16px}
.alert-warning{background:#FEF3C7;border:1px solid #F59E0B}
.alert-info{background:#DBEAFE;border:1px solid #3B82F6}
.alert-success{background:#D1FAE5;border:1px solid #0EB17A}
.alert-title{font-weight:700;font-size:14px;margin-bottom:4px}
.alert-warning .alert-title{color:#92400E}
.alert-info .alert-title{color:#1E40AF}
.alert-success .alert-title{color:#065F46}
.alert-message{font-size:13px;line-height:1.5}
.alert-warning .alert-message{color:#78350F}
.alert-info .alert-message{color:#1E3A8A}
.alert-success .alert-message{color:#064E3B}
.toggle{position:relative;width:48px;height:26px;background:#E5E7EB;border-radius:13px;cursor:pointer;transition:all 0.3s}
.toggle.active{background:#0EB17A}
.toggle-slider{position:absolute;top:3px;left:3px;width:20px;height:20px;background:white;border-radius:50%;transition:all 0.3s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
.toggle.active .toggle-slider{left:25px}
.toggle-row{display:flex;justify-content:space-between;align-items:center;padding:16px;border:1px solid #E5E7EB;border-radius:10px;margin-bottom:12px}
.toggle-info{flex:1}
.toggle-title{font-weight:600;font-size:15px;color:#0A2540;margin-bottom:4px}
.toggle-desc{font-size:13px;color:#6B7280;line-height:1.5}
.divider{height:1px;background:#E5E7EB;margin:32px 0}
.role-card{padding:20px;border:2px solid #E5E7EB;border-radius:12px;cursor:pointer;transition:all 0.2s;margin-bottom:12px}
.role-card:hover{border-color:#0EB17A;background:#F0FDF4}
.role-card.selected{border-color:#0EB17A;background:#F0FDF4}
.role-title{font-weight:700;font-size:16px;color:#0A2540;margin-bottom:8px}
.role-desc{font-size:13px;color:#6B7280;line-height:1.5}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:32px}
.stat-card{padding:20px;border:1px solid #E5E7EB;border-radius:12px;background:linear-gradient(135deg,#F9FAFB 0%,white 100%)}
.stat-value{font-size:28px;font-weight:800;color:#0A2540;margin-bottom:4px}
.stat-label{font-size:13px;color:#6B7280;font-weight:500}
.permission-section{margin-bottom:16px}
.permission-section-title{font-size:14px;font-weight:700;color:#374151;margin-bottom:12px;padding-left:4px}
.permission-level{margin-left:32px;padding:8px 12px;border-radius:8px;display:flex;align-items:center;gap:8px;margin-bottom:8px}
.permission-level input[type="radio"]{accent-color:#0EB17A}
.permission-level label{font-size:14px;color:#374151;cursor:pointer;flex:1}
@media(max-width:1024px){
.layout{grid-template-columns:1fr}
.sidebar{position:static;margin-bottom:24px}
.nav-group{display:flex;flex-wrap:wrap;gap:8px}
.nav-group-title{display:none}
.grid-2{grid-template-columns:1fr}
}
/* Masquer header/menu sur mobile */
@media (max-width: 768px) {
  .sidebar,
  .side-menu,
  .module-list,
  .main-nav,
  .page-header {
    display: none !important;
  }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>Einstellungen</h1>
<p>Verwalten Sie Ihre Unternehmenseinstellungen, Benutzer und Zugriffsrechte</p>
</div>

<div class="layout">
<div class="sidebar">
<div class="nav-group">
<div class="nav-group-title">Verwaltung</div>
<div class="nav-item active" data-section="users">
<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
Benutzer & Rechte
</div>
<div class="nav-item" data-section="company">
<svg viewBox="0 0 24 24"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
Firmendaten
</div>
</div>

<div class="nav-group">
<div class="nav-group-title">Pr√§ferenzen</div>
<div class="nav-item" data-section="preferences">
<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
Sprache & W√§hrung
</div>
<div class="nav-item" data-section="appearance">
<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
Erscheinungsbild
</div>
<div class="nav-item" data-section="notifications">
<svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
Benachrichtigungen
</div>
</div>

<div class="nav-group">
<div class="nav-group-title">Sicherheit</div>
<div class="nav-item" data-section="security">
<svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
Sicherheit
</div>
</div>
</div>

<div class="content">
<!-- Benutzer & Rechte Section -->
<div class="content-section active" id="users-section">
<div class="content-header">
<h2>Benutzerverwaltung & Zugriffsrechte</h2>
<p>Der Gesch√§ftsf√ºhrer definiert individuell, welche Module jeder Benutzer sehen und bearbeiten darf</p>
</div>

<div class="alert alert-info" style="margin-bottom:24px">
<div>
<div class="alert-title">üí° Berechtigungssystem</div>
<div class="alert-message">Sie als Gesch√§ftsf√ºhrer legen fest, was jeder Benutzer sehen und bearbeiten kann. Manager einer Entit√§t k√∂nnen zus√§tzlich Zugriffsrechte f√ºr ihre eigene Entit√§t vergeben.</div>
</div>
</div>

<div class="stats-grid" id="stats-grid">
<div class="stat-card">
<div class="stat-value" id="stat-users">-</div>
<div class="stat-label">Aktive Benutzer</div>
</div>
<div class="stat-card">
<div class="stat-value" id="stat-entities">-</div>
<div class="stat-label">Entit√§ten</div>
</div>
</div>

<!-- Tabs for Global vs Entity permissions -->
<div style="display:flex;gap:8px;margin-bottom:24px;border-bottom:2px solid #E5E7EB">
<div class="perm-tab active" onclick="switchPermTab('global')" id="tab-global" style="padding:12px 24px;cursor:pointer;font-weight:600;font-size:15px;color:#0A2540;border-bottom:2px solid #0EB17A;margin-bottom:-2px">Benutzer & Module</div>
<div class="perm-tab" onclick="switchPermTab('entities')" id="tab-entities" style="padding:12px 24px;cursor:pointer;font-weight:600;font-size:15px;color:#6B7280;border-bottom:2px solid transparent;margin-bottom:-2px">Zugriff auf Entit√§ten</div>
</div>

<!-- Global Permissions Tab -->
<div id="global-perm-tab">
<div class="section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<div class="section-title">Benutzer & Modulzugriff</div>
<button class="btn btn-success" onclick="openInviteModal()">Benutzer einladen</button>
</div>

<table class="table" id="users-table">
<thead>
<tr>
<th>Benutzer</th>
<th>Module-Zugriff</th>
<th>Entit√§ten</th>
<th>Aktionen</th>
</tr>
</thead>
<tbody id="users-tbody">
<tr><td colspan="4" style="text-align:center;color:#6B7280;padding:40px">Lade Benutzer...</td></tr>
</tbody>
</table>
</div>
</div>

<!-- Entity Access Tab -->
<div id="entities-perm-tab" style="display:none">
<div class="section">
<div class="section-title" style="margin-bottom:20px">Zugriff auf Entit√§ten verwalten</div>

<div id="entities-access-container">
<div style="text-align:center;color:#6B7280;padding:40px">Lade Entit√§ten...</div>
</div>
</div>
</div>
</div>

<!-- Firmendaten Section -->
<div class="content-section" id="company-section">
<div class="content-header">
<h2>Firmendaten</h2>
<p>Verwalten Sie Ihre Unternehmensinformationen und rechtliche Angaben</p>
</div>

<div class="section">
<div class="section-title">Grundinformationen</div>
<div class="form-group">
<label class="label">Firmenname</label>
<input type="text" class="input" value="Kontiq GmbH" placeholder="Firmenname eingeben">
</div>
<div class="form-group">
<label class="label">Rechtsform</label>
<select class="select">
<option>GmbH</option>
<option>AG</option>
<option>UG (haftungsbeschr√§nkt)</option>
<option>Einzelunternehmen</option>
<option>GbR</option>
<option>OHG</option>
<option>KG</option>
</select>
</div>
<div class="grid-2">
<div class="form-group">
<label class="label">Handelsregisternummer</label>
<input type="text" class="input" placeholder="HRB 123456">
</div>
<div class="form-group">
<label class="label">Registergericht</label>
<input type="text" class="input" placeholder="Amtsgericht D√ºsseldorf">
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Steuerinformationen</div>
<div class="grid-2">
<div class="form-group">
<label class="label">Umsatzsteuer-ID</label>
<input type="text" class="input" placeholder="DE123456789">
</div>
<div class="form-group">
<label class="label">Steuernummer</label>
<input type="text" class="input" placeholder="123/456/78910">
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Adresse</div>
<div class="form-group">
<label class="label">Stra√üe und Hausnummer</label>
<input type="text" class="input" placeholder="Musterstra√üe 123">
</div>
<div class="grid-2">
<div class="form-group">
<label class="label">Postleitzahl</label>
<input type="text" class="input" placeholder="40210">
</div>
<div class="form-group">
<label class="label">Stadt</label>
<input type="text" class="input" placeholder="D√ºsseldorf">
</div>
</div>
<div class="form-group">
<label class="label">Land</label>
<select class="select">
<option>Deutschland</option>
<option>√ñsterreich</option>
<option>Schweiz</option>
</select>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Kontaktinformationen</div>
<div class="grid-2">
<div class="form-group">
<label class="label">Telefon</label>
<input type="tel" class="input" placeholder="+49 211 12345678">
</div>
<div class="form-group">
<label class="label">E-Mail</label>
<input type="email" class="input" placeholder="kontakt@kontiq.de">
</div>
</div>
<div class="form-group">
<label class="label">Website</label>
<input type="url" class="input" placeholder="https://www.kontiq.de">
</div>
</div>

<div style="margin-top:32px">
<button class="btn btn-primary">√Ñnderungen speichern</button>
</div>
</div>

<!-- Sprache & W√§hrung Section -->
<div class="content-section" id="preferences-section">
<div class="content-header">
<h2>Sprache & W√§hrung</h2>
<p>Passen Sie die Anzeigeeinstellungen Ihrer Kontiq-Installation an</p>
</div>

<div class="section">
<div class="section-title">Spracheinstellungen</div>
<div class="form-group">
<label class="label">
Systemsprache
<div class="label-desc">Die Sprache der Benutzeroberfl√§che</div>
</label>
<select class="select">
<option value="de">Deutsch</option>
<option value="en">English</option>
<option value="fr">Fran√ßais</option>
</select>
</div>
<div class="form-group">
<label class="label">
Datumsformat
<div class="label-desc">Wie Daten angezeigt werden</div>
</label>
<select class="select">
<option value="dd.mm.yyyy">TT.MM.JJJJ (31.12.2024)</option>
<option value="mm/dd/yyyy">MM/DD/YYYY (12/31/2024)</option>
<option value="yyyy-mm-dd">JJJJ-MM-TT (2024-12-31)</option>
</select>
</div>
<div class="form-group">
<label class="label">
Zeitformat
<div class="label-desc">12-Stunden oder 24-Stunden Format</div>
</label>
<select class="select">
<option value="24h">24-Stunden (14:30)</option>
<option value="12h">12-Stunden (2:30 PM)</option>
</select>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">W√§hrungseinstellungen</div>
<div class="form-group">
<label class="label">
Standardw√§hrung
<div class="label-desc">Die Hauptw√§hrung f√ºr alle Transaktionen</div>
</label>
<select class="select">
<option value="EUR">EUR - Euro (‚Ç¨)</option>
<option value="USD">USD - US Dollar ($)</option>
<option value="GBP">GBP - Britisches Pfund (¬£)</option>
<option value="CHF">CHF - Schweizer Franken (CHF)</option>
</select>
</div>
<div class="form-group">
<label class="label">
Zahlenformat
<div class="label-desc">Dezimal- und Tausendertrennzeichen</div>
</label>
<select class="select">
<option value="de">1.234.567,89 (Deutsch)</option>
<option value="en">1,234,567.89 (Englisch)</option>
<option value="fr">1 234 567,89 (Franz√∂sisch)</option>
</select>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Regionale Einstellungen</div>
<div class="form-group">
<label class="label">
Zeitzone
<div class="label-desc">F√ºr Berichte und geplante Aktionen</div>
</label>
<select class="select">
<option value="Europe/Berlin">Europa/Berlin (MEZ/MESZ)</option>
<option value="Europe/London">Europa/London (GMT/BST)</option>
<option value="Europe/Paris">Europa/Paris (MEZ/MESZ)</option>
<option value="Europe/Zurich">Europa/Z√ºrich (MEZ/MESZ)</option>
</select>
</div>
<div class="form-group">
<label class="label">
Gesch√§ftsjahr
<div class="label-desc">Start des Gesch√§ftsjahres</div>
</label>
<select class="select">
<option value="01">Januar (Kalenderjahr)</option>
<option value="04">April</option>
<option value="07">Juli</option>
<option value="10">Oktober</option>
</select>
</div>
</div>

<div style="margin-top:32px">
<button class="btn btn-primary">√Ñnderungen speichern</button>
</div>
</div>

<!-- Erscheinungsbild Section -->
<div class="content-section" id="appearance-section">
<div class="content-header">
<h2>Erscheinungsbild</h2>
<p>Personalisieren Sie das Aussehen Ihrer Kontiq-Installation</p>
</div>

<div class="section">
<div class="section-title">Farbschema</div>
<div class="form-group">
<label class="label">
Theme
<div class="label-desc">W√§hlen Sie zwischen hellem und dunklem Modus</div>
</label>
<select class="select">
<option value="light">Hell</option>
<option value="dark">Dunkel</option>
<option value="auto">Automatisch (Systemeinstellung)</option>
</select>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Dashboard-Anpassung</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Kompakte Ansicht</div>
<div class="toggle-desc">Zeigt mehr Informationen auf weniger Platz an</div>
</div>
<div class="toggle" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Animationen</div>
<div class="toggle-desc">Bewegungseffekte in der Benutzeroberfl√§che</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Tooltips anzeigen</div>
<div class="toggle-desc">Hilfreiche Erkl√§rungen beim √úberfahren mit der Maus</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Tabellen-Anzeige</div>
<div class="form-group">
<label class="label">
Standard-Zeilenanzahl
<div class="label-desc">Anzahl der Eintr√§ge pro Seite in Tabellen</div>
</label>
<select class="select">
<option value="10">10 Eintr√§ge</option>
<option value="25">25 Eintr√§ge</option>
<option value="50">50 Eintr√§ge</option>
<option value="100">100 Eintr√§ge</option>
</select>
</div>
</div>

<div style="margin-top:32px">
<button class="btn btn-primary">√Ñnderungen speichern</button>
</div>
</div>

<!-- Benachrichtigungen Section -->
<div class="content-section" id="notifications-section">
<div class="content-header">
<h2>Benachrichtigungen</h2>
<p>Legen Sie fest, wann und wie Sie benachrichtigt werden m√∂chten</p>
</div>

<div class="section">
<div class="section-title">E-Mail-Benachrichtigungen</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">T√§gliche Zusammenfassung</div>
<div class="toggle-desc">Erhalten Sie t√§glich um 8:00 Uhr eine √úbersicht Ihrer Finanzen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">F√§llige Rechnungen</div>
<div class="toggle-desc">Erinnerung 3 Tage vor F√§lligkeit</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">√úberf√§llige Zahlungen</div>
<div class="toggle-desc">Benachrichtigung bei √ºberf√§lligen Forderungen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Budget√ºberschreitungen</div>
<div class="toggle-desc">Warnung wenn Budgetgrenzen erreicht werden</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Neue Teammitglieder</div>
<div class="toggle-desc">Benachrichtigung bei neuen Benutzern</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Push-Benachrichtigungen</div>
<div class="alert alert-info">
<div>
<div class="alert-title">Browser-Benachrichtigungen aktivieren</div>
<div class="alert-message">Erlauben Sie Ihrem Browser, Benachrichtigungen anzuzeigen, um wichtige Updates in Echtzeit zu erhalten.</div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Kritische Warnungen</div>
<div class="toggle-desc">Sofortige Benachrichtigung bei kritischen Ereignissen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Transaktionsbest√§tigungen</div>
<div class="toggle-desc">Best√§tigung nach jeder Transaktion</div>
</div>
<div class="toggle" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Benachrichtigungskan√§le</div>
<div class="form-group">
<label class="label">
E-Mail-Adresse f√ºr Benachrichtigungen
<div class="label-desc">Haupt-E-Mail f√ºr alle Benachrichtigungen</div>
</label>
<input type="email" class="input" value="christian@kontiq.de">
</div>
<div class="form-group">
<label class="label">
Backup-E-Mail (optional)
<div class="label-desc">Alternative E-Mail f√ºr kritische Benachrichtigungen</div>
</label>
<input type="email" class="input" placeholder="backup@kontiq.de">
</div>
</div>

<div style="margin-top:32px">
<button class="btn btn-primary">√Ñnderungen speichern</button>
</div>
</div>

<!-- Sicherheit Section -->
<div class="content-section" id="security-section">
<div class="content-header">
<h2>Sicherheit</h2>
<p>Sch√ºtzen Sie Ihr Konto und Ihre Unternehmensdaten</p>
</div>

<div class="section">
<div class="section-title">Passwort</div>
<div class="form-group">
<label class="label">Aktuelles Passwort</label>
<input type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<div class="form-group">
<label class="label">Neues Passwort</label>
<input type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<div class="form-group">
<label class="label">Neues Passwort best√§tigen</label>
<input type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<button class="btn btn-primary">Passwort √§ndern</button>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Zwei-Faktor-Authentifizierung (2FA)</div>
<div class="alert alert-warning">
<div>
<div class="alert-title">Sicherheit erh√∂hen</div>
<div class="alert-message">Aktivieren Sie die Zwei-Faktor-Authentifizierung f√ºr zus√§tzlichen Schutz Ihres Kontos.</div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">2FA aktiviert</div>
<div class="toggle-desc">Zus√§tzlicher Code bei jeder Anmeldung erforderlich</div>
</div>
<div class="toggle" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<button class="btn btn-secondary btn-sm" style="margin-top:16px">2FA konfigurieren</button>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Sitzungsverwaltung</div>
<div class="form-group">
<label class="label">
Automatische Abmeldung
<div class="label-desc">Maximale Inaktivit√§tsdauer vor automatischer Abmeldung</div>
</label>
<select class="select">
<option value="15">15 Minuten</option>
<option value="30">30 Minuten</option>
<option value="60">1 Stunde</option>
<option value="120">2 Stunden</option>
<option value="0">Nie</option>
</select>
</div>
<div style="margin-top:20px">
<div class="section-title">Aktive Sitzungen</div>
<div style="border:1px solid #E5E7EB;border-radius:10px;padding:16px;margin-bottom:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-weight:600;margin-bottom:4px">Aktuelle Sitzung</div>
<div style="font-size:13px;color:#6B7280">Chrome auf Windows ‚Ä¢ D√ºsseldorf, Deutschland</div>
<div style="font-size:12px;color:#9CA3AF;margin-top:4px">Zuletzt aktiv: Jetzt</div>
</div>
<span class="badge badge-active">Aktiv</span>
</div>
</div>
<div style="border:1px solid #E5E7EB;border-radius:10px;padding:16px;margin-bottom:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-weight:600;margin-bottom:4px">iPhone</div>
<div style="font-size:13px;color:#6B7280">Safari auf iOS ‚Ä¢ D√ºsseldorf, Deutschland</div>
<div style="font-size:12px;color:#9CA3AF;margin-top:4px">Zuletzt aktiv: Vor 2 Stunden</div>
</div>
<button class="btn btn-sm btn-danger">Beenden</button>
</div>
</div>
</div>
<button class="btn btn-secondary btn-sm" style="margin-top:12px">Alle anderen Sitzungen beenden</button>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Aktivit√§tsprotokoll</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Anmeldeprotokoll speichern</div>
<div class="toggle-desc">Alle Anmeldeversuche f√ºr 90 Tage aufzeichnen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<div class="toggle-row">
<div class="toggle-info">
<div class="toggle-title">Verd√§chtige Aktivit√§ten melden</div>
<div class="toggle-desc">Benachrichtigung bei ungew√∂hnlichen Anmeldungen</div>
</div>
<div class="toggle active" onclick="toggleSwitch(this)">
<div class="toggle-slider"></div>
</div>
</div>
<button class="btn btn-secondary btn-sm" style="margin-top:16px">Aktivit√§tsprotokoll anzeigen</button>
</div>

<div class="divider"></div>

<div class="section">
<div class="section-title">Konto-Verwaltung</div>
<div class="alert alert-warning" style="margin-bottom:20px">
<div>
<div class="alert-title">Achtung</div>
<div class="alert-message">Das L√∂schen Ihres Kontos kann nicht r√ºckg√§ngig gemacht werden. Alle Daten werden dauerhaft gel√∂scht.</div>
</div>
</div>
<button class="btn btn-danger">Konto l√∂schen</button>
</div>
</div>
</div>
</div>

<!-- Modal: Benutzer einladen -->
<div class="modal" id="invite-modal">
<div class="modal-content">
<div class="modal-header">
<div>
<h3>Benutzer einladen</h3>
<p>Laden Sie ein neues Teammitglied zu Kontiq ein. Der Benutzer erh√§lt eine E-Mail mit einem Link zur Kontoerstellung.</p>
</div>
<button class="close-modal" onclick="closeInviteModal()">√ó</button>
</div>

<div class="form-group">
<label class="label">E-Mail-Adresse</label>
<input type="email" class="input" placeholder="name@firma.de" id="invite-email">
</div>

<div class="grid-2">
<div class="form-group">
<label class="label">Vorname</label>
<input type="text" class="input" placeholder="Max" id="invite-firstname">
</div>
<div class="form-group">
<label class="label">Nachname</label>
<input type="text" class="input" placeholder="Mustermann" id="invite-lastname">
</div>
</div>

<div class="form-group">
<label class="label">Rolle zuweisen</label>
<select class="select" id="invite-role">
<option value="">Rolle ausw√§hlen...</option>
<option value="manager">Manager</option>
<option value="accountant">Buchhalter</option>
<option value="readonly">Nur-Lesen</option>
</select>
</div>

<div class="form-group">
<label class="label">Zugriff auf Module</label>
<div class="label-desc">W√§hlen Sie die Module aus, auf die dieser Benutzer Zugriff haben soll</div>
<div class="checkbox-group" id="invite-modules-container">
<!-- Module checkboxes will be generated dynamically -->
</div>
</div>

<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeInviteModal()">Abbrechen</button>
<button class="btn btn-success" onclick="sendInvite()">Einladung senden</button>
</div>
</div>
</div>

<!-- Modal: Rolle erstellen -->
<div class="modal" id="role-modal">
<div class="modal-content">
<div class="modal-header">
<div>
<h3>Neue Rolle erstellen</h3>
<p>Definieren Sie eine benutzerdefinierte Rolle mit spezifischen Zugriffsrechten.</p>
</div>
<button class="close-modal" onclick="closeRoleModal()">√ó</button>
</div>

<div class="form-group">
<label class="label">Rollenname</label>
<input type="text" class="input" placeholder="z.B. Controller, Teamleiter" id="role-name">
</div>

<div class="form-group">
<label class="label">Beschreibung</label>
<textarea class="input" rows="3" placeholder="Kurze Beschreibung der Rolle und ihrer Verantwortlichkeiten" id="role-description"></textarea>
</div>

<div class="form-group">
<label class="label">Berechtigungen f√ºr Module</label>
<div class="label-desc">Legen Sie fest, welche Zugriffslevel f√ºr jedes Modul gelten</div>
<div style="margin-top:16px">
<div class="permission-section">
<div class="permission-section-title">Cashflow-Management</div>
<div class="permission-level">
<input type="radio" name="perm-cashflow" id="perm-cashflow-none" value="none" checked>
<label for="perm-cashflow-none">Kein Zugriff</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-cashflow" id="perm-cashflow-read" value="read">
<label for="perm-cashflow-read">Lesen</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-cashflow" id="perm-cashflow-write" value="write">
<label for="perm-cashflow-write">Lesen & Bearbeiten</label>
</div>
</div>

<div class="permission-section">
<div class="permission-section-title">Forderungsmanagement</div>
<div class="permission-level">
<input type="radio" name="perm-forderungen" id="perm-forderungen-none" value="none" checked>
<label for="perm-forderungen-none">Kein Zugriff</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-forderungen" id="perm-forderungen-read" value="read">
<label for="perm-forderungen-read">Lesen</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-forderungen" id="perm-forderungen-write" value="write">
<label for="perm-forderungen-write">Lesen & Bearbeiten</label>
</div>
</div>

<div class="permission-section">
<div class="permission-section-title">Budgetplanung</div>
<div class="permission-level">
<input type="radio" name="perm-budget" id="perm-budget-none" value="none" checked>
<label for="perm-budget-none">Kein Zugriff</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-budget" id="perm-budget-read" value="read">
<label for="perm-budget-read">Lesen</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-budget" id="perm-budget-write" value="write">
<label for="perm-budget-write">Lesen & Bearbeiten</label>
</div>
</div>

<div class="permission-section">
<div class="permission-section-title">Reporting</div>
<div class="permission-level">
<input type="radio" name="perm-reporting" id="perm-reporting-none" value="none" checked>
<label for="perm-reporting-none">Kein Zugriff</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-reporting" id="perm-reporting-read" value="read">
<label for="perm-reporting-read">Lesen</label>
</div>
<div class="permission-level">
<input type="radio" name="perm-reporting" id="perm-reporting-write" value="write">
<label for="perm-reporting-write">Lesen & Exportieren</label>
</div>
</div>
</div>
</div>

<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeRoleModal()">Abbrechen</button>
<button class="btn btn-primary" onclick="createRole()">Rolle erstellen</button>
</div>
</div>
</div>

<script>
const API_BASE = '';
let currentUser = null;
let allUsers = [];
let allEntities = [];
let allPermissions = {};
let currentEntityId = null;
let isGeschaeftsfuehrer = false;
let managedEntities = [];

// Module definitions - corresponds to actual app modules (only business modules)
const MODULES = {
  dashboard: { label: 'Dashboard', icon: 'üìä', description: '√úbersicht und Zusammenfassung' },
  bankkonten: { label: 'Bankkonten', icon: 'üè¶', description: 'Kontost√§nde und Transaktionen', sensitive: true },
  zahlungen: { label: 'Zahlungen', icon: 'üí≥', description: 'Ein- und Auszahlungen verwalten' },
  forderungen: { label: 'Forderungen', icon: 'üìã', description: 'Offene Posten und Mahnwesen' },
  kosten: { label: 'Kosten', icon: 'üí∞', description: 'Ausgaben und Kostenarten' },
  liquiditat: { label: 'Liquidit√§t', icon: 'üìà', description: 'Cashflow und Prognosen' },
  vertrage: { label: 'Vertr√§ge', icon: 'üìÑ', description: 'Laufende Vertr√§ge verwalten' },
  kpis: { label: 'KPIs', icon: 'üéØ', description: 'Kennzahlen und Metriken' },
  reports: { label: 'Reports', icon: 'üìë', description: 'Berichte und Analysen' }
};

// Helper function to get managers of an entity (supports both old single manager and new multi-manager)
function getEntityManagers(entity) {
  if (!entity) return [];
  if (entity.managers && Array.isArray(entity.managers)) {
    return entity.managers;
  }
  if (entity.manager) {
    return [entity.manager];
  }
  return [];
}

// Check if user is manager of entity
function isManagerOf(entity, email) {
  return getEntityManagers(entity).includes(email);
}

// Initialize - execute immediately since we're loaded dynamically
(async function init() {
  console.log('=== Einstellungen page loaded ===');
  
  // Try both localStorage keys for compatibility
  let userData = localStorage.getItem('user') || localStorage.getItem('kontiq_user');
  console.log('Raw user data:', userData);
  
  if (!userData) {
    console.error('No user data in localStorage!');
    document.getElementById('users-tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#DC2626;padding:40px">Nicht angemeldet - bitte zuerst einloggen</td></tr>';
    return;
  }
  
  try {
    currentUser = JSON.parse(userData);
    console.log('Parsed user:', currentUser);
    
    if (!currentUser.email) {
      console.error('No email in user object');
      document.getElementById('users-tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#DC2626;padding:40px">Keine E-Mail gefunden</td></tr>';
      return;
    }
    
    // Load data
    await loadPermissionsData();
    
  } catch (error) {
    console.error('Error initializing:', error);
    document.getElementById('users-tbody').innerHTML = `<tr><td colspan="4" style="text-align:center;color:#DC2626;padding:40px">Fehler: ${error.message}</td></tr>`;
  }
})();

// Navigation
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    const section = item.getAttribute('data-section');
    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    item.classList.add('active');
    document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(section + '-section').classList.add('active');
  });
});

// Switch permission tabs
function switchPermTab(tab) {
  document.getElementById('tab-global').style.borderBottomColor = tab === 'global' ? '#0EB17A' : 'transparent';
  document.getElementById('tab-global').style.color = tab === 'global' ? '#0A2540' : '#6B7280';
  document.getElementById('tab-entities').style.borderBottomColor = tab === 'entities' ? '#0EB17A' : 'transparent';
  document.getElementById('tab-entities').style.color = tab === 'entities' ? '#0A2540' : '#6B7280';
  
  document.getElementById('global-perm-tab').style.display = tab === 'global' ? 'block' : 'none';
  document.getElementById('entities-perm-tab').style.display = tab === 'entities' ? 'block' : 'none';
}

// Load permissions data
async function loadPermissionsData() {
  console.log('=== loadPermissionsData called ===');
  console.log('Current user email:', currentUser.email);
  
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6B7280;padding:40px">Lade Daten...</td></tr>';
  
  try {
    // Load permissions
    const url = `/api/permissions/all?email=${encodeURIComponent(currentUser.email)}`;
    console.log('Fetching:', url);
    
    const permsRes = await fetch(url);
    console.log('Response status:', permsRes.status);
    
    if (!permsRes.ok) {
      throw new Error(`HTTP ${permsRes.status}: ${permsRes.statusText}`);
    }
    
    const data = await permsRes.json();
    console.log('API Response:', data);
    
    allUsers = data.users || [];
    allPermissions = data.entityPermissions || {};
    
    console.log('Users loaded:', allUsers.length);
    
    // Check if current user is Gesch√§ftsf√ºhrer
    const myPerms = allUsers.find(u => u.email === currentUser.email);
    isGeschaeftsfuehrer = myPerms?.globalPermissions?.role === 'geschaeftsfuehrer';
    console.log('Is Gesch√§ftsf√ºhrer:', isGeschaeftsfuehrer);
    
    // Update stats
    document.getElementById('stat-users').textContent = allUsers.length;
    
    // Populate table
    populateUsersTable();
    
    // Load entities - only for current user
    const entitiesRes = await fetch(`/api/entitaeten?email=${encodeURIComponent(currentUser.email)}`);
    if (entitiesRes.ok) {
      const entData = await entitiesRes.json();
      allEntities = entData.entitaeten || [];
      // Filter entities where current user is a manager (supports multi-manager)
      managedEntities = allEntities.filter(e => isManagerOf(e, currentUser.email));
      document.getElementById('stat-entities').textContent = allEntities.length;
      populateEntitiesList();
    }
    
  } catch (error) {
    console.error('Error loading data:', error);
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#DC2626;padding:40px">Fehler beim Laden: ${error.message}</td></tr>`;
  }
}

function populateUsersTable() {
  const tbody = document.getElementById('users-tbody');
  console.log('populateUsersTable called, allUsers:', allUsers);
  
  if (!tbody) {
    console.error('users-tbody not found!');
    return;
  }
  
  if (!allUsers || allUsers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6B7280;padding:40px">Keine Benutzer gefunden</td></tr>';
    return;
  }
  
  const html = allUsers.map(user => {
    const perms = user.globalPermissions;
    const isGF = perms?.role === 'geschaeftsfuehrer';
    const modulePerms = perms?.permissions || {};
    
    const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '?';
    
    // Build module access display - show real app modules only
    let moduleDisplay = '';
    if (isGF) {
      moduleDisplay = '<span class="badge badge-admin">Vollzugriff auf alle Module</span>';
    } else {
      const accessibleModules = Object.keys(modulePerms).filter(m => modulePerms[m]?.view || modulePerms[m]?.edit);
      if (accessibleModules.length === 0) {
        moduleDisplay = '<span style="color:#9CA3AF;font-size:13px">Kein Modulzugriff</span>';
      } else {
        moduleDisplay = accessibleModules.map(m => {
          const mod = MODULES[m];
          const canEdit = modulePerms[m]?.edit;
          return `<span style="font-size:11px;padding:2px 6px;border-radius:4px;margin:2px;display:inline-block;${canEdit ? 'background:#D1FAE5;color:#065F46' : 'background:#DBEAFE;color:#1E40AF'}">${mod?.icon || ''} ${mod?.label || m}</span>`;
        }).join('');
      }
    }
    
    // Build entity access display
    let entityDisplay = '';
    if (isGF) {
      entityDisplay = `<span style="color:#059669;font-size:13px">${allEntities.length} Entit√§t(en)</span>`;
    } else {
      // Count entities this user has access to
      const userEntities = [];
      Object.keys(allPermissions).forEach(entityId => {
        if (allPermissions[entityId] && allPermissions[entityId][user.email]) {
          const entity = allEntities.find(e => e.id === entityId);
          if (entity) userEntities.push(entity.name);
        }
      });
      entityDisplay = userEntities.length > 0 
        ? `<span style="color:#0A2540;font-size:13px">${userEntities.join(', ')}</span>`
        : '<span style="color:#9CA3AF;font-size:13px">Keine Entit√§ten</span>';
    }
    
    return `
      <tr>
        <td>
          <div class="user-row">
            <div class="user-avatar" style="background:${isGF ? '#059669' : '#6B7280'};color:white">${initials}</div>
            <div class="user-info">
              <div class="user-name">${user.name || 'Unbekannt'}${isGF ? ' üëë' : ''}</div>
              <div class="user-email">${user.email}</div>
            </div>
          </div>
        </td>
        <td style="max-width:300px">${moduleDisplay}</td>
        <td>${entityDisplay}</td>
        <td>
          <div class="actions">
            ${isGeschaeftsfuehrer && !isGF ? `
              <button class="btn btn-sm" style="background:#0EB17A;color:white" onclick="editUserPermissions('${user.email}')">
                üîê Rechte bearbeiten
              </button>
            ` : isGF ? '<span style="color:#059669;font-size:12px">Gesch√§ftsf√ºhrer</span>' : ''}
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  tbody.innerHTML = html;
}

function populateEntitiesList() {
  const container = document.getElementById('entities-access-container');
  if (!container) return;
  
  // If no entities exist, show message to create one first
  if (!allEntities || allEntities.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:60px 40px;background:#F9FAFB;border-radius:12px;border:2px dashed #E5E7EB">
        <div style="font-size:48px;margin-bottom:16px">üè¢</div>
        <h3 style="margin:0 0 8px 0;color:#0A2540">Keine Entit√§ten vorhanden</h3>
        <p style="color:#6B7280;margin:0 0 20px 0">Erstellen Sie zuerst eine Entit√§t im Men√º "Entit√§ten", um Zugriffsrechte vergeben zu k√∂nnen.</p>
        <button class="btn btn-primary" onclick="window.location.hash='entitaeten'">
          Zur Entit√§ten-Verwaltung
        </button>
      </div>
    `;
    return;
  }
  
  // Show entity access management with dropdown
  let html = `
    <div style="background:#F0FDF4;border:1px solid #BBF7D0;border-radius:12px;padding:16px;margin-bottom:24px">
      <div style="font-weight:600;color:#059669;margin-bottom:4px">üí° Zugriff verwalten</div>
      <div style="color:#065F46;font-size:14px">W√§hlen Sie eine Entit√§t aus und bestimmen Sie, welche Benutzer darauf zugreifen d√ºrfen.</div>
    </div>
    
    <div style="margin-bottom:24px">
      <label style="font-weight:600;font-size:14px;color:#0A2540;display:block;margin-bottom:8px">Entit√§t ausw√§hlen</label>
      <select id="entity-selector" class="select" onchange="loadEntityUsers()" style="width:100%;max-width:400px">
        <option value="">-- Entit√§t w√§hlen --</option>
        ${allEntities.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
      </select>
    </div>
    
    <div id="entity-users-section" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <h3 style="margin:0;font-size:16px;color:#0A2540" id="entity-users-title">Benutzer mit Zugriff</h3>
        <button class="btn btn-success btn-sm" onclick="openAddEntityUserModal()">+ Benutzer hinzuf√ºgen</button>
      </div>
      <div id="entity-users-list"></div>
    </div>
  `;
  
  container.innerHTML = html;
}

// Load users for selected entity
function loadEntityUsers() {
  const selector = document.getElementById('entity-selector');
  const section = document.getElementById('entity-users-section');
  const list = document.getElementById('entity-users-list');
  const title = document.getElementById('entity-users-title');
  
  const entityId = selector.value;
  if (!entityId) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  const entity = allEntities.find(e => e.id === entityId);
  title.textContent = `Benutzer mit Zugriff auf "${entity?.name || 'Entit√§t'}"`;
  
  // Build user list
  let usersHtml = '';
  
  // First: Show all managers/Gesch√§ftsf√ºhrer of this entity
  const entityManagers = getEntityManagers(entity);
  if (entityManagers.length > 0) {
    usersHtml += `<div style="font-weight:600;font-size:14px;color:#374151;margin-bottom:8px">üëë Gesch√§ftsf√ºhrer / Manager (${entityManagers.length})</div>`;
    entityManagers.forEach((managerEmail, idx) => {
      const managerUser = allUsers.find(u => u.email === managerEmail);
      usersHtml += `
        <div style="padding:12px;border:2px solid #0EB17A;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;background:#F0FDF4">
          <div>
            <div style="font-weight:600">${managerUser?.name || managerEmail}</div>
            <div style="font-size:12px;color:#059669">üëë Gesch√§ftsf√ºhrer - Vollzugriff</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span style="background:#059669;color:white;padding:4px 12px;border-radius:4px;font-size:12px;font-weight:600">Manager ${idx + 1}</span>
            ${entityManagers.length > 1 && isGeschaeftsfuehrer ? `<button class="btn btn-sm" style="background:#FEE2E2;color:#DC2626" onclick="removeManager('${entityId}', '${managerEmail}')">Entfernen</button>` : ''}
          </div>
        </div>
      `;
    });
    
    // Button to add another manager
    if (isGeschaeftsfuehrer) {
      usersHtml += `
        <button class="btn btn-sm btn-secondary" onclick="openAddManagerModal('${entityId}')" style="margin-bottom:16px">
          + Weiteren Gesch√§ftsf√ºhrer hinzuf√ºgen
        </button>
      `;
    }
  }
  
  // Divider
  usersHtml += `<div style="border-top:1px solid #E5E7EB;margin:16px 0;padding-top:16px"><div style="font-weight:600;font-size:14px;color:#374151;margin-bottom:8px">üë• Weitere Benutzer mit Zugriff</div></div>`;
  
  // Then: Other users with access (not managers)
  const entityPerms = allPermissions[entityId] || {};
  const otherUsers = Object.keys(entityPerms).filter(email => !entityManagers.includes(email));
  
  if (otherUsers.length === 0) {
    usersHtml += `<div style="text-align:center;padding:24px;color:#6B7280;border:1px dashed #E5E7EB;border-radius:8px">
      Noch keine weiteren Benutzer hinzugef√ºgt
    </div>`;
  } else {
    otherUsers.forEach(email => {
      const user = allUsers.find(u => u.email === email);
      const perms = entityPerms[email]?.permissions || {};
      const moduleIcons = Object.keys(perms).map(m => MODULES[m]?.icon || '').join(' ');
      
      usersHtml += `
        <div style="padding:12px;border:1px solid #E5E7EB;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div>
            <div style="font-weight:600">${user?.name || email}</div>
            <div style="font-size:12px;color:#6B7280">${moduleIcons || 'Zugriff konfiguriert'}</div>
          </div>
          <button class="btn btn-sm" style="background:#FEE2E2;color:#DC2626" onclick="removeEntityUser('${entityId}', '${email}')">Entfernen</button>
        </div>
      `;
    });
  }
  
  list.innerHTML = usersHtml;
}

// Open modal to add user to entity
function openAddEntityUserModal() {
  const entityId = document.getElementById('entity-selector').value;
  if (!entityId) return;
  
  const entity = allEntities.find(e => e.id === entityId);
  const entityPerms = allPermissions[entityId] || {};
  const entityManagers = getEntityManagers(entity);
  
  // Filter available users (not already in this entity and not a manager)
  const availableUsers = allUsers.filter(u => 
    !entityManagers.includes(u.email) && 
    !entityPerms[u.email] &&
    u.globalPermissions?.role !== 'geschaeftsfuehrer'
  );
  
  if (availableUsers.length === 0) {
    alert('Alle Benutzer haben bereits Zugriff auf diese Entit√§t oder es gibt keine weiteren Benutzer.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'add-entity-user-modal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:500px">
      <div class="modal-header">
        <h3>Benutzer zu "${entity?.name}" hinzuf√ºgen</h3>
        <button class="close-modal" onclick="closeAddEntityUserModal()">√ó</button>
      </div>
      
      <div class="form-group">
        <label class="label">Benutzer ausw√§hlen</label>
        <select class="select" id="add-entity-user-select">
          <option value="">-- Benutzer w√§hlen --</option>
          ${availableUsers.map(u => `<option value="${u.email}">${u.name || u.email}</option>`).join('')}
        </select>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddEntityUserModal()">Abbrechen</button>
        <button class="btn btn-success" onclick="addUserToEntity('${entityId}')">Hinzuf√ºgen</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeAddEntityUserModal() {
  const modal = document.getElementById('add-entity-user-modal');
  if (modal) modal.remove();
}

async function addUserToEntity(entityId) {
  const select = document.getElementById('add-entity-user-select');
  const userEmail = select?.value;
  if (!userEmail) {
    alert('Bitte w√§hlen Sie einen Benutzer aus');
    return;
  }
  
  try {
    const res = await fetch('/api/permissions/entity', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        adminEmail: currentUser.email,
        entityId: entityId,
        targetEmail: userEmail,
        permissions: { permissions: { view: true } }
      })
    });
    
    if (res.ok) {
      closeAddEntityUserModal();
      await loadPermissionsData();
      document.getElementById('entity-selector').value = entityId;
      loadEntityUsers();
    } else {
      const err = await res.json();
      alert('Fehler: ' + (err.error || 'Unbekannter Fehler'));
    }
  } catch (error) {
    alert('Fehler: ' + error.message);
  }
}

// Toggle Switch
function toggleSwitch(element) {
  element.classList.toggle('active');
}

// Modals
function openInviteModal() {
  document.getElementById('invite-modal').classList.add('active');
  
  // Generate module checkboxes dynamically
  const container = document.getElementById('invite-modules-container');
  if (container) {
    let html = '';
    
    Object.keys(MODULES).forEach(moduleKey => {
      const module = MODULES[moduleKey];
      const isSensitive = module.sensitive === true;
      
      html += `
        <label class="checkbox-item" style="${isSensitive ? 'border-color:#F59E0B;background:#FFFBEB' : ''}">
          <input type="checkbox" id="invite-module-${moduleKey}" data-module="${moduleKey}">
          <div style="flex:1">
            <div class="checkbox-label">${module.icon} ${module.label} ${isSensitive ? '<span style="font-size:10px;background:#F59E0B;color:white;padding:1px 6px;border-radius:4px;margin-left:6px">SENSIBEL</span>' : ''}</div>
            <div class="checkbox-desc">${module.description || ''}</div>
          </div>
        </label>
      `;
    });
    
    container.innerHTML = html;
  }
}

function closeInviteModal() {
  document.getElementById('invite-modal').classList.remove('active');
}

function openRoleModal() {
  document.getElementById('role-modal').classList.add('active');
}

function closeRoleModal() {
  document.getElementById('role-modal').classList.remove('active');
}

// Invite user WITH module permissions selected in modal
async function sendInvite() {
  const email = document.getElementById('invite-email').value.trim();
  const firstname = document.getElementById('invite-firstname').value.trim();
  const lastname = document.getElementById('invite-lastname').value.trim();

  if (!email || !firstname || !lastname) {
    alert('Bitte f√ºllen Sie alle Pflichtfelder aus');
    return;
  }

  if (!isGeschaeftsfuehrer) {
    alert('Nur der Gesch√§ftsf√ºhrer kann Benutzer einladen');
    return;
  }

  // Collect selected module permissions
  const permissions = {};
  Object.keys(MODULES).forEach(moduleKey => {
    const checkbox = document.getElementById(`invite-module-${moduleKey}`);
    if (checkbox && checkbox.checked) {
      permissions[moduleKey] = { view: true, edit: false };
    }
  });

  try {
    // Create user with selected permissions
    const res = await fetch(`${API_BASE}/api/users/invite`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        adminEmail: currentUser.email,
        targetEmail: email,
        firstName: firstname,
        lastName: lastname,
        permissions: permissions
      })
    });

    if (res.ok) {
      const moduleCount = Object.keys(permissions).length;
      alert(`Benutzer ${email} wurde erstellt${moduleCount > 0 ? ` mit Zugriff auf ${moduleCount} Module` : ''}.\n\nSie k√∂nnen die Berechtigungen jederzeit √ºber "üîê Rechte bearbeiten" anpassen.`);
      closeInviteModal();
      document.getElementById('invite-email').value = '';
      document.getElementById('invite-firstname').value = '';
      document.getElementById('invite-lastname').value = '';
      loadPermissionsData();
    } else {
      const error = await res.json();
      alert('Fehler: ' + (error.error || 'Benutzer konnte nicht erstellt werden'));
    }
  } catch (error) {
    console.error('Error inviting user:', error);
    alert('Fehler beim Erstellen des Benutzers: ' + error.message);
  }
}

function createRole() {
  const name = document.getElementById('role-name').value;
  const description = document.getElementById('role-description').value;
  if (!name || !description) {
    alert('Bitte f√ºllen Sie alle Felder aus');
    return;
  }
  alert('Rolle "' + name + '" wurde erfolgreich erstellt');
  closeRoleModal();
}

// Edit user permissions - GF defines everything manually
function editUserPermissions(email) {
  if (!isGeschaeftsfuehrer) {
    alert('Nur der Gesch√§ftsf√ºhrer kann globale Berechtigungen definieren.');
    return;
  }
  
  const user = allUsers.find(u => u.email === email);
  if (!user) return;
  
  const perms = user.globalPermissions?.permissions || {};
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'edit-perms-modal';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width:800px">
      <div class="modal-header">
        <div>
          <h3>üîê Berechtigungen f√ºr ${user.name}</h3>
          <p>${user.email}</p>
        </div>
        <button class="close-modal" onclick="closeEditPermsModal()">√ó</button>
      </div>
      
      <div class="alert alert-warning" style="margin-bottom:20px">
        <div>
          <div class="alert-title">Sie definieren die Berechtigungen</div>
          <div class="alert-message">W√§hlen Sie genau aus, welche Module dieser Benutzer sehen und bearbeiten darf. Keine automatischen Rechte werden vergeben.</div>
        </div>
      </div>
      
      <div class="form-group" id="perms-container-edit">
        <label class="label">Module-Berechtigungen</label>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:16px">
          ${Object.keys(MODULES).map(moduleKey => {
            const module = MODULES[moduleKey];
            const modulePerm = perms[moduleKey] || {};
            const isSensitive = module.sensitive === true;
            return `
              <div style="border:${isSensitive ? '2px solid #F59E0B' : '1px solid #E5E7EB'};border-radius:12px;padding:16px;${isSensitive ? 'background:#FFFBEB' : ''}">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                  <div style="font-weight:600;font-size:15px">${module.icon} ${module.label}</div>
                  ${isSensitive ? '<span style="font-size:10px;background:#F59E0B;color:white;padding:2px 6px;border-radius:4px;font-weight:600">SENSIBEL</span>' : ''}
                </div>
                <div style="font-size:12px;color:#6B7280;margin-bottom:12px">${module.description || ''}</div>
                <div style="display:flex;gap:16px">
                  <label style="display:flex;align-items:center;gap:6px;font-size:14px;cursor:pointer">
                    <input type="checkbox" id="edit-${moduleKey}-view" ${modulePerm.view ? 'checked' : ''} style="accent-color:#0EB17A;width:18px;height:18px">
                    üëÅÔ∏è Ansehen
                  </label>
                  <label style="display:flex;align-items:center;gap:6px;font-size:14px;cursor:pointer">
                    <input type="checkbox" id="edit-${moduleKey}-edit" ${modulePerm.edit ? 'checked' : ''} style="accent-color:#0EB17A;width:18px;height:18px">
                    ‚úèÔ∏è Bearbeiten
                  </label>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditPermsModal()">Abbrechen</button>
        <button class="btn btn-success" onclick="saveUserPermissions('${email}')">Speichern</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

async function saveUserPermissions(email) {
  const permissions = { permissions: {} };
  
  Object.keys(MODULES).forEach(moduleKey => {
    const view = document.getElementById(`edit-${moduleKey}-view`)?.checked || false;
    const edit = document.getElementById(`edit-${moduleKey}-edit`)?.checked || false;
    
    if (view || edit) {
      permissions.permissions[moduleKey] = { view, edit };
    }
  });
  
  try {
    const res = await fetch(`${API_BASE}/api/permissions/global`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        adminEmail: currentUser.email,
        targetEmail: email,
        permissions
      })
    });
    
    if (res.ok) {
      alert('Berechtigungen erfolgreich gespeichert');
      closeEditPermsModal();
      loadPermissionsData();
    } else {
      const error = await res.json();
      alert('Fehler: ' + (error.error || 'Unbekannter Fehler'));
    }
  } catch (error) {
    console.error('Error saving permissions:', error);
    alert('Fehler beim Speichern der Berechtigungen');
  }
}

function closeEditPermsModal() {
  const modal = document.getElementById('edit-perms-modal');
  if (modal) modal.remove();
}

// Entity permissions - Manager can define for their entity
function openEntityPermissions(entityId) {
  currentEntityId = entityId;
  const entity = allEntities.find(e => e.id === entityId);
  if (!entity) return;
  
  const entityManagers = getEntityManagers(entity);
  const isManager = isManagerOf(entity, currentUser.email);
  if (!isGeschaeftsfuehrer && !isManager) {
    alert('Sie haben keine Berechtigung, diese Entit√§t zu verwalten.');
    return;
  }
  
  const entityPerms = allPermissions[entityId] || {};
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'entity-perms-modal';
  
  // Build users list - All managers first, then other users
  let usersHtml = '';
  
  // First: Show all entity managers/Gesch√§ftsf√ºhrer
  if (entityManagers.length > 0) {
    usersHtml += `<div style="font-weight:600;font-size:14px;color:#374151;margin-bottom:8px">üëë Gesch√§ftsf√ºhrer (${entityManagers.length})</div>`;
    entityManagers.forEach((managerEmail, idx) => {
      const managerUser = allUsers.find(u => u.email === managerEmail);
      usersHtml += `
        <div style="padding:12px;border:2px solid #0EB17A;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;background:#F0FDF4">
          <div>
            <div style="font-weight:600">${managerUser?.name || managerEmail}</div>
            <div style="font-size:12px;color:#059669">üëë Gesch√§ftsf√ºhrer - Vollzugriff</div>
          </div>
          <span class="badge badge-admin" style="background:#059669;color:white">Manager ${idx + 1}</span>
        </div>
      `;
    });
  }
  
  // Then: Other users with access (not managers)
  Object.keys(entityPerms).forEach(userEmail => {
    // Skip if this is one of the managers (already shown above)
    if (entityManagers.includes(userEmail)) return;
    
    const user = allUsers.find(u => u.email === userEmail);
    const perms = entityPerms[userEmail].permissions || {};
    const permIcons = Object.keys(perms).map(m => MODULES[m]?.icon || m).join(' ');
    
    usersHtml += `
      <div style="padding:12px;border:1px solid #E5E7EB;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div style="font-weight:600">${user?.name || userEmail}</div>
          <div style="font-size:12px;color:#6B7280">${permIcons || 'Keine Module'}</div>
        </div>
        <button class="btn btn-sm" style="background:#FEE2E2;color:#DC2626" onclick="removeEntityUser('${entityId}', '${userEmail}')">Entfernen</button>
      </div>
    `;
  });
  
  // Count non-manager users
  const otherUsersCount = Object.keys(entityPerms).filter(e => !entityManagers.includes(e)).length;
  if (otherUsersCount === 0 && entityManagers.length > 0) {
    usersHtml += '<div style="color:#6B7280;text-align:center;padding:20px;border:1px dashed #E5E7EB;border-radius:8px;margin-top:8px">Noch keine weiteren Benutzer hinzugef√ºgt</div>';
  } else if (entityManagers.length === 0 && Object.keys(entityPerms).length === 0) {
    usersHtml = '<div style="color:#6B7280;text-align:center;padding:20px">Keine Benutzer haben Zugriff auf diese Entit√§t</div>';
  }
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width:700px">
      <div class="modal-header">
        <div>
          <h3>üë• ${entity.name}</h3>
          <p>${isManager ? 'Sie sind Manager dieser Entit√§t' : 'Gesch√§ftsf√ºhrer-Zugriff'}</p>
        </div>
        <button class="close-modal" onclick="closeEntityPermsModal()">√ó</button>
      </div>
      
      <div class="alert alert-info" style="margin-bottom:20px">
        <div>
          <div class="alert-title">Entit√§ts-Berechtigungen</div>
          <div class="alert-message">${isManager ? 'Als Manager k√∂nnen Sie festlegen, wer Zugriff auf diese Entit√§t hat und was sie sehen/bearbeiten d√ºrfen.' : 'Sie k√∂nnen festlegen, wer Zugriff auf diese Entit√§t hat.'}</div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">Benutzer mit Zugriff</div>
        <div id="entity-users-list">${usersHtml}</div>
      </div>
      
      <div class="divider"></div>
      
      <div class="section">
        <div class="section-title">Benutzer hinzuf√ºgen</div>
        <div class="form-group">
          <label class="label">Benutzer w√§hlen</label>
          <select class="select" id="entity-add-user">
            <option value="">Benutzer ausw√§hlen...</option>
            ${allUsers.filter(u => !entityPerms[u.email] && !entityManagers.includes(u.email) && u.globalPermissions?.role !== 'geschaeftsfuehrer').map(u => `
              <option value="${u.email}">${u.name || u.email}</option>
            `).join('')}
          </select>
        </div>
        
        <div class="form-group" id="entity-user-perms" style="display:none">
          <label class="label">Module-Berechtigungen f√ºr diese Entit√§t</label>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px">
            ${Object.keys(MODULES).map(moduleKey => {
              const module = MODULES[moduleKey];
              return `
                <div style="border:1px solid #E5E7EB;border-radius:8px;padding:12px">
                  <div style="font-weight:600;font-size:14px;margin-bottom:8px">${module.icon} ${module.label}</div>
                  <div style="display:flex;gap:12px">
                    <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer">
                      <input type="checkbox" id="entity-${moduleKey}-view" style="accent-color:#0EB17A">
                      üëÅÔ∏è Ansehen
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer">
                      <input type="checkbox" id="entity-${moduleKey}-edit" style="accent-color:#0EB17A">
                      ‚úèÔ∏è Bearbeiten
                    </label>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          <button class="btn btn-success" style="margin-top:16px;width:100%" onclick="addUserToEntity()">Benutzer hinzuf√ºgen</button>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEntityPermsModal()">Schlie√üen</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Show permissions when user is selected
  document.getElementById('entity-add-user').addEventListener('change', function() {
    document.getElementById('entity-user-perms').style.display = this.value ? 'block' : 'none';
  });
}

async function addUserToEntity() {
  const userEmail = document.getElementById('entity-add-user').value;
  if (!userEmail) {
    alert('Bitte w√§hlen Sie einen Benutzer aus');
    return;
  }
  
  const permissions = { permissions: {} };
  
  Object.keys(MODULES).forEach(moduleKey => {
    const view = document.getElementById(`entity-${moduleKey}-view`)?.checked || false;
    const edit = document.getElementById(`entity-${moduleKey}-edit`)?.checked || false;
    
    if (view || edit) {
      permissions.permissions[moduleKey] = { view, edit };
    }
  });
  
  try {
    const res = await fetch(`${API_BASE}/api/permissions/entity`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        adminEmail: currentUser.email,
        entityId: currentEntityId,
        targetEmail: userEmail,
        permissions
      })
    });
    
    if (res.ok) {
      alert('Benutzer erfolgreich hinzugef√ºgt');
      closeEntityPermsModal();
      loadPermissionsData();
    } else {
      const error = await res.json();
      alert('Fehler: ' + (error.error || 'Unbekannter Fehler'));
    }
  } catch (error) {
    console.error('Error adding user to entity:', error);
    alert('Fehler beim Hinzuf√ºgen des Benutzers');
  }
}

async function removeEntityUser(entityId, userEmail) {
  if (!confirm(`M√∂chten Sie den Zugriff f√ºr diesen Benutzer wirklich entfernen?`)) return;
  
  try {
    const res = await fetch(`${API_BASE}/api/permissions/entity/${userEmail}?adminEmail=${currentUser.email}&entityId=${entityId}`, {
      method: 'DELETE'
    });
    
    if (res.ok) {
      await loadPermissionsData();
      // Reload entity users list
      document.getElementById('entity-selector').value = entityId;
      loadEntityUsers();
    } else {
      const error = await res.json();
      alert('Fehler: ' + (error.error || 'Unbekannter Fehler'));
    }
  } catch (error) {
    console.error('Error removing entity user:', error);
  }
}

// Open modal to add another manager/Gesch√§ftsf√ºhrer to an entity
function openAddManagerModal(entityId) {
  if (!isGeschaeftsfuehrer) {
    alert('Nur der Gesch√§ftsf√ºhrer kann weitere Manager hinzuf√ºgen.');
    return;
  }
  
  const entity = allEntities.find(e => e.id === entityId);
  if (!entity) return;
  
  const entityManagers = getEntityManagers(entity);
  
  // Filter available users (not already a manager of this entity)
  const availableUsers = allUsers.filter(u => 
    !entityManagers.includes(u.email)
  );
  
  if (availableUsers.length === 0) {
    alert('Alle Benutzer sind bereits Manager dieser Entit√§t.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'add-manager-modal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:500px">
      <div class="modal-header">
        <div>
          <h3>üëë Gesch√§ftsf√ºhrer hinzuf√ºgen</h3>
          <p>F√ºgen Sie einen weiteren Gesch√§ftsf√ºhrer zu "${entity.name}" hinzu</p>
        </div>
        <button class="close-modal" onclick="closeAddManagerModal()">√ó</button>
      </div>
      
      <div class="alert alert-info" style="margin-bottom:20px">
        <div>
          <div class="alert-title">Gesch√§ftsf√ºhrer-Rechte</div>
          <div class="alert-message">Der neue Gesch√§ftsf√ºhrer erh√§lt Vollzugriff auf diese Entit√§t und kann selbst Benutzerrechte vergeben.</div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="label">Benutzer ausw√§hlen</label>
        <select class="select" id="add-manager-select">
          <option value="">-- Benutzer w√§hlen --</option>
          ${availableUsers.map(u => `<option value="${u.email}">${u.name || u.email}</option>`).join('')}
        </select>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddManagerModal()">Abbrechen</button>
        <button class="btn btn-success" onclick="addManagerToEntity('${entityId}')">Als Gesch√§ftsf√ºhrer hinzuf√ºgen</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeAddManagerModal() {
  const modal = document.getElementById('add-manager-modal');
  if (modal) modal.remove();
}

async function addManagerToEntity(entityId) {
  const select = document.getElementById('add-manager-select');
  const userEmail = select?.value;
  if (!userEmail) {
    alert('Bitte w√§hlen Sie einen Benutzer aus');
    return;
  }
  
  try {
    const entity = allEntities.find(e => e.id === entityId);
    const currentManagers = getEntityManagers(entity);
    const newManagers = [...currentManagers, userEmail];
    
    const res = await fetch(`${API_BASE}/api/entitaeten/${entityId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        managers: newManagers
      })
    });
    
    if (res.ok) {
      alert('Gesch√§ftsf√ºhrer erfolgreich hinzugef√ºgt');
      closeAddManagerModal();
      await loadPermissionsData();
      document.getElementById('entity-selector').value = entityId;
      loadEntityUsers();
    } else {
      const error = await res.json();
      alert('Fehler: ' + (error.error || 'Unbekannter Fehler'));
    }
  } catch (error) {
    console.error('Error adding manager:', error);
    alert('Fehler beim Hinzuf√ºgen des Gesch√§ftsf√ºhrers');
  }
}

async function removeManager(entityId, managerEmail) {
  const entity = allEntities.find(e => e.id === entityId);
  const currentManagers = getEntityManagers(entity);
  
  if (currentManagers.length <= 1) {
    alert('Eine Entit√§t muss mindestens einen Gesch√§ftsf√ºhrer haben.');
    return;
  }
  
  if (!confirm(`M√∂chten Sie diesen Gesch√§ftsf√ºhrer wirklich entfernen?`)) return;
  
  try {
    const newManagers = currentManagers.filter(m => m !== managerEmail);
    
    const res = await fetch(`${API_BASE}/api/entitaeten/${entityId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        managers: newManagers
      })
    });
    
    if (res.ok) {
      await loadPermissionsData();
      document.getElementById('entity-selector').value = entityId;
      loadEntityUsers();
    } else {
      const error = await res.json();
      alert('Fehler: ' + (error.error || 'Unbekannter Fehler'));
    }
  } catch (error) {
    console.error('Error removing manager:', error);
  }
}

function closeEntityPermsModal() {
  const modal = document.getElementById('entity-perms-modal');
  if (modal) modal.remove();
  currentEntityId = null;
}

// Create entity modal
function openCreateEntityModal() {
  if (!isGeschaeftsfuehrer) {
    alert('Nur der Gesch√§ftsf√ºhrer kann Entit√§ten erstellen.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'create-entity-modal';
  
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h3>üè¢ Neue Entit√§t erstellen</h3>
          <p>Erstellen Sie eine Gesch√§ftseinheit oder Filiale</p>
        </div>
        <button class="close-modal" onclick="closeCreateEntityModal()">√ó</button>
      </div>
      
      <div class="form-group">
        <label class="label">Name der Entit√§t</label>
        <input type="text" class="input" id="new-entity-name" placeholder="z.B. Filiale Berlin">
      </div>
      
      <div class="form-group">
        <label class="label">Manager (kann Berechtigungen f√ºr diese Entit√§t vergeben)</label>
        <select class="select" id="new-entity-manager">
          <option value="">Kein Manager</option>
          ${allUsers.filter(u => u.globalPermissions?.role !== 'geschaeftsfuehrer').map(u => `
            <option value="${u.email}">${u.name || u.email}</option>
          `).join('')}
        </select>
      </div>
      
      <div class="alert alert-info">
        <div>
          <div class="alert-title">üí° Manager-Rechte</div>
          <div class="alert-message">Der Manager kann selbst entscheiden, wer Zugriff auf diese Entit√§t hat und welche Module die eingeladenen Benutzer sehen/bearbeiten d√ºrfen.</div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCreateEntityModal()">Abbrechen</button>
        <button class="btn btn-success" onclick="createEntity()">Erstellen</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

async function createEntity() {
  const name = document.getElementById('new-entity-name').value.trim();
  const manager = document.getElementById('new-entity-manager').value;
  
  if (!name) {
    alert('Bitte geben Sie einen Namen ein');
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/api/entitaeten`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, manager, type: 'standard' })
    });
    
    if (res.ok) {
      alert('Entit√§t erfolgreich erstellt');
      closeCreateEntityModal();
      loadPermissionsData();
    } else {
      const error = await res.json();
      alert('Fehler: ' + (error.error || 'Unbekannter Fehler'));
    }
  } catch (error) {
    console.error('Error creating entity:', error);
    alert('Fehler beim Erstellen der Entit√§t');
  }
}

function closeCreateEntityModal() {
  const modal = document.getElementById('create-entity-modal');
  if (modal) modal.remove();
}

async function deleteEntity(entityId) {
  if (!confirm('M√∂chten Sie diese Entit√§t wirklich l√∂schen? Alle Berechtigungen werden entfernt.')) return;
  
  try {
    const res = await fetch(`${API_BASE}/api/entitaeten/${entityId}`, {
      method: 'DELETE'
    });
    
    if (res.ok) {
      alert('Entit√§t gel√∂scht');
      loadPermissionsData();
    } else {
      const error = await res.json();
      alert('Fehler: ' + (error.error || 'Unbekannter Fehler'));
    }
  } catch (error) {
    console.error('Error deleting entity:', error);
  }
}

function removeUser(id) {
  if (confirm('M√∂chten Sie diesen Benutzer wirklich entfernen?')) {
    alert('Benutzer entfernt');
  }
}

function resendInvite(id) {
  alert('Einladung wurde erneut gesendet');
}

// Close modals on outside click
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    e.target.remove();
  }
});

// Close modals on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal').forEach(modal => modal.remove());
  }
});
</script>
</body>
</html>