<style>
.e-rechnung-view {
  padding: 24px;
  max-width: 1200px;
  margin: 0 auto;
}

.page-header {
  margin-bottom: 32px;
}

.page-title {
  font-size: 28px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 8px;
}

.page-subtitle {
  color: var(--gray);
  font-size: 15px;
}

.invoice-form {
  background: white;
  border-radius: 12px;
  padding: 32px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  margin-bottom: 24px;
}

.form-section {
  margin-bottom: 32px;
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 16px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--navy);
  margin-bottom: 6px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid var(--light-gray);
  border-radius: 8px;
  font-size: 14px;
  font-family: 'Inter', sans-serif;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--teal);
  box-shadow: 0 0 0 3px rgba(14, 177, 122, 0.1);
}

.form-textarea {
  min-height: 80px;
  resize: vertical;
}

.items-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
}

.items-table th {
  background: var(--light-gray);
  padding: 12px;
  text-align: left;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--navy);
}

.items-table td {
  padding: 12px;
  border-bottom: 1px solid var(--light-gray);
}

.items-table input {
  width: 100%;
  padding: 8px;
  border: 1px solid var(--light-gray);
  border-radius: 6px;
  font-size: 14px;
}

.btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s;
}

.btn-primary {
  background: var(--teal);
  color: white;
}

.btn-primary:hover {
  background: #0C9F6D;
  transform: translateY(-1px);
}

.btn-secondary {
  background: white;
  color: var(--navy);
  border: 1px solid var(--light-gray);
}

.btn-secondary:hover {
  background: var(--light-gray);
}

.btn-danger {
  background: #EF4444;
  color: white;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}

.totals-section {
  background: var(--light-gray);
  padding: 20px;
  border-radius: 8px;
  margin-top: 16px;
}

.total-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 15px;
}

.total-row.final {
  font-size: 20px;
  font-weight: 700;
  color: var(--navy);
  padding-top: 12px;
  border-top: 2px solid var(--border-gray);
  margin-top: 12px;
}

.invoice-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}
</style>

<div class="e-rechnung-view">
  <div class="page-header">
    <h1 class="page-title">E-Rechnung erstellen</h1>
    <p class="page-subtitle">Erstellen Sie XRechnung-konforme elektronische Rechnungen</p>
  </div>

  <div class="invoice-form">
    <!-- Client Selection -->
    <div class="form-section">
      <h2 class="section-title">Kunde</h2>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Kunde auswählen</label>
          <select id="client-select" class="form-select">
            <option value="">-- Kunde wählen --</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Fälligkeitsdatum</label>
          <input type="date" id="due-date" class="form-input" />
        </div>
      </div>
      <div style="margin-top: 12px;">
        <button class="btn btn-secondary btn-sm" onclick="openNewClientModal()">+ Neuer Kunde</button>
      </div>
    </div>

    <!-- Invoice Details -->
    <div class="form-section">
      <h2 class="section-title">Rechnungsdetails</h2>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Rechnungsnummer</label>
          <input type="text" id="invoice-number" class="form-input" placeholder="Automatisch generiert" />
        </div>
        <div class="form-group">
          <label class="form-label">Rechnungsdatum</label>
          <input type="date" id="invoice-date" class="form-input" />
        </div>
      </div>
    </div>

    <!-- Line Items -->
    <div class="form-section">
      <h2 class="section-title">Positionen</h2>
      <table class="items-table">
        <thead>
          <tr>
            <th style="width: 40%">Beschreibung</th>
            <th style="width: 15%">Menge</th>
            <th style="width: 15%">Preis</th>
            <th style="width: 15%">MwSt. %</th>
            <th style="width: 15%">Gesamt</th>
            <th style="width: 50px"></th>
          </tr>
        </thead>
        <tbody id="items-tbody">
          <tr data-row="0">
            <td><input type="text" class="item-description" placeholder="Beschreibung" /></td>
            <td><input type="number" class="item-quantity" value="1" min="0" step="0.01" /></td>
            <td><input type="number" class="item-price" value="0" min="0" step="0.01" /></td>
            <td><input type="number" class="item-vat" value="19" min="0" max="100" step="0.1" /></td>
            <td><span class="item-total">€0.00</span></td>
            <td></td>
          </tr>
        </tbody>
      </table>
      <button class="btn btn-secondary btn-sm" onclick="addInvoiceItem()" style="margin-top: 12px;">+ Position hinzufügen</button>
    </div>

    <!-- Totals -->
    <div class="totals-section">
      <div class="total-row">
        <span>Zwischensumme:</span>
        <span id="subtotal">€0.00</span>
      </div>
      <div class="total-row">
        <span>MwSt.:</span>
        <span id="total-vat">€0.00</span>
      </div>
      <div class="total-row final">
        <span>Gesamt:</span>
        <span id="total">€0.00</span>
      </div>
    </div>

    <!-- Notes -->
    <div class="form-section">
      <h2 class="section-title">Notizen</h2>
      <div class="form-group">
        <label class="form-label">Zusätzliche Informationen</label>
        <textarea id="notes" class="form-textarea" placeholder="Zahlungsbedingungen, Hinweise, etc."></textarea>
      </div>
    </div>

    <!-- Actions -->
    <div class="invoice-actions">
      <button class="btn btn-primary" onclick="saveInvoice()">Rechnung speichern</button>
      <button class="btn btn-primary" onclick="saveAndSendInvoice()">Speichern & Versenden</button>
      <button class="btn btn-secondary" onclick="navigateTo('forderungen')">Abbrechen</button>
    </div>
  </div>
</div>

<!-- New Client Modal -->
<div id="new-client-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%;">
    <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 24px; color: var(--navy);">Neuer Kunde</h2>

    <div class="form-group">
      <label class="form-label">Name*</label>
      <input type="text" id="new-client-name" class="form-input" />
    </div>

    <div class="form-group">
      <label class="form-label">E-Mail*</label>
      <input type="email" id="new-client-email" class="form-input" />
    </div>

    <div class="form-group">
      <label class="form-label">Adresse</label>
      <textarea id="new-client-address" class="form-textarea"></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">Steuernummer</label>
      <input type="text" id="new-client-taxid" class="form-input" />
    </div>

    <div style="display: flex; gap: 12px; margin-top: 24px;">
      <button class="btn btn-primary" onclick="saveNewClient()">Kunde erstellen</button>
      <button class="btn btn-secondary" onclick="closeNewClientModal()">Abbrechen</button>
    </div>
  </div>
</div>

<script>
let currentClients = [];
let itemCounter = 1;

// Load clients on page load
async function loadClients() {
  try {
    const token = localStorage.getItem('kontiq_token');
    const res = await fetch('/api/clients', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    currentClients = data.clients || [];

    const select = document.getElementById('client-select');
    select.innerHTML = '<option value="">-- Kunde wählen --</option>';
    currentClients.forEach(client => {
      const option = document.createElement('option');
      option.value = client.id;
      option.textContent = `${client.name} (${client.email})`;
      select.appendChild(option);
    });
  } catch (err) {
    console.error('Error loading clients:', err);
  }
}

// Set default dates
document.getElementById('invoice-date').valueAsDate = new Date();
const dueDate = new Date();
dueDate.setDate(dueDate.getDate() + 30);
document.getElementById('due-date').valueAsDate = dueDate;

// Calculate totals
function calculateTotals() {
  let subtotal = 0;
  let totalVat = 0;

  document.querySelectorAll('#items-tbody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.item-quantity').value) || 0;
    const price = parseFloat(row.querySelector('.item-price').value) || 0;
    const vatRate = parseFloat(row.querySelector('.item-vat').value) || 0;

    const amount = qty * price;
    const vat = amount * (vatRate / 100);

    subtotal += amount;
    totalVat += vat;

    row.querySelector('.item-total').textContent = `€${(amount + vat).toFixed(2)}`;
  });

  const total = subtotal + totalVat;

  document.getElementById('subtotal').textContent = `€${subtotal.toFixed(2)}`;
  document.getElementById('total-vat').textContent = `€${totalVat.toFixed(2)}`;
  document.getElementById('total').textContent = `€${total.toFixed(2)}`;
}

// Add new item row
function addInvoiceItem() {
  const tbody = document.getElementById('items-tbody');
  const row = document.createElement('tr');
  row.setAttribute('data-row', itemCounter);
  row.innerHTML = `
    <td><input type="text" class="item-description" placeholder="Beschreibung" /></td>
    <td><input type="number" class="item-quantity" value="1" min="0" step="0.01" /></td>
    <td><input type="number" class="item-price" value="0" min="0" step="0.01" /></td>
    <td><input type="number" class="item-vat" value="19" min="0" max="100" step="0.1" /></td>
    <td><span class="item-total">€0.00</span></td>
    <td><button class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)">×</button></td>
  `;
  tbody.appendChild(row);
  itemCounter++;

  // Add event listeners
  row.querySelectorAll('input').forEach(input => {
    input.addEventListener('input', calculateTotals);
  });
}

// Remove item row
function removeInvoiceItem(btn) {
  btn.closest('tr').remove();
  calculateTotals();
}

// Save invoice
async function saveInvoice(sendAfter = false) {
  const clientId = document.getElementById('client-select').value;
  if (!clientId) {
    alert('Bitte wählen Sie einen Kunden aus');
    return;
  }

  // Collect items
  const items = [];
  document.querySelectorAll('#items-tbody tr').forEach(row => {
    const description = row.querySelector('.item-description').value;
    if (!description) return;

    items.push({
      description,
      quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
      price: parseFloat(row.querySelector('.item-price').value) || 0,
      vatRate: parseFloat(row.querySelector('.item-vat').value) || 0
    });
  });

  if (items.length === 0) {
    alert('Bitte fügen Sie mindestens eine Position hinzu');
    return;
  }

  const invoiceData = {
    clientId,
    items,
    dueDate: document.getElementById('due-date').value,
    notes: document.getElementById('notes').value,
    invoiceNumber: document.getElementById('invoice-number').value || undefined
  };

  try {
    const token = localStorage.getItem('kontiq_token');
    const res = await fetch('/api/invoices', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(invoiceData)
    });

    const data = await res.json();

    if (res.ok) {
      if (sendAfter) {
        // Send invoice
        const sendRes = await fetch(`/api/invoices/${data.invoice.id}/send`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (sendRes.ok) {
          alert(`Rechnung ${data.invoice.invoiceNumber} wurde erstellt und versendet!`);
        }
      } else {
        alert(`Rechnung ${data.invoice.invoiceNumber} wurde gespeichert!`);
      }
      navigateTo('forderungen');
    } else {
      alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
    }
  } catch (err) {
    console.error('Error saving invoice:', err);
    alert('Fehler beim Speichern der Rechnung');
  }
}

function saveAndSendInvoice() {
  saveInvoice(true);
}

// Client modal
function openNewClientModal() {
  document.getElementById('new-client-modal').style.display = 'flex';
}

function closeNewClientModal() {
  document.getElementById('new-client-modal').style.display = 'none';
}

async function saveNewClient() {
  const name = document.getElementById('new-client-name').value;
  const email = document.getElementById('new-client-email').value;

  if (!name || !email) {
    alert('Name und E-Mail sind erforderlich');
    return;
  }

  try {
    const token = localStorage.getItem('kontiq_token');
    const res = await fetch('/api/clients', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        name,
        email,
        address: document.getElementById('new-client-address').value,
        taxId: document.getElementById('new-client-taxid').value
      })
    });

    const data = await res.json();

    if (res.ok) {
      alert('Kunde erfolgreich erstellt!');
      closeNewClientModal();
      loadClients();

      // Select the new client
      document.getElementById('client-select').value = data.client.id;
    } else {
      alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
    }
  } catch (err) {
    console.error('Error creating client:', err);
    alert('Fehler beim Erstellen des Kunden');
  }
}

// Add event listeners to calculate totals
document.querySelectorAll('#items-tbody input').forEach(input => {
  input.addEventListener('input', calculateTotals);
});

// Load clients on page load
loadClients();
calculateTotals();
</script>
