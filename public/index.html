<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontiq - Finanz-Autopilot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Global Harmonized Styles -->
    <link rel="stylesheet" href="/css/global-harmonized.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Brand Colors - from Kontiq Logo */
            --navy: #0A2540;
            --teal: #0EB17A;
            
            /* Neutrals - 90% of design */
            --black: #1F2937;
            --gray: #6B7280;
            --light-gray: #F3F4F6;
            --border-gray: #E5E7EB;
            --white: #FFFFFF;
            
            /* Semantic (use sparingly) */
            --error: #DC2626;
            --warning: #F59E0B;
            --success: var(--teal);
        }

        /* Minimal Select Dropdown */
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background: var(--white) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%236B7280"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>') no-repeat right 12px center;
            background-size: 16px;
            padding: 10px 38px 10px 14px;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            color: var(--black);
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:hover {
            border-color: var(--gray);
        }

        select:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 0 3px rgba(14, 177, 122, 0.1);
        }

        select option {
            padding: 10px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--light-gray);
            color: var(--black);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* HEADER - Clean White */
        header {
            background: var(--white);
            border-bottom: 1px solid var(--border-gray);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(10, 37, 64, 0.08);
        }

        .header-top {
            max-width: 1400px;
            margin: 0 auto;
            padding: 18px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 26px;
            font-weight: 800;
            color: var(--navy);
            cursor: pointer;
            letter-spacing: -0.5px;
            transition: all 0.3s ease;
        }
        
        .logo:hover {
            transform: scale(1.02);
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--navy) 50%, var(--teal) 50%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            font-weight: 800;
            box-shadow: 0 4px 12px rgba(10, 37, 64, 0.15);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .entity-selector {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 22px;
            background: white;
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .entity-selector:hover {
            border-color: var(--teal);
            box-shadow: 0 6px 16px rgba(14, 177, 122, 0.12);
            transform: translateY(-2px);
        }

        .entity-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--light-teal) 0%, rgba(14, 177, 122, 0.15) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--teal);
            font-size: 20px;
        }

        .entity-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 100px;
            max-width: 200px;
        }

        .entity-label {
            font-size: 12px;
            color: #6B7280 !important;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .entity-name {
            font-size: 16px;
            font-weight: 700;
            color: #0A2540 !important;
            line-height: 1.2;
            letter-spacing: -0.2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .entity-chevron {
            color: var(--gray);
            font-size: 12px;
            transition: transform 0.2s;
        }

        .entity-selector:hover .entity-chevron {
            color: var(--teal);
        }

        .entity-selector.open .entity-chevron {
            transform: rotate(180deg);
        }

        .entity-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 16px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.15);
            min-width: 320px;
            z-index: 1300;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-12px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .entity-dropdown.active {
            display: block;
        }

        .entity-dropdown-header {
            padding: 20px 22px;
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
            font-size: 14px;
            font-weight: 800;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .entity-dropdown-item {
            padding: 16px 22px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid rgba(229, 231, 235, 0.4);
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .entity-dropdown-item:last-of-type {
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
        }

        .entity-dropdown-item:hover {
            background: linear-gradient(135deg, #F8FAFC 0%, #F0F9FF 100%);
            transform: translateX(4px);
        }

        .entity-dropdown-item.active {
            background: linear-gradient(135deg, var(--light-teal) 0%, rgba(14, 177, 122, 0.1) 100%);
            border-left: 4px solid var(--teal);
        }

        .entity-dropdown-item-icon {
            width: 36px;
            height: 36px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .entity-dropdown-item.active .entity-dropdown-item-icon {
            background: white;
            color: var(--teal);
            box-shadow: 0 4px 12px rgba(14, 177, 122, 0.2);
        }

        .entity-dropdown-item-content {
            flex: 1;
        }

        .entity-dropdown-item-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 3px;
            letter-spacing: -0.2px;
        }

        .entity-dropdown-item-info {
            font-size: 13px;
            color: var(--gray);
        }

        .entity-dropdown-footer {
            padding: 18px 22px;
        }

        .entity-dropdown-footer button {
            width: 100%;
            padding: 13px 18px;
            background: linear-gradient(135deg, var(--teal) 0%, #059669 100%);
            border: none;
            color: white;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(14, 177, 122, 0.25);
            letter-spacing: 0.2px;
        }

        .entity-dropdown-footer button:hover {
            box-shadow: 0 6px 18px rgba(14, 177, 122, 0.35);
            transform: translateY(-2px);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 14px;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: #FFFFFF;
        }
        
        .user-menu:hover {
            background: linear-gradient(135deg, #F8FAFC 0%, #F0F9FF 100%);
        }
        
        /* Ensure user name is always visible */
        .user-menu > div:not(.user-avatar) {
            color: #0A2540 !important;
            font-weight: 600;
        }

        /* Dropdown menu buttons with Kontiq teal hover effect */
        .dropdown-menu-btn {
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #0A2540;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        
        .dropdown-menu-btn:hover {
            background: #0EB17A;
            border-color: #0EB17A;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(14, 177, 122, 0.25);
        }
        
        .dropdown-menu-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(14, 177, 122, 0.2);
        }
        
        .dropdown-menu-btn.logout-btn {
            color: #DC2626;
            border-color: #FEE2E2;
            background: #FEF2F2;
        }
        
        .dropdown-menu-btn.logout-btn:hover {
            background: #DC2626;
            border-color: #DC2626;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(220, 38, 38, 0.25);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--navy), var(--teal));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 15px;
            box-shadow: 0 4px 12px rgba(10, 37, 64, 0.15);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-tabs {
            display: flex;
            gap: 6px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 14px 24px;
            color: #6B7280;
            font-size: 15px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: -0.1px;
            background: transparent;
        }

        .nav-tab:hover {
            color: #0A2540;
            background: rgba(14, 177, 122, 0.03);
        }

        .nav-tab.active {
            color: #0A2540 !important;
            font-weight: 600 !important;
            border-bottom: 3px solid #0EB17A !important;
            background: transparent !important;
        }
        
        /* Ensure non-active tabs have no border */
        .nav-tab:not(.active) {
            border-bottom-color: transparent !important;
        }

        /* CONTAINER */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        #viewContainer {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========================================
           STYLES MODERNES POUR TOUTES LES VUES
           ======================================== */

        /* Titres et en-têtes de pages */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--navy);
            letter-spacing: -0.5px;
            margin: 0;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--gray);
            line-height: 1.6;
            margin-top: 6px;
        }

        /* Minimal Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--teal);
            color: white;
            border: 1px solid var(--teal);
        }

        .btn-primary:hover {
            background: #0D9F6A;
            border-color: #0D9F6A;
        }

        .btn-secondary {
            background: white;
            color: var(--navy);
            border: 1px solid var(--navy);
        }

        .btn-secondary:hover {
            background: var(--navy);
            color: white;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 8px;
        }

        /* Minimal Cards */
        .card, .stat-card, .account-card, .contract-card {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(10, 37, 64, 0.08);
            transition: all 0.2s ease;
        }

        .card:hover, .stat-card:hover, .account-card:hover, .contract-card:hover {
            box-shadow: 0 4px 12px rgba(10, 37, 64, 0.12);
        }

        /* Minimal Tables */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-gray);
        }

        .data-table thead {
            background: #F0F4F8;
        }

        .data-table th {
            padding: 14px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-gray);
        }

        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-gray);
            font-size: 14px;
            color: var(--black);
        }

        .data-table tbody tr {
            transition: background 0.15s ease;
        }

        .data-table tbody tr:hover {
            background: #F9FAFB;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Minimal Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 6px;
        }

        .form-input, input[type="text"], input[type="email"], input[type="number"], 
        input[type="date"], input[type="password"], textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            background: white;
            color: var(--black);
        }

        .form-input:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 0 3px rgba(14, 177, 122, 0.1);
        }

        /* Minimal Badges */
        .badge, .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success, .status-active {
            background: rgba(14, 177, 122, 0.1);
            color: #047857;
        }

        .badge-warning, .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #D97706;
        }

        .badge-danger, .status-expired {
            background: rgba(220, 38, 38, 0.1);
            color: #DC2626;
        }

        .badge-info, .badge-default {
            background: var(--light-gray);
            color: var(--gray);
        }

        /* Stats & Metrics */
        .stat-value, .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--navy);
            font-family: 'Roboto Mono', monospace;
            letter-spacing: -0.5px;
            margin: 8px 0;
        }

        .stat-label, .metric-label {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        /* Grilles */
        .stats-grid, .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        /* Minimal Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(10, 37, 64, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 560px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(10, 37, 64, 0.3);
            animation: slideUp 0.25s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(16px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--navy);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            border: none;
            background: rgba(229, 231, 235, 0.5);
            cursor: pointer;
            font-size: 24px;
            color: var(--gray);
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(229, 231, 235, 1);
            color: var(--navy);
        }

        /* Actions de ligne */
        .action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(229, 231, 235, 0.8);
            background: white;
            color: var(--navy);
        }

        .action-btn:hover {
            background: var(--teal);
            color: white;
            border-color: var(--teal);
            transform: translateY(-1px);
        }

        /* Progress bars */
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(229, 231, 235, 0.5);
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--teal), #059669);
            border-radius: 999px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: var(--navy);
            color: white;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 12px;
        }

        .empty-state-text {
            font-size: 15px;
            color: var(--gray);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        /* Sections */
        .section {
            margin-bottom: 48px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(229, 231, 235, 0.8);
        }

        .section-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--navy);
            letter-spacing: -0.5px;
        }

        /* Animations supplémentaires */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
            border-radius: 8px;
        }
    </style>
    <script src="/js/onboarding-check.js"></script>
</head>
<body>
    <header>
        <div class="header-top">
            <div class="logo" onclick="navigateTo('dashboard')">
                <div class="logo-icon">K</div>
                <span>KONTIQ</span>
            </div>
            <div class="header-controls">
                <div class="entity-selector" onclick="toggleEntityDropdown(event)">
                    <div class="entity-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </div>
                    <div class="entity-info">
                        <div class="entity-label">Entität</div>
                        <div class="entity-name" id="currentEntityName">Kontiq GmbH</div>
                    </div>
                    <span class="entity-chevron">▼</span>
                    <div class="entity-dropdown" id="entityDropdown">
                        <div class="entity-dropdown-header">Entität wechseln</div>
                        <div id="entityDropdownList"></div>
                        <div class="entity-dropdown-footer">
                            <button onclick="event.stopPropagation(); openModule('entitaeten')">Entitäten verwalten</button>
                        </div>
                    </div>
                </div>
                <div class="user-menu" id="headerUserMenu" onclick="toggleProfileDropdown(event)">
                    <div class="user-avatar" id="headerAvatar">CM</div>
                    <div style="font-size: 14px; font-weight: 600; color: #0A2540 !important; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="headerUserName">Benutzer</div>
                    <span style="color: #6B7280;">▼</span>
                </div>
                <div id="profileDropdown" style="display:none; position:absolute; right:20px; top:72px; background:white; border:1px solid #E5E7EB; border-radius:12px; box-shadow:0 12px 32px rgba(0,0,0,0.12); width:300px; z-index:1300;">
                    <div style="padding:16px 18px; border-bottom:1px solid #E5E7EB; background: #F9FAFB; border-radius: 12px 12px 0 0;">
                        <div style="font-weight:700; color:#0A2540; font-size: 16px;" id="ddName">Benutzer</div>
                        <div style="font-size:13px; color:#6B7280; margin-top: 2px;" id="ddEmail"></div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px; padding:12px;">
                        <button class="dropdown-menu-btn" onclick="openModule('entitaeten')">Entitäten einfügen / bearbeiten</button>
                        <button class="dropdown-menu-btn" onclick="openModule('bankkonten')">Bankkonten</button>
                        <button class="dropdown-menu-btn" onclick="openModule('abonnement')">Abonnement</button>
                        <button class="dropdown-menu-btn" onclick="openModule('einstellungen')">Einstellungen</button>
                    </div>
                    <div style="padding:12px 16px; border-top:1px solid #E5E7EB; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-size:13px; color:#6B7280;">Paket</div>
                        <div style="font-weight:700; color:#0EB17A; font-size: 14px;" id="ddPlan">Free Trial</div>
                    </div>
                    <div style="padding:12px 16px; border-top:1px solid #E5E7EB; display:flex; gap:8px; justify-content:center;">
                        <button class="dropdown-menu-btn logout-btn" onclick="logout()">Abmelden</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-container">
            <nav class="nav-tabs">
                <div class="nav-tab active" data-view="dashboard" onclick="navigateTo('dashboard')">Dashboard</div>
                <div class="nav-tab" data-view="zahlungen" onclick="navigateTo('zahlungen')">Zahlungen</div>
                <div class="nav-tab" data-view="forderungen" onclick="navigateTo('forderungen')">Forderungen</div>
                <div class="nav-tab" data-view="kosten" onclick="navigateTo('kosten')">Kosten</div>
                <div class="nav-tab" data-view="liquiditat" onclick="navigateTo('liquiditat')">Liquidität</div>
                <div class="nav-tab" data-view="vertrage" onclick="navigateTo('vertrage')">Verträge</div>
                <div class="nav-tab" data-view="kpis" onclick="navigateTo('kpis')">KPIs</div>
                <div class="nav-tab" data-view="reports" onclick="navigateTo('reports')">Reports</div>
                <div class="nav-tab" data-view="bookings" onclick="navigateTo('bookings')">Buchungen</div>
            </nav>
        </div>
    </header>

    <div class="container">
        <div id="viewContainer"></div>
    </div>

    <script>
// Dev helper removed to avoid demo credentials being auto-injected
const urlParams = new URLSearchParams(window.location.search);

const user = localStorage.getItem('kontiq_user');
if (!user) {
    window.location.href = '/auth/login.html';
} else {
    try {
        const userData = JSON.parse(user);
        if (!userData.loggedIn) {
            window.location.href = '/auth/login.html';
        }
    } catch (e) {
        // If stored data is corrupted, force login
        window.location.href = '/auth/login.html';
    }
}
        // No cache - always fetch fresh content to avoid stale data
        
        async function navigateTo(viewName) {
            // First, clear the container immediately to avoid showing old content
            const container = document.getElementById('viewContainer');
            container.innerHTML = '<div style="text-align:center;padding:40px;color:#6B7280;">Laden...</div>';
            
            // Reset ALL tabs - remove active class AND reset inline styles
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.color = '';
                tab.style.borderBottomColor = '';
                tab.style.borderBottom = '';
                tab.style.fontWeight = '';
                tab.style.background = '';
            });
            
            // Set only the current tab as active
            const activeTab = document.querySelector(`[data-view="${viewName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Save current view to localStorage
            localStorage.setItem('kontiq_current_view', viewName);
            
            // Update URL hash without triggering reload
            window.history.replaceState(null, '', `#${viewName}`);
            
            try {
                // Always fetch fresh content
                const response = await fetch(`views/${viewName}.html?t=${Date.now()}`);
                if (!response.ok) throw new Error('Not found');
                const htmlContent = await response.text();
                
                // Clear and set new content
                container.innerHTML = htmlContent;
                
                // Execute scripts in loaded view
                const scripts = container.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    newScript.textContent = script.textContent;
                    document.body.appendChild(newScript);
                    document.body.removeChild(newScript);
                });
                
                // Ensure header data stays visible
                updateHeader();
                
            } catch (error) {
                container.innerHTML = `<p style="color: #DC2626; padding: 20px;">Fehler beim Laden. Bitte erneut versuchen.</p>`;
                console.error('Navigation error:', error);
            }
        }

        // On page load, restore last view or default to dashboard
        const savedView = localStorage.getItem('kontiq_current_view') || 'dashboard';
        const hashView = window.location.hash.substring(1);
        const initialView = hashView || savedView;
        navigateTo(initialView);
    </script>
    
    <!-- Einstellungen Modal -->
    <div id="settingsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1200; align-items:center; justify-content:center;">
        <div style="width:90%; max-width:900px; background:white; border-radius:12px; overflow:auto; max-height:90vh;">
            <div style="display:flex; justify-content:space-between; align-items:center; padding:18px 22px; border-bottom:1px solid var(--light-gray);">
                <div style="font-size:18px; font-weight:700; color:var(--navy);">Einstellungen</div>
                <div>
                    <button onclick="closeSettings()" style="background:none;border:none;font-size:22px;cursor:pointer;color:var(--gray);">×</button>
                </div>
            </div>
            <div style="padding:20px; display:grid; grid-template-columns:1fr 320px; gap:20px;">
                <div>
                    <h3 style="margin-bottom:8px;">Profil & Firmendaten</h3>
                    <div style="background:#F9FAFB;padding:12px;border-radius:8px;margin-bottom:12px;">
                        <label style="font-size:13px;font-weight:600;color:#374151;">Sprache</label>
                        <select id="settingLanguage">
                            <option value="de">Deutsch</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div style="background:#F9FAFB;padding:12px;border-radius:8px;margin-bottom:12px;">
                        <label style="font-size:13px;font-weight:600;color:#374151;">Währung</label>
                        <select id="settingCurrency">
                            <option>EUR</option>
                            <option>USD</option>
                            <option>GBP</option>
                        </select>
                    </div>

                    <h4 style="margin-top:12px;">Firmendaten bearbeiten</h4>
                    <div style="display:grid;gap:8px;margin-top:8px;">
                        <input id="settingCompanyName" placeholder="Firmenname" style="padding:10px;border:1px solid var(--light-gray);border-radius:6px;">
                        <input id="settingVatId" placeholder="USt-ID" style="padding:10px;border:1px solid var(--light-gray);border-radius:6px;">
                        <input id="settingHq" placeholder="PLZ + Stadt" style="padding:10px;border:1px solid var(--light-gray);border-radius:6px;">
                        <button class="btn btn-primary" style="width:160px;margin-top:6px;" onclick="saveProfile()">Speichern</button>
                    </div>

                    <hr style="margin:16px 0;border:none;border-top:1px solid var(--light-gray);">

                    <h4>Nutzer & Rechte</h4>
                    <div id="usersList" style="margin-top:8px;display:grid;gap:8px;"></div>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <input id="newUserEmail" placeholder="E-Mail" style="flex:1;padding:8px;border:1px solid var(--light-gray);border-radius:6px;">
                        <select id="newUserRole">
                            <option>Geschäftsführer</option>
                            <option>Inhaber</option>
                            <option>Finanzbuchhalter</option>
                            <option>Steuerberater</option>
                            <option>Mitarbeiter</option>
                        </select>
                        <button class="btn btn-secondary" onclick="addUser()">Hinzufügen</button>
                    </div>

                    <hr style="margin:16px 0;border:none;border-top:1px solid var(--light-gray);">

                    <h4>Entitäten</h4>
                    <div id="entitiesList" style="display:grid;gap:8px;margin-top:8px;"></div>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <input id="newEntityName" placeholder="Neue Entität (z.B. GmbH Filiale)" style="flex:1;padding:8px;border:1px solid var(--light-gray);border-radius:6px;">
                        <button class="btn btn-secondary" onclick="addEntity()">Hinzufügen</button>
                    </div>
                    <div style="font-size:12px;color:#6B7280;margin-top:8px;">Die erste Entität ist standardmäßig die primäre; später können Sie konsolidieren.</div>
                </div>

                <div>
                    <h3 style="margin-bottom:8px;">Paket & Abrechnung</h3>
                    <div style="background:#F9FAFB;padding:12px;border-radius:8px;margin-bottom:12px;">
                        <div style="font-weight:700;color:var(--navy);">Aktuelles Paket: <span id="currentPlan">Free Trial</span></div>
                        <div style="font-size:13px;color:#6B7280;margin-top:6px;">Tage verbleibend: <span id="trialDays">14</span></div>
                        <div style="margin-top:10px;">
                            <button class="btn btn-primary" onclick="upgradePlan()">Paket verbessern</button>
                        </div>
                    </div>

                    <h4>Abbuchungskonto für Paket</h4>
                    <div id="billingAccountSelect" style="margin-top:8px;"></div>

                    <hr style="margin:12px 0;border:none;border-top:1px solid var(--light-gray);">

                    <h3 style="margin-bottom:8px;">Bankkonten</h3>
                    <div id="banksList" style="display:grid;gap:8px;margin-top:8px;"></div>
                    <div style="display:grid;grid-template-columns:1fr 160px 120px;gap:8px;margin-top:8px;align-items:center;">
                        <input id="newBankName" placeholder="Bankname / IBAN / Konto" style="padding:8px;border:1px solid var(--light-gray);border-radius:6px;">
                        <select id="newBankEntity">
                            <option value="">Keine Entität</option>
                        </select>
                        <button class="btn btn-secondary" onclick="addBank()">Hinzufügen</button>
                    </div>
                </div>
            </div>
            <div style="padding:12px 22px; border-top:1px solid var(--light-gray); display:flex; justify-content:flex-end; gap:8px;">
                <button class="btn btn-secondary" onclick="closeSettings()">Schliessen</button>
            </div>
        </div>
    </div>

    <script>
        // Settings data keys: kontiq_settings, kontiq_users, kontiq_banks, kontiq_entities, kontiq_plan
        function openSettings(section) {
            loadSettings();
            document.getElementById('settingsModal').style.display = 'flex';
            // small delay to allow modal layout
            setTimeout(() => {
                if (!section) return;
                const map = {
                    profile: 'settingCompanyName',
                    banks: 'banksList',
                    users: 'usersList',
                    plan: 'currentPlan',
                    language: 'settingLanguage',
                    currency: 'settingCurrency',
                    entities: 'entitiesList'
                };
                const targetId = map[section];
                const el = document.getElementById(targetId);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // add a brief highlight
                    const old = el.style.boxShadow;
                    el.style.boxShadow = '0 0 0 4px rgba(16,185,129,0.12)';
                    setTimeout(()=> el.style.boxShadow = old, 1200);
                }
            }, 120);
        }

        // Dropdown handling
        function toggleProfileDropdown(e) {
            e.stopPropagation();
            const dd = document.getElementById('profileDropdown');
            dd.style.display = dd.style.display === 'flex' || dd.style.display === 'block' ? 'none' : 'block';
            // update contents
            const user = JSON.parse(localStorage.getItem('kontiq_user') || '{}');
            document.getElementById('ddName').textContent = user.name || 'Benutzer';
            document.getElementById('ddEmail').textContent = user.email || '';
            const plan = JSON.parse(localStorage.getItem('kontiq_plan') || '{}');
            document.getElementById('ddPlan').textContent = plan.name || 'Free Trial';
        }

        document.addEventListener('click', function(e){
            const dd = document.getElementById('profileDropdown');
            if (!dd) return;
            const menu = document.getElementById('headerUserMenu');
            if (dd.style.display !== 'none' && !dd.contains(e.target) && !menu.contains(e.target)) {
                dd.style.display = 'none';
            }
        });

        function showComingSoon() {
            // small toast near dropdown
            const existing = document.getElementById('comingSoonToast');
            if (existing) { existing.remove(); }
            const toast = document.createElement('div');
            toast.id = 'comingSoonToast';
            toast.textContent = 'Kommt bald';
            toast.style.position = 'fixed';
            toast.style.top = '90px';
            toast.style.right = '24px';
            toast.style.background = 'rgba(10,37,64,0.95)';
            toast.style.color = 'white';
            toast.style.padding = '10px 14px';
            toast.style.borderRadius = '8px';
            toast.style.boxShadow = '0 6px 18px rgba(2,6,23,0.2)';
            toast.style.zIndex = 1400;
            toast.style.fontWeight = '600';
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.transition = 'opacity 0.4s'; toast.style.opacity = '0'; }, 800);
            setTimeout(() => { toast.remove(); }, 1200);
            // close dropdown as well
            const dd = document.getElementById('profileDropdown'); if (dd) dd.style.display = 'none';
        }

        function openModule(name) {
            const dd = document.getElementById('profileDropdown'); if (dd) dd.style.display = 'none';
            const ed = document.getElementById('entityDropdown'); if (ed) ed.classList.remove('active');
            // Use SPA navigation function
            navigateTo(name);
        }

        // Entity Management Functions
        function toggleEntityDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('entityDropdown');
            dropdown.classList.toggle('active');
            
            if (dropdown.classList.contains('active')) {
                renderEntityDropdown();
            }
        }

        function renderEntityDropdown() {
            const entities = JSON.parse(localStorage.getItem('kontiq_entities') || '[]');
            const activeEntityId = localStorage.getItem('kontiq_active_entity') || null;
            const listContainer = document.getElementById('entityDropdownList');
            
            if (entities.length === 0) {
                listContainer.innerHTML = '<div style="padding: 12px 16px; color: var(--gray); font-size: 13px;">Keine Entitäten vorhanden</div>';
                return;
            }

            listContainer.innerHTML = entities.map(entity => {
                const isActive = entity.id === activeEntityId;
                return `
                    <div class="entity-dropdown-item ${isActive ? 'active' : ''}" onclick="switchEntity('${entity.id}')">
                        <div class="entity-dropdown-item-name">${entity.name}</div>
                        <div class="entity-dropdown-item-info">${entity.type} • ${entity.currency}</div>
                    </div>
                `;
            }).join('');
        }

        function switchEntity(entityId) {
            localStorage.setItem('kontiq_active_entity', entityId);
            const entities = JSON.parse(localStorage.getItem('kontiq_entities') || '[]');
            const entity = entities.find(e => e.id === entityId);
            
            if (entity) {
                document.getElementById('currentEntityName').textContent = entity.name;
            } else {
                const user = JSON.parse(localStorage.getItem('kontiq_user') || '{}');
                document.getElementById('currentEntityName').textContent = user.company || 'Entität auswählen';
            }
            
            // Close dropdown
            document.getElementById('entityDropdown').classList.remove('active');
            
            // Refresh current view if on a data-dependent module
            const currentModule = window.location.hash.substring(1) || 'dashboard';
            if (['dashboard', 'bankkonten', 'liquiditat', 'kosten', 'kpis', 'reports'].includes(currentModule)) {
                // Reload iframe content
                const iframe = document.getElementById('moduleFrame');
                if (iframe) {
                    iframe.contentWindow.postMessage({ type: 'entityChanged', entityId: entityId }, '*');
                }
            }
        }

        function initializeEntitySelector() {
            const entities = JSON.parse(localStorage.getItem('kontiq_entities') || '[]');
            let activeEntityId = localStorage.getItem('kontiq_active_entity');
            let entity = entities.find(e => e.id === activeEntityId);

            if (!entity && entities.length > 0) {
                entity = entities[0];
                activeEntityId = entity.id;
                localStorage.setItem('kontiq_active_entity', activeEntityId);
            }

            if (entity) {
                document.getElementById('currentEntityName').textContent = entity.name;
            } else {
                const user = JSON.parse(localStorage.getItem('kontiq_user') || '{}');
                document.getElementById('currentEntityName').textContent = user.company || 'Entität auswählen';
            }
        }

        // Close entity dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const entitySelector = document.querySelector('.entity-selector');
            const entityDropdown = document.getElementById('entityDropdown');
            
            if (entityDropdown && !entitySelector.contains(event.target)) {
                entityDropdown.classList.remove('active');
            }
        });

        function logout() {
            // clear user session and redirect to login
            localStorage.removeItem('kontiq_user');
            // optional: clear onboarding flag so login shows onboarding again if desired
            // localStorage.removeItem('kontiq_onboarding_complete');
            const dd = document.getElementById('profileDropdown'); if (dd) dd.style.display = 'none';
            window.location.href = '/auth/login.html';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('kontiq_settings') || '{}');
            document.getElementById('settingLanguage').value = settings.language || 'de';
            document.getElementById('settingCurrency').value = settings.currency || 'EUR';
            document.getElementById('settingCompanyName').value = settings.companyName || (JSON.parse(localStorage.getItem('kontiq_company') || '{}').company || '');
            document.getElementById('settingVatId').value = settings.vatId || '';
            document.getElementById('settingHq').value = settings.hq || '';

            // Users
            const users = JSON.parse(localStorage.getItem('kontiq_users') || '[]');
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            users.forEach((u, idx) => {
                const el = document.createElement('div');
                el.style.display = 'flex'; el.style.justifyContent = 'space-between'; el.style.alignItems = 'center';
                el.innerHTML = `<div style="font-size:14px;">${u.email} — <span style=\"font-weight:600\">${u.role}</span></div><div><button class=\"btn btn-secondary\" onclick=\"removeUser(${idx})\">Entfernen</button></div>`;
                usersList.appendChild(el);
            });

            // Entities
            const entities = JSON.parse(localStorage.getItem('kontiq_entities') || '[]');
            const entitiesList = document.getElementById('entitiesList'); entitiesList.innerHTML = '';
            entities.forEach((en, i) => {
                const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center';
                d.innerHTML = `<div>${en.name} ${en.primary?'<span style=\"color:var(--teal);font-weight:600;margin-left:8px;\">(Primär)</span>':''}</div><div><button class=\"btn btn-secondary\" onclick=\"togglePrimary(${i})\">Primär</button> <button class=\"btn btn-secondary\" onclick=\"removeEntity(${i})\">Entfernen</button></div>`;
                entitiesList.appendChild(d);
            });

            // Banks (stored as [{name, entity}] or legacy strings)
            const banksRaw = JSON.parse(localStorage.getItem('kontiq_banks') || '[]');
            const banks = banksRaw.map(b => typeof b === 'string' ? { name: b, entity: '' } : b);
            const banksList = document.getElementById('banksList'); banksList.innerHTML = '';
            banks.forEach((b, i) => {
                const be = document.createElement('div'); be.style.display='flex'; be.style.justifyContent = 'space-between'; be.style.alignItems = 'center';
                const entityText = b.entity ? b.entity : 'Keine Entität';
                be.innerHTML = `<div><div style=\"font-weight:600\">${escapeHtml(b.name)}<\/div><div style=\"color:#9CA3AF;font-size:13px\">${escapeHtml(entityText)}<\/div><\/div><div><button class=\"btn btn-secondary\" onclick=\"removeBank(${i})\">Löschen</button></div>`;
                banksList.appendChild(be);
            });

            // populate new bank entity select
            const newBankEntity = document.getElementById('newBankEntity');
            if (newBankEntity) {
                newBankEntity.innerHTML = '<option value="">Keine Entität</option>';
                entities.forEach(en => {
                    const opt = document.createElement('option'); opt.value = en.name; opt.textContent = en.name + (en.primary ? ' (Primär)' : ''); newBankEntity.appendChild(opt);
                });
            }

            // Billing account select
            const billingDiv = document.getElementById('billingAccountSelect'); billingDiv.innerHTML='';
            const billing = localStorage.getItem('kontiq_billing') || '';
            const sel = document.createElement('select'); sel.style.width='100%'; sel.style.padding='8px'; sel.style.border='1px solid var(--light-gray)'; sel.style.borderRadius='6px'; sel.id='billingSelect';
            const noneOpt = document.createElement('option'); noneOpt.value=''; noneOpt.textContent='Kein Konto gewählt'; sel.appendChild(noneOpt);
            banks.forEach((b, i) => { const o = document.createElement('option'); o.value = String(i); o.textContent = (b.name || '') + (b.entity ? ' (' + b.entity + ')' : ''); if (String(i) === billing || (b.name === billing)) o.selected = true; sel.appendChild(o); });
            billingDiv.appendChild(sel);
            const saveBillingBtn = document.createElement('button'); saveBillingBtn.className='btn btn-primary'; saveBillingBtn.style.marginTop='8px'; saveBillingBtn.textContent='Speichern'; saveBillingBtn.onclick = ()=>{ localStorage.setItem('kontiq_billing', document.getElementById('billingSelect').value); alert('Abbuchungskonto gespeichert'); };
            billingDiv.appendChild(saveBillingBtn);

            // Plan
            const plan = JSON.parse(localStorage.getItem('kontiq_plan') || '{}');
            const planName = plan.name || 'Free Trial'; document.getElementById('currentPlan').textContent = planName;
            const started = plan.started ? new Date(plan.started) : new Date();
            const diffDays = Math.max(0, 14 - Math.floor((Date.now() - started.getTime()) / (1000*60*60*24)));
            document.getElementById('trialDays').textContent = diffDays;
        }

        // small helper to escape HTML when injecting user-provided text
        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"'`]/g, function(s) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','`':'&#96;'}[s];
            });
        }

        function saveProfile() {
            const settings = JSON.parse(localStorage.getItem('kontiq_settings') || '{}');
            settings.language = document.getElementById('settingLanguage').value;
            settings.currency = document.getElementById('settingCurrency').value;
            settings.companyName = document.getElementById('settingCompanyName').value;
            settings.vatId = document.getElementById('settingVatId').value;
            settings.hq = document.getElementById('settingHq').value;
            localStorage.setItem('kontiq_settings', JSON.stringify(settings));
            // also update company quick data
            const company = JSON.parse(localStorage.getItem('kontiq_company') || '{}');
            company.company = settings.companyName || company.company;
            company.vatId = settings.vatId || company.vatId;
            company.hq = settings.hq || company.hq;
            localStorage.setItem('kontiq_company', JSON.stringify(company));
            updateHeader();
            alert('Profil gespeichert');
        }

        function addUser() {
            const email = document.getElementById('newUserEmail').value.trim();
            const role = document.getElementById('newUserRole').value;
            if (!email) return alert('Bitte Email angeben');
            const users = JSON.parse(localStorage.getItem('kontiq_users') || '[]');
            users.push({ email, role });
            localStorage.setItem('kontiq_users', JSON.stringify(users));
            document.getElementById('newUserEmail').value='';
            loadSettings();
        }

        function removeUser(i) { const users = JSON.parse(localStorage.getItem('kontiq_users') || '[]'); users.splice(i,1); localStorage.setItem('kontiq_users', JSON.stringify(users)); loadSettings(); }

        function addEntity() { const name = document.getElementById('newEntityName').value.trim(); if(!name) return alert('Name angeben'); const entities = JSON.parse(localStorage.getItem('kontiq_entities') || '[]'); const primary = entities.length===0; entities.push({name, primary}); localStorage.setItem('kontiq_entities', JSON.stringify(entities)); document.getElementById('newEntityName').value=''; loadSettings(); }
        function removeEntity(i) { const entities = JSON.parse(localStorage.getItem('kontiq_entities') || '[]'); entities.splice(i,1); localStorage.setItem('kontiq_entities', JSON.stringify(entities)); loadSettings(); }
        function togglePrimary(i) { const entities = JSON.parse(localStorage.getItem('kontiq_entities') || '[]'); entities.forEach((e,idx)=> e.primary = idx===i); localStorage.setItem('kontiq_entities', JSON.stringify(entities)); loadSettings(); }

        function addBank() {
            const name = document.getElementById('newBankName').value.trim();
            const entity = document.getElementById('newBankEntity')?.value || '';
            if (!name) return alert('Name angeben');
            const banksRaw = JSON.parse(localStorage.getItem('kontiq_banks') || '[]');
            const banks = banksRaw.map(b => typeof b === 'string' ? { name: b, entity: '' } : b);
            banks.push({ name, entity });
            localStorage.setItem('kontiq_banks', JSON.stringify(banks));
            document.getElementById('newBankName').value = '';
            if (document.getElementById('newBankEntity')) document.getElementById('newBankEntity').value = '';
            loadSettings();
        }

        function removeBank(i) {
            const banksRaw = JSON.parse(localStorage.getItem('kontiq_banks') || '[]');
            const banks = banksRaw.map(b => typeof b === 'string' ? { name: b, entity: '' } : b);
            banks.splice(i, 1);
            localStorage.setItem('kontiq_banks', JSON.stringify(banks));
            loadSettings();
        }

        function upgradePlan() { const plan = { name: 'Business', started: new Date().toISOString() }; localStorage.setItem('kontiq_plan', JSON.stringify(plan)); loadSettings(); alert('Paket aktualisiert'); }

        function updateHeader() {
            const user = JSON.parse(localStorage.getItem('kontiq_user') || '{}');
            const headerUserName = document.getElementById('headerUserName');
            const headerAvatar = document.getElementById('headerAvatar');
            
            if (headerUserName) {
                headerUserName.textContent = user.name || 'Benutzer';
                // Force navy color to ensure visibility
                headerUserName.style.color = '#0A2540';
                headerUserName.style.fontWeight = '600';
            }
            if (headerAvatar) {
                headerAvatar.textContent = (user.name || 'B').split(' ').map(s=>s[0]).slice(0,2).join('') || 'B';
            }
            
            // Also update entity name if needed
            const entityName = document.getElementById('currentEntityName');
            if (entityName) {
                entityName.style.color = '#0A2540';
            }
        }

        // initial header update
        document.addEventListener('DOMContentLoaded', function(){ 
            updateHeader(); 
            initializeEntitySelector();
            
            // Periodic check to ensure header stays visible
            setInterval(updateHeader, 5000);
        });
    </script>

    <!-- AI Chat Widget -->
    <div id="aiChatWidget" class="ai-chat-widget">
        <button class="ai-chat-toggle" onclick="toggleAIChat()">
            <svg class="ai-toggle-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                <circle cx="9" cy="10" r="1" fill="currentColor"></circle>
                <circle cx="12" cy="10" r="1" fill="currentColor"></circle>
                <circle cx="15" cy="10" r="1" fill="currentColor"></circle>
            </svg>
            <span class="ai-badge" id="aiNotificationBadge" style="display: none;">1</span>
        </button>
        
        <div class="ai-chat-window" id="aiChatWindow">
            <div class="ai-chat-header">
                <div class="ai-chat-header-content">
                    <div class="ai-avatar-modern">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                    </div>
                    <div>
                        <div class="ai-chat-title">Kontiq Assistant</div>
                        <div class="ai-chat-status">
                            <span class="status-dot"></span>
                            Online • Bereit zu helfen
                        </div>
                    </div>
                </div>
                <button class="ai-chat-close" onclick="toggleAIChat()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="ai-chat-messages" id="aiChatMessages">
                <div class="ai-message ai-message-bot">
                    <div class="ai-message-avatar-modern">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                    </div>
                    <div class="ai-message-content">
                        <div class="ai-message-text" id="initialMessage">
                            <strong>Willkommen! Ich bin Ihr persönlicher Finanzassistent.</strong>
                            <p style="margin: 12px 0 8px 0;">Ich kann Ihnen helfen bei:</p>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li>Datenanalyse und Prognosen</li>
                                <li>Onboarding und Einrichtung</li>
                                <li>Optimierungsvorschläge</li>
                                <li>Beantwortung Ihrer Fragen</li>
                            </ul>
                            <p style="margin-top: 12px;">Wie kann ich Ihnen heute helfen?</p>
                        </div>
                        <div class="ai-message-time">Jetzt</div>
                    </div>
                </div>
            </div>
            
            <div class="ai-chat-quick-actions" id="aiQuickActions">
                <button class="ai-quick-btn" onclick="askAI('Analysiere meine Kostenentwicklung')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"></path>
                        <path d="M18 17l-5-5-3 3-4-4"></path>
                    </svg>
                    Kostenanalyse
                </button>
                <button class="ai-quick-btn" onclick="askAI('Wo kann ich sparen?')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    Sparpotenzial
                </button>
                <button class="ai-quick-btn" onclick="askAI('Hilf mir beim Onboarding')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M2 12h20"></path>
                        <circle cx="12" cy="12" r="10"></circle>
                    </svg>
                    Onboarding-Hilfe
                </button>
            </div>
            
            <div class="ai-chat-input-container">
                <input 
                    type="text" 
                    class="ai-chat-input" 
                    id="aiChatInput" 
                    placeholder="Schreiben Sie Ihre Frage..."
                    onkeypress="if(event.key==='Enter') sendAIMessage()"
                >
                <button class="ai-chat-send" onclick="sendAIMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <style>
        /* AI Chat Widget Styles */
        .ai-chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
        }

        .ai-chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--navy) 0%, #0D3A5F 100%);
            border: none;
            box-shadow: 0 4px 20px rgba(10, 37, 64, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            color: white;
        }

        .ai-chat-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(10, 37, 64, 0.4);
            background: linear-gradient(135deg, #0D3A5F 0%, var(--navy) 100%);
        }

        .ai-toggle-icon {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }

        .ai-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            border: 2px solid white;
        }

        .ai-chat-window {
            display: none;
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 400px;
            max-width: calc(100vw - 48px);
            height: 600px;
            max-height: calc(100vh - 140px);
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            flex-direction: column;
            overflow: hidden;
        }

        .ai-chat-window.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-chat-header {
            background: linear-gradient(135deg, var(--navy) 0%, #0D3A5F 100%);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

.ai-chat-header-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.ai-avatar-modern {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--teal) 0%, #059669 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ai-chat-title {
            font-size: 16px;
            font-weight: 700;
        }

        .ai-chat-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .ai-chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .ai-chat-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ai-message {
            display: flex;
            gap: 12px;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-message-avatar-modern {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--teal) 0%, #059669 100%);
            color: white;
        }

        .ai-message-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--navy) 0%, #0D3A5F 100%);
            color: white;
            font-weight: 600;
            font-size: 13px;
        }

        .ai-message-content {
            max-width: 70%;
        }

        .ai-message-user .ai-message-content {
            align-items: flex-end;
        }

        .ai-message-text {
            background: var(--light-bg);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .ai-message-user .ai-message-text {
            background: var(--teal);
            color: white;
        }

        .ai-message-time {
            font-size: 11px;
            color: var(--gray);
            margin-top: 4px;
            padding: 0 4px;
        }

        .ai-typing {
            background: var(--light-bg);
            padding: 12px 16px;
            border-radius: 12px;
            display: inline-flex;
            gap: 4px;
        }

        .ai-typing span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray);
            animation: typing 1.4s infinite;
        }

        .ai-typing span:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        .ai-chat-quick-actions {
            padding: 12px 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .ai-quick-btn {
            padding: 8px 14px;
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .ai-quick-btn:hover {
            background: var(--navy);
            color: white;
            border-color: var(--navy);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(10, 37, 64, 0.15);
        }

        .ai-quick-btn svg {
            flex-shrink: 0;
        }

        .ai-chat-input-container {
            padding: 16px 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            gap: 12px;
        }

        .ai-chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--light-gray);
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .ai-chat-input:focus {
            border-color: var(--teal);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .ai-chat-send {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--navy) 0%, #0D3A5F 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ai-chat-send:hover {
            background: linear-gradient(135deg, #0D3A5F 0%, var(--navy) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(10, 37, 64, 0.3);
        }

        .ai-chat-send:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .ai-chat-window {
                width: calc(100vw - 32px);
                height: calc(100vh - 120px);
                right: 16px;
                bottom: 90px;
            }

            .ai-chat-toggle {
                width: 56px;
                height: 56px;
                bottom: 20px;
                right: 20px;
            }
        }
    </style>    <script>
        let aiChatOpen = false;
        let aiMessages = [];

        function toggleAIChat() {
            aiChatOpen = !aiChatOpen;
            const window = document.getElementById('aiChatWindow');
            const badge = document.getElementById('aiNotificationBadge');
            
            if (aiChatOpen) {
                window.classList.add('active');
                badge.style.display = 'none';
            } else {
                window.classList.remove('active');
            }
        }

        function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const messagesContainer = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message ai-message-bot';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="ai-message-avatar-modern">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 12l10 5 10-5"></path>
                    </svg>
                </div>
                <div class="ai-message-content">
                    <div class="ai-typing">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Generate response after delay
            setTimeout(() => {
                const typing = document.getElementById('typingIndicator');
                if (typing) typing.remove();
                
                const response = generateAIResponse(message);
                addMessage(response, 'bot');
            }, 1000 + Math.random() * 1000);
        }

        function askAI(question) {
            document.getElementById('aiChatInput').value = question;
            sendAIMessage();
        }

        function addMessage(text, type) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ai-message-${type}`;
            
            if (type === 'user') {
                const avatar = (JSON.parse(localStorage.getItem('kontiq_user') || '{}').name || 'B').split(' ').map(s=>s[0]).slice(0,1).join('');
                messageDiv.innerHTML = `
                    <div class="ai-message-user-avatar">${avatar}</div>
                    <div class="ai-message-content">
                        <div class="ai-message-text">${text}</div>
                        <div class="ai-message-time">${time}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="ai-message-avatar-modern">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                    </div>
                    <div class="ai-message-content">
                        <div class="ai-message-text">${text}</div>
                        <div class="ai-message-time">${time}</div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            aiMessages.push({ text, type, time });
        }

        function generateAIResponse(question) {
            const lowerQ = question.toLowerCase();
            
            if (lowerQ.includes('onboarding') || lowerQ.includes('einrichtung') || lowerQ.includes('setup') || lowerQ.includes('anfang')) {
                return `<strong>Onboarding-Unterstützung</strong><br><br>
                Ich helfe Ihnen gerne bei der Einrichtung! Hier sind die wichtigsten Schritte:<br><br>
                <strong>1. Unternehmensinformationen</strong><br>
                • Firmenname und Rechtsform eingeben<br>
                • Branche und Mitarbeiteranzahl angeben<br>
                • Jahresumsatz erfassen<br><br>
                <strong>2. Finanzielle Daten</strong><br>
                • Lieferantenrechnungen pro Monat<br>
                • Durchschnittliches Zahlungsziel<br>
                • Buchhaltungssoftware verbinden (optional)<br><br>
                <strong>3. Kontaktdaten</strong><br>
                • Ansprechpartner festlegen<br>
                • Position und Kontaktdaten<br><br>
                <strong>4. Bankkonten & Entitäten</strong><br>
                • Bankkonten hinzufügen<br>
                • Entitäten erstellen und verknüpfen<br><br>
                Wo benötigen Sie konkret Hilfe?`;
            }
            
            // Kosten-Analyse
            if (lowerQ.includes('kosten') && (lowerQ.includes('analyse') || lowerQ.includes('entwicklung'))) {
                return `<strong>Kostenanalyse</strong><br><br>
                Ihre Gesamtkosten betragen aktuell <strong>79.300 €</strong> (November).<br><br>
                <strong>Aufschlüsselung:</strong><br>
                • Personal: 48.900 € (61,6%)<br>
                • Waren: 17.200 € (21,7%)<br>
                • Miete: 10.500 € (13,2%)<br>
                • IT/Software: 8.400 € (10,6%)<br><br>
                <strong>Trend:</strong><br>
                +11% vs. Oktober (71.400 €)<br><br>
                <strong>Ursache:</strong><br>
                Der Anstieg ist hauptsächlich auf erhöhte Warenkosten zurückzuführen. Variable Kosten sind um 22% gestiegen.`;
            }
            
            // Sparpotenzial
            if (lowerQ.includes('spar') || lowerQ.includes('optimier') || lowerQ.includes('reduzier')) {
                return `<strong>Sparpotenzial identifiziert</strong><br><br>
                <strong>1. IT/Software (~8.400 €/Monat)</strong><br>
                • Lizenzkonsolidierung möglich<br>
                • Alternative Anbieter prüfen<br>
                • Cloud-Kosten optimieren<br><br>
                <strong>2. Personalkosten (12% über Branchenschnitt)</strong><br>
                • Gehaltsstruktur überprüfen<br>
                • Auslastung optimieren<br>
                • Teilzeit-/Freelancer-Modelle prüfen<br><br>
                <strong>3. Variable Kosten</strong><br>
                • Bessere Konditionen verhandeln<br>
                • Mengenrabatte nutzen<br>
                • Lieferanten vergleichen<br><br>
                <strong>Gesamtes Einsparpotenzial: ~12.000 € / Monat</strong>`;
            }
            
            // Liquidität / Prognose
            if (lowerQ.includes('liquidität') || lowerQ.includes('prognose') || lowerQ.includes('zukunft')) {
                return `<strong>Liquiditätsprognose (nächste 3 Monate)</strong><br><br>
                <strong>Aktuelle Liquidität:</strong> 40.000 €<br><br>
                <strong>Kritische Zeiträume:</strong><br>
                • 15.-20. Dezember: Mehrere Großzahlungen<br>
                  → Liquidität könnte auf 32.000 € sinken<br><br>
                <strong>Empfehlungen:</strong><br>
                ✓ Zahlungsziele mit Lieferanten verlängern<br>
                ✓ Forderungen früher einziehen<br>
                ✓ Kreditlinie als Puffer einrichten<br>
                ✓ Nicht dringende Ausgaben verschieben<br><br>
                Mit aktueller Planung bleibt Liquidität über Minimum (30.000 €).`;
            }
            
            // Benchmark
            if (lowerQ.includes('benchmark') || lowerQ.includes('vergleich') || lowerQ.includes('branche')) {
                return `<strong>Benchmark-Vergleich</strong><br><br>
                Im Vergleich zu ähnlichen Unternehmen Ihrer Branche:<br><br>
                <strong>Kostenstruktur:</strong><br>
                • Personalkosten: +12% über Durchschnitt<br>
                • IT-Ausgaben: +8% über Durchschnitt<br>
                • Liquiditätsquote: Im Durchschnitt<br>
                • Kosten/Umsatz-Ra                .ai-message-content {
                    max-width: 85%;
                    flex: 1;
                }
                
                .ai-message-text {
                    background: var(--light-bg);
                    padding: 14px 18px;
                    border-radius: 12px;
                    font-size: 15px;
                    line-height: 1.6;
                }tio: +5%<br><br>
                <strong>Fazit:</strong><br>
                Sie liegen insgesamt leicht über dem Branchenschnitt. Fokus auf Personal- und IT-Optimierung empfohlen.`;
            }
            
            // Fallback - Allgemeine Hilfe
            return `Ich habe Ihre Frage analysiert. Hier sind einige Insights basierend auf Ihren aktuellen Daten:<br><br>
            <strong>Aktuelle Situation:</strong><br>
            • Gesamtkosten: 79.300 € (November)<br>
            • Trend: +11% zum Vormonat<br>
            • Größter Kostenblock: Personal (61,6%)<br><br>
            <strong>Ich kann Ihnen helfen mit:</strong><br>
            • Kostenanalyse und Trends<br>
            • Sparpotenziale identifizieren<br>
            • Liquiditätsprognosen<br>
            • Onboarding-Unterstützung<br>
            • Benchmark-Vergleichen<br><br>
            Fragen Sie mich gerne etwas Konkretes!`;
        }
    </script>
    <!-- API Client and App Core -->
    <script src="/js/api-client.js"></script>
    <script src="/js/app.js"></script>
    <!-- Data Preloader for instant data display -->
    <script src="/js/data-preloader.js"></script>
    <!-- Performance Optimizer -->
    <script src="/js/performance-optimizer.js"></script>
    <!-- Modal Manager for Unified Modal Handling -->
    <script src="/js/modal-manager.js"></script>
    <!-- Close Button Fixer -->
    <script src="/js/close-button-fixer.js"></script>
    <!-- Form Harmonizer -->
    <script src="/js/form-harmonizer.js"></script>
    <!-- Clickability Fixer -->
    <script src="/js/clickability-fixer.js"></script>
</body>
</html>